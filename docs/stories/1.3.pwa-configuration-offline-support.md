# Story 1.3: PWA Configuration and Offline Support

## Status
Draft

## Story
**As a** user,
**I want** the application to work offline and be installable as a PWA,
**so that** I can use the application without internet connection and have a native app-like experience.

## Acceptance Criteria

1. Service Worker registered and configured for offline functionality
2. Web App Manifest created with appropriate metadata (name, icons, theme colors)
3. Application assets cached for offline access (HTML, CSS, JavaScript)
4. Application loads and functions when offline (after initial online load)
5. Application is installable on desktop browsers (install prompt appears)
6. Installed PWA launches in standalone window mode
7. Service Worker handles cache updates when new version is deployed
8. Offline indicator displays when internet connection is lost
9. Application gracefully handles offline state with appropriate user messaging

## Tasks / Subtasks

- [ ] Task 1: Install and configure Workbox (AC: 1, 3, 7)
  - [ ] Install Workbox ^7.0.0 as specified in tech stack
  - [ ] Install Workbox Vite plugin: `vite-plugin-pwa`
  - [ ] Configure Workbox in `vite.config.ts`
  - [ ] Set up Workbox to generate Service Worker file (`public/sw.js`)
  - [ ] Configure cache strategies for different asset types

- [ ] Task 2: Configure Service Worker with Workbox (AC: 1, 3, 7)
  - [ ] Set up cache-first strategy for static assets (HTML, CSS, JS)
  - [ ] Configure cache name and version for cache invalidation
  - [ ] Set up precaching for application shell
  - [ ] Configure runtime caching for dynamic assets
  - [ ] Set up cache update strategy (stale-while-revalidate or network-first)
  - [ ] Ensure Service Worker handles cache updates on new deployments

- [ ] Task 3: Register Service Worker in application (AC: 1)
  - [ ] Create Service Worker registration utility: `src/utils/serviceWorker.ts`
  - [ ] Register Service Worker in `src/main.tsx` or `src/App.tsx`
  - [ ] Handle Service Worker registration errors gracefully
  - [ ] Show user-friendly error messages if Service Worker fails to register
  - [ ] Verify Service Worker registers successfully in browser DevTools

- [ ] Task 4: Create Web App Manifest (AC: 2, 5, 6)
  - [ ] Create `public/manifest.json` file
  - [ ] Configure manifest with required fields:
    - [ ] `name`: Application name
    - [ ] `short_name`: Short name for home screen
    - [ ] `description`: Application description
    - [ ] `start_url`: Start URL (typically "/")
    - [ ] `display`: "standalone" for native app-like experience
    - [ ] `theme_color`: Theme color for browser UI
    - [ ] `background_color`: Background color for splash screen
    - [ ] `icons`: Array of icon sizes (192x192, 512x512 minimum)
  - [ ] Link manifest in `index.html`: `<link rel="manifest" href="/manifest.json">`

- [ ] Task 5: Create PWA icons (AC: 2, 5)
  - [ ] Create icon assets in `public/icons/` directory
  - [ ] Generate icons in multiple sizes:
    - [ ] 192x192 (required)
    - [ ] 512x512 (required)
    - [ ] Additional sizes for better support (144x144, 384x384)
  - [ ] Ensure icons are properly formatted (PNG format)
  - [ ] Ensure icons are accessible and meet design requirements
  - [ ] Reference icons in `manifest.json`

- [ ] Task 6: Configure theme colors (AC: 2)
  - [ ] Define theme color in `manifest.json` (matches Tailwind theme)
  - [ ] Define background color in `manifest.json`
  - [ ] Add theme-color meta tag in `index.html`: `<meta name="theme-color" content="#...">`
  - [ ] Ensure colors match application design system

- [ ] Task 7: Implement offline detection (AC: 8, 9)
  - [ ] Create offline detection hook: `src/hooks/useOnlineStatus.ts`
  - [ ] Use `navigator.onLine` API and `online`/`offline` events
  - [ ] Create OfflineIndicator component: `src/components/common/OfflineIndicator.tsx`
  - [ ] Display offline indicator when connection is lost
  - [ ] Hide indicator when connection is restored
  - [ ] Ensure indicator is accessible (ARIA labels, keyboard navigation)

- [ ] Task 8: Handle offline state gracefully (AC: 9)
  - [ ] Show user-friendly message when offline
  - [ ] Ensure application functions normally when offline (data is in IndexedDB)
  - [ ] Handle Service Worker errors gracefully
  - [ ] Provide feedback when offline actions are attempted (if needed)
  - [ ] Ensure error messages are clear and helpful

- [ ] Task 9: Implement install prompt handling (AC: 5)
  - [ ] Listen for `beforeinstallprompt` event
  - [ ] Store install prompt event for later use
  - [ ] Create install button/component (optional, for custom install UI)
  - [ ] Show install prompt when user clicks install button
  - [ ] Handle install prompt dismissal
  - [ ] Track installation state

- [ ] Task 10: Verify PWA installability (AC: 5, 6)
  - [ ] Test install prompt appears in Chrome/Edge
  - [ ] Test install prompt appears in Firefox (if supported)
  - [ ] Test installed PWA launches in standalone mode
  - [ ] Verify standalone window has no browser UI
  - [ ] Test PWA icon appears correctly on desktop/home screen
  - [ ] Verify PWA name displays correctly when installed

- [ ] Task 11: Test offline functionality (AC: 4)
  - [ ] Load application while online
  - [ ] Verify assets are cached by Service Worker
  - [ ] Disable network in browser DevTools (offline mode)
  - [ ] Reload application
  - [ ] Verify application loads from cache
  - [ ] Verify application functions normally (can interact with IndexedDB)
  - [ ] Test that data operations work offline

- [ ] Task 12: Implement cache update strategy (AC: 7)
  - [ ] Configure Workbox to check for updates on navigation
  - [ ] Show update notification when new version is available
  - [ ] Allow user to refresh to get new version
  - [ ] Handle Service Worker update lifecycle:
    - [ ] New Service Worker installs in background
    - [ ] User is notified of update
    - [ ] User can activate new Service Worker
  - [ ] Ensure smooth transition between versions

- [ ] Task 13: Add Service Worker update UI (AC: 7)
  - [ ] Create UpdateNotification component
  - [ ] Show notification when Service Worker update is available
  - [ ] Provide "Update" button to activate new Service Worker
  - [ ] Handle update activation
  - [ ] Reload page after update activation

- [ ] Task 14: Testing and verification (AC: 1-9)
  - [ ] Test Service Worker registration in Chrome DevTools
  - [ ] Test cache storage in Application tab
  - [ ] Test offline functionality
  - [ ] Test install prompt
  - [ ] Test PWA installation
  - [ ] Test cache updates
  - [ ] Test offline indicator
  - [ ] Verify all acceptance criteria are met

- [ ] Task 15: Code quality and documentation (AC: 1-9)
  - [ ] Ensure all code follows TypeScript strict mode (no `any`)
  - [ ] Add JSDoc comments to Service Worker utilities
  - [ ] Document cache strategies used
  - [ ] Update README with PWA information
  - [ ] Run linter and fix any issues
  - [ ] Ensure accessibility requirements are met

## Dev Notes

### Previous Story Insights
[Source: Story 1.1, Story 1.2]

**Key Learnings from Story 1.1:**
- Project structure is established: `src/utils/`, `src/hooks/`, `src/components/`
- Vite ^5.0.0 is configured as build tool
- TypeScript is configured with strict mode and path aliases (@/ for src/)
- Project uses React ^18.2.0, TypeScript ^5.3.0

**Key Learnings from Story 1.2:**
- IndexedDB is set up with Dexie.js ^3.2.4
- Data layer is established in `src/services/data/`
- Database operations use async/await pattern
- Data persists across browser sessions

**Important Notes:**
- Service Worker will work with existing IndexedDB setup
- Offline functionality relies on IndexedDB for data persistence
- Service Worker can access IndexedDB for background timer operations (future story)

### Tech Stack Requirements
[Source: architecture/common/tech-stack.md]

**Critical Versions:**
- Workbox: ^7.0.0 (Service Worker management)
- Vite: ^5.0.0 (already installed in Story 1.1)
- vite-plugin-pwa: Latest compatible with Vite 5.0.0

**PWA Technology:**
- Service Worker API (browser-native, no installation needed)
- Workbox ^7.0.0 as wrapper library for Service Worker management
- Web App Manifest (JSON file)
- Browser APIs: `navigator.onLine`, `beforeinstallprompt`, Service Worker registration

### Service Worker Infrastructure
[Source: architecture/components.md#service-worker-infrastructure]

**Responsibility:** Handles offline functionality, asset caching, and background timer operation.

**Key Interfaces:**
- Asset caching strategy (Workbox)
- Background timer management (for future stories)
- Offline state detection
- Cache updates and versioning

**Dependencies:** Workbox, IndexedDB

**Technology Stack:** Workbox ^7.0.0, Service Worker API

### Service Worker Architecture
[Source: architecture/high-level-architecture.md#service-worker-background-timer-implementation-details]

**Service Worker Pattern:**
- Background processing for timers and asset caching
- Enables timer functionality when browser tab is inactive
- Provides offline asset caching
- Meets PRD requirements for background timer operation and offline-first architecture

**Architecture:**
1. **Main Thread:** React application manages UI and user interactions
2. **Service Worker:** Handles asset caching and background operations
3. **IndexedDB:** Shared storage accessible from both main thread and Service Worker

**Note:** Background timer functionality will be implemented in a future story. This story focuses on asset caching and offline functionality.

### Workbox Configuration
[Source: architecture/common/tech-stack.md, PRD]

**Workbox Benefits:**
- Simplifies Service Worker management
- Provides caching strategies out of the box
- Handles cache updates automatically
- Better developer experience than raw Service Worker API

**Cache Strategies:**
- **Cache First:** For static assets (HTML, CSS, JS) - serve from cache, fallback to network
- **Network First:** For API calls (not applicable - no backend)
- **Stale While Revalidate:** For frequently updated content (can be used for app shell)

**Recommended Configuration:**
- Use `vite-plugin-pwa` for Vite integration
- Generate Service Worker automatically during build
- Configure precaching for app shell
- Set up runtime caching if needed

### Web App Manifest
[Source: Epic 1.3 Acceptance Criteria, PRD]

**Required Fields:**
```json
{
  "name": "Time-Tracking Kanban App",
  "short_name": "Kanban Tracker",
  "description": "Time-tracking kanban board for solo freelancers",
  "start_url": "/",
  "display": "standalone",
  "theme_color": "#...",
  "background_color": "#...",
  "icons": [
    {
      "src": "/icons/icon-192x192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-512x512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
}
```

**Display Modes:**
- `standalone`: Native app-like experience (required for AC 6)
- Removes browser UI when installed
- Provides native app feel

**Theme Colors:**
- `theme_color`: Color for browser UI (address bar, etc.)
- `background_color`: Color for splash screen
- Should match application design system (Tailwind theme)

### PWA Icons
[Source: Epic 1.3 Acceptance Criteria]

**Required Sizes:**
- 192x192 (required minimum)
- 512x512 (required minimum)
- Additional sizes recommended: 144x144, 384x384

**Format:**
- PNG format
- Transparent background (optional)
- Accessible design (meets WCAG requirements)

**Location:**
- `public/icons/` directory
- Referenced in `manifest.json`

### Offline Detection
[Source: Epic 1.3 Acceptance Criteria]

**Browser APIs:**
- `navigator.onLine`: Boolean indicating online status
- `online` event: Fired when connection is restored
- `offline` event: Fired when connection is lost

**Implementation Pattern:**
```typescript
const [isOnline, setIsOnline] = useState(navigator.onLine);

useEffect(() => {
  const handleOnline = () => setIsOnline(true);
  const handleOffline = () => setIsOnline(false);

  window.addEventListener('online', handleOnline);
  window.addEventListener('offline', handleOffline);

  return () => {
    window.removeEventListener('online', handleOnline);
    window.removeEventListener('offline', handleOffline);
  };
}, []);
```

**Offline Indicator:**
- Display when `isOnline === false`
- Should be visible but not intrusive
- Accessible (ARIA labels, keyboard navigation)
- Clear messaging for users

### Install Prompt
[Source: Epic 1.3 Acceptance Criteria]

**Browser Support:**
- Chrome/Edge: Full support
- Firefox: Limited support (may not show prompt)
- Safari: Limited support on macOS/iOS

**Implementation:**
- Listen for `beforeinstallprompt` event
- Store event for later use
- Show custom install button (optional)
- Call `prompt()` method when user clicks install

**Install Criteria (Browser Requirements):**
- HTTPS (required for Service Worker)
- Valid Web App Manifest
- Service Worker registered
- Icons provided
- Meets browser-specific criteria

### Cache Update Strategy
[Source: Epic 1.3 Acceptance Criteria, architecture/components.md]

**Update Process:**
1. New Service Worker installs in background
2. Old Service Worker remains active until new one is activated
3. User is notified of update availability
4. User can activate new Service Worker (refresh page)
5. New Service Worker takes over, old cache is cleared

**Workbox Handling:**
- Workbox automatically checks for updates
- Can configure update check frequency
- Provides hooks for update notifications

**User Experience:**
- Show update notification when available
- Allow user to update immediately or later
- Ensure smooth transition (no data loss)
- Reload page after update activation

### Project Structure
[Source: architecture/unified-project-structure.md]

**File Locations:**
- Service Worker: `public/sw.js` (generated by Workbox)
- Web App Manifest: `public/manifest.json`
- PWA Icons: `public/icons/`
- Service Worker utilities: `src/utils/serviceWorker.ts`
- Offline detection hook: `src/hooks/useOnlineStatus.ts`
- Offline indicator component: `src/components/common/OfflineIndicator.tsx`
- Update notification component: `src/components/common/UpdateNotification.tsx`
- Vite config: `vite.config.ts` (root)
- HTML entry: `index.html` (root, needs manifest link)

### Coding Standards
[Source: architecture/common/coding-standards.md]

**Critical Rules:**
- **Type Safety:** Always use TypeScript types/interfaces, avoid `any`
- **Error Handling:** All async operations must have try/catch
- **Accessibility:** All interactive elements must have ARIA labels, keyboard navigation support
- **Naming Conventions:**
  - Hooks: camelCase with 'use' prefix (e.g., `useOnlineStatus.ts`)
  - Components: PascalCase (e.g., `OfflineIndicator.tsx`)
  - Utilities: camelCase (e.g., `serviceWorker.ts`)

**Common Pitfall to Avoid:**
- ❌ **Pitfall:** Not handling Service Worker registration errors
- ✅ **Solution:** Wrap registration in try/catch, show user-friendly error messages
- **Why:** Service Worker may fail in some browsers or environments

### Testing Requirements
[Source: architecture/common/testing-strategy.md]

**Test Organization:**
- Unit tests: `tests/unit/utils/`, `tests/unit/hooks/`, `tests/unit/components/`
- Integration tests: `tests/integration/` (Service Worker registration)
- E2E tests: `tests/e2e/` (PWA installation, offline functionality)

**Testing Frameworks:**
- Jest ^29.7.0 for unit testing
- Playwright ^1.40.0 for E2E testing

**Test Standards:**
- Test Service Worker registration
- Test offline detection hook
- Test offline indicator component
- Test install prompt handling
- Test cache update flow
- Use descriptive test names
- Follow Arrange-Act-Assert pattern

**Mocking Service Worker:**
- Use `@testing-library/jest-dom` for DOM testing
- Mock `navigator.onLine` and events
- Mock Service Worker registration API
- Test error scenarios

**E2E Testing:**
- Test PWA installation flow
- Test offline functionality
- Test cache updates
- Test install prompt appearance

### Performance Considerations
[Source: PRD, architecture]

**Cache Strategy Impact:**
- Cache-first strategy improves load times
- Reduces network requests
- Enables offline functionality

**Service Worker Registration:**
- Should not block application startup
- Register in background
- Handle registration asynchronously

**Cache Size:**
- Monitor cache size
- Implement cache cleanup if needed
- Ensure cache doesn't exceed browser limits

### Technical Constraints
[Source: architecture/common/tech-stack.md, PRD]

- **HTTPS Required:** Service Worker requires HTTPS (or localhost for development)
- **Browser Support:** Service Worker supported in modern browsers (Chrome, Firefox, Safari, Edge)
- **Install Prompt:** Browser-specific (Chrome/Edge have best support)
- **Offline Storage:** IndexedDB works offline (already implemented in Story 1.2)
- **No Backend:** All functionality is client-side, no API calls to cache

### Accessibility Requirements
[Source: architecture/common/accessibility-implementation.md, PRD]

**WCAG 2.1 AA Compliance:**
- Offline indicator must be accessible (ARIA labels)
- Install button must be keyboard navigable
- Update notification must be screen reader compatible
- Error messages must be clear and accessible

**ARIA Labels:**
- Offline indicator: `aria-label="Offline"`, `aria-live="polite"`
- Install button: `aria-label="Install application"`
- Update notification: `aria-label="Update available"`, `role="alert"`

### Testing

#### Testing Standards
[Source: architecture/common/testing-strategy.md]

**Test File Location:**
- Unit tests: `tests/unit/` directory
- Integration tests: `tests/integration/` directory
- E2E tests: `tests/e2e/` directory

**Testing Frameworks:**
- Jest ^29.7.0 for unit and integration testing
- Playwright ^1.40.0 for E2E testing

**Test Standards:**
- Write tests for Service Worker registration
- Test offline detection functionality
- Test install prompt handling
- Test cache update flow
- Use descriptive test names
- Follow Arrange-Act-Assert pattern
- Mock browser APIs appropriately

**Test Examples:**

**Hook Test Example:**
```typescript
import { renderHook, act } from '@testing-library/react';
import { useOnlineStatus } from '@/hooks/useOnlineStatus';

describe('useOnlineStatus', () => {
  it('returns online status', () => {
    Object.defineProperty(navigator, 'onLine', {
      writable: true,
      value: true
    });

    const { result } = renderHook(() => useOnlineStatus());
    expect(result.current).toBe(true);
  });

  it('updates when offline event fires', () => {
    const { result } = renderHook(() => useOnlineStatus());
    
    act(() => {
      window.dispatchEvent(new Event('offline'));
    });

    expect(result.current).toBe(false);
  });
});
```

**Component Test Example:**
```typescript
import { render, screen } from '@testing-library/react';
import { OfflineIndicator } from '@/components/common/OfflineIndicator';

describe('OfflineIndicator', () => {
  it('displays when offline', () => {
    render(<OfflineIndicator isOnline={false} />);
    expect(screen.getByText(/offline/i)).toBeInTheDocument();
  });

  it('does not display when online', () => {
    render(<OfflineIndicator isOnline={true} />);
    expect(screen.queryByText(/offline/i)).not.toBeInTheDocument();
  });
});
```

**E2E Test Example:**
```typescript
import { test, expect } from '@playwright/test';

test('PWA install prompt appears', async ({ page, context }) => {
  await page.goto('http://localhost:5173');
  
  // Check if install prompt is available
  const installPrompt = await page.evaluate(() => {
    return new Promise((resolve) => {
      window.addEventListener('beforeinstallprompt', (e) => {
        resolve(true);
      });
    });
  });

  expect(installPrompt).toBeTruthy();
});

test('application works offline', async ({ page, context }) => {
  await page.goto('http://localhost:5173');
  
  // Go offline
  await context.setOffline(true);
  
  // Reload page
  await page.reload();
  
  // Verify application loads
  await expect(page.locator('body')).toBeVisible();
});
```

**Specific Testing Requirements for This Story:**
- Test Service Worker registration success and failure scenarios
- Test offline detection hook (online/offline events)
- Test offline indicator component display/hide
- Test install prompt event handling
- Test cache update notification
- Test PWA installation flow (E2E)
- Test offline functionality (E2E)
- Verify all acceptance criteria are met

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
