# Story 1.4: Kanban Board Layout and Column Management

## Status
Draft

## Story
**As a** user,
**I want** a kanban board with customizable columns,
**so that** I can organize my tasks in a visual workflow that matches my process.

## Acceptance Criteria

1. Kanban board displays with default columns (Backlog, In Progress, Review, Done)
2. Columns are visually distinct with clear headers and appropriate styling
3. User can add new columns via UI control (button/menu)
4. User can remove columns via UI control (with confirmation if column contains tasks)
5. User can reorder columns via drag-and-drop
6. Column names are editable inline
7. Column configuration persists across browser sessions
8. Board layout is responsive and adapts to different window sizes
9. Empty columns display appropriate placeholder/empty state
10. Column management is accessible via keyboard navigation

## Tasks / Subtasks

- [ ] Task 1: Install and configure @dnd-kit for drag-and-drop (AC: 5)
  - [ ] Install @dnd-kit/core ^6.0.0 as specified in tech stack
  - [ ] Install @dnd-kit/sortable for sortable lists
  - [ ] Install @dnd-kit/utilities for helper functions
  - [ ] Verify versions match architecture requirements

- [ ] Task 2: Create Column type definition (AC: 1, 7)
  - [ ] Create `src/types/column.ts` with Column interface
  - [ ] Ensure type matches data model from architecture docs
  - [ ] Export type for use in components and repositories

- [ ] Task 3: Implement ColumnRepository (AC: 7)
  - [ ] Create `src/services/data/repositories/ColumnRepository.ts`
  - [ ] Implement `create(column: Omit<Column, 'id' | 'createdAt' | 'updatedAt'>): Promise<Column>`
  - [ ] Implement `getById(id: string): Promise<Column | undefined>`
  - [ ] Implement `getAll(): Promise<Column[]>` (ordered by position)
  - [ ] Implement `update(id: string, updates: Partial<Column>): Promise<Column>`
  - [ ] Implement `delete(id: string): Promise<void>`
  - [ ] Implement `reorder(columnIds: string[]): Promise<void>` (update positions)
  - [ ] Ensure all methods use async/await pattern
  - [ ] Ensure all methods handle errors appropriately

- [ ] Task 4: Add columns table to database schema (AC: 1, 7)
  - [ ] Update `src/services/data/database.ts`
  - [ ] Add `columns` table to schema: 'id, position'
  - [ ] Ensure migration handles existing databases (if any)
  - [ ] Verify schema matches architecture specification

- [ ] Task 5: Create ColumnContext for state management (AC: 1, 7)
  - [ ] Create `src/contexts/ColumnContext.tsx`
  - [ ] Implement ColumnProvider component
  - [ ] Manage columns state (loading, error, columns array)
  - [ ] Provide methods: createColumn, updateColumn, deleteColumn, reorderColumns
  - [ ] Load columns from IndexedDB on mount
  - [ ] Persist changes to IndexedDB automatically
  - [ ] Ensure optimistic updates for better UX

- [ ] Task 6: Initialize default columns on first load (AC: 1)
  - [ ] Check if columns exist in database
  - [ ] If no columns exist, create default columns:
    - [ ] "Backlog" (position: 0)
    - [ ] "In Progress" (position: 1)
    - [ ] "Review" (position: 2)
    - [ ] "Done" (position: 3)
  - [ ] Ensure initialization happens only once
  - [ ] Handle initialization errors gracefully

- [ ] Task 7: Create KanbanBoard component (AC: 1, 2, 8)
  - [ ] Create `src/components/kanban/KanbanBoard.tsx`
  - [ ] Use ColumnContext to get columns
  - [ ] Render columns horizontally in a scrollable container
  - [ ] Ensure responsive layout (adapts to window size)
  - [ ] Use Tailwind CSS for styling
  - [ ] Ensure board is accessible (ARIA labels, semantic HTML)
  - [ ] Add loading state while columns load
  - [ ] Add error state if columns fail to load

- [ ] Task 8: Create Column component (AC: 1, 2, 9)
  - [ ] Create `src/components/kanban/Column.tsx`
  - [ ] Display column header with name and task count
  - [ ] Display column content area (empty state or tasks)
  - [ ] Style column with distinct visual appearance
  - [ ] Show empty state placeholder when column has no tasks
  - [ ] Ensure column is scrollable if content exceeds height
  - [ ] Make column accessible (ARIA labels, keyboard navigation)

- [ ] Task 9: Implement column header with controls (AC: 2, 3, 4, 6)
  - [ ] Create ColumnHeader component or section within Column
  - [ ] Display column name (editable inline)
  - [ ] Display task count badge
  - [ ] Add "Add Column" button/control (for new columns)
  - [ ] Add column menu button ("..." icon)
  - [ ] Column menu includes: Edit Name, Delete Column
  - [ ] Implement inline editing for column name
  - [ ] Ensure header is visually distinct and clear

- [ ] Task 10: Implement add column functionality (AC: 3)
  - [ ] Create AddColumnButton component or add to board header
  - [ ] Show add column form/modal when clicked
  - [ ] Form collects: column name (required)
  - [ ] Create new column with next available position
  - [ ] Add column to board immediately (optimistic update)
  - [ ] Persist column to IndexedDB
  - [ ] Handle validation errors
  - [ ] Ensure accessible (keyboard navigation, ARIA labels)

- [ ] Task 11: Implement delete column functionality (AC: 4)
  - [ ] Add delete option to column menu
  - [ ] Check if column contains tasks
  - [ ] If column has tasks, show confirmation dialog:
    - [ ] Warn user that tasks will be moved or deleted
    - [ ] Option to move tasks to another column
    - [ ] Option to delete column and all tasks
  - [ ] If column is empty, delete immediately
  - [ ] Remove column from board (optimistic update)
  - [ ] Delete column from IndexedDB
  - [ ] Handle errors gracefully

- [ ] Task 12: Implement column drag-and-drop reordering (AC: 5)
  - [ ] Set up @dnd-kit DndContext in KanbanBoard
  - [ ] Configure sensors for mouse and keyboard
  - [ ] Make columns draggable using useSortable hook
  - [ ] Implement drag handlers for column reordering
  - [ ] Update column positions on drop
  - [ ] Persist new order to IndexedDB
  - [ ] Provide visual feedback during drag (opacity, scale)
  - [ ] Ensure smooth animation (60fps)
  - [ ] Handle drag cancellation (ESC key)

- [ ] Task 13: Implement inline column name editing (AC: 6)
  - [ ] Make column name clickable/editable
  - [ ] Show input field when editing
  - [ ] Save on Enter key or blur
  - [ ] Cancel on Escape key
  - [ ] Validate name (not empty, unique)
  - [ ] Update column in IndexedDB
  - [ ] Show error message if validation fails
  - [ ] Ensure accessible (keyboard navigation)

- [ ] Task 14: Implement responsive layout (AC: 8)
  - [ ] Use Tailwind responsive classes
  - [ ] Ensure columns wrap or scroll on small screens
  - [ ] Test layout at different window sizes:
    - [ ] Mobile (< 640px): Stack columns vertically or horizontal scroll
    - [ ] Tablet (640px - 1024px): 2-3 columns per row
    - [ ] Desktop (> 1024px): All columns in single row
  - [ ] Ensure touch-friendly interactions on mobile
  - [ ] Test drag-and-drop on touch devices

- [ ] Task 15: Implement empty state for columns (AC: 9)
  - [ ] Create EmptyColumnState component
  - [ ] Display when column has no tasks
  - [ ] Show helpful message (e.g., "No tasks in this column")
  - [ ] Optionally show "Add Task" button
  - [ ] Ensure empty state is visually distinct
  - [ ] Ensure accessible (ARIA labels)

- [ ] Task 16: Implement keyboard navigation (AC: 10)
  - [ ] Ensure columns are keyboard navigable
  - [ ] Tab through column headers
  - [ ] Arrow keys to move between columns
  - [ ] Enter/Space to activate column actions
  - [ ] Escape to cancel actions
  - [ ] Ensure focus indicators are visible
  - [ ] Test with screen reader
  - [ ] Follow WCAG 2.1 AA keyboard navigation standards

- [ ] Task 17: Style columns with Tailwind CSS (AC: 2)
  - [ ] Apply consistent styling to columns
  - [ ] Use rounded corners and subtle shadows
  - [ ] Ensure adequate spacing between columns
  - [ ] Use color coding if column.color is set
  - [ ] Ensure visual distinction between columns
  - [ ] Match design system from front-end spec
  - [ ] Support dark mode (if implemented)

- [ ] Task 18: Testing and verification (AC: 1-10)
  - [ ] Test default columns are created on first load
  - [ ] Test adding new column
  - [ ] Test deleting empty column
  - [ ] Test deleting column with tasks (confirmation)
  - [ ] Test reordering columns via drag-and-drop
  - [ ] Test inline editing of column names
  - [ ] Test column persistence across browser sessions
  - [ ] Test responsive layout at different sizes
  - [ ] Test empty state display
  - [ ] Test keyboard navigation
  - [ ] Verify all acceptance criteria are met

- [ ] Task 19: Code quality and accessibility (AC: 10)
  - [ ] Ensure all components use TypeScript (no `any`)
  - [ ] Add ARIA labels to interactive elements
  - [ ] Ensure semantic HTML structure
  - [ ] Test with screen reader
  - [ ] Ensure keyboard navigation works
  - [ ] Add JSDoc comments to components
  - [ ] Run linter and fix any issues
  - [ ] Ensure code follows component template pattern

## Dev Notes

### Previous Story Insights
[Source: Story 1.1, Story 1.2, Story 1.3]

**Key Learnings from Story 1.1:**
- Project structure is established: `src/components/`, `src/contexts/`, `src/hooks/`
- Vite ^5.0.0 is configured as build tool
- TypeScript is configured with strict mode and path aliases (@/ for src/)
- Tailwind CSS ^3.4.0 is configured for styling
- Project uses React ^18.2.0, TypeScript ^5.3.0

**Key Learnings from Story 1.2:**
- IndexedDB is set up with Dexie.js ^3.2.4
- Data layer is established in `src/services/data/`
- Repository pattern is implemented for data access
- Database operations use async/await pattern
- Column table schema: 'id, position'

**Key Learnings from Story 1.3:**
- PWA is configured with Service Worker
- Application works offline
- Data persists across browser sessions

**Important Notes:**
- Columns will be stored in IndexedDB (ColumnRepository)
- Column state managed via ColumnContext (React Context API)
- Drag-and-drop uses @dnd-kit/core ^6.0.0
- Components must be accessible (WCAG 2.1 AA)

### Tech Stack Requirements
[Source: architecture/common/tech-stack.md]

**Critical Versions:**
- @dnd-kit/core: ^6.0.0 (drag-and-drop library)
- @dnd-kit/sortable: Latest compatible version
- React: ^18.2.0 (already installed)
- TypeScript: ^5.3.0 (already installed)
- Tailwind CSS: ^3.4.0 (already installed)
- Dexie.js: ^3.2.4 (already installed)

**Drag-and-Drop Library:**
- @dnd-kit/core ^6.0.0 for kanban drag-and-drop
- Modern, accessible drag-and-drop library
- Better TypeScript support and accessibility than react-beautiful-dnd
- Supports 60fps requirement

### Data Models
[Source: architecture/common/data-models.md#column]

**Column Interface:**
```typescript
interface Column {
  id: string;
  name: string;
  position: number;
  color: string | null;
  createdAt: Date;
  updatedAt: Date;
}
```

**Key Attributes:**
- `id`: string - Unique identifier (UUID)
- `name`: string - Column name (e.g., "In Progress")
- `position`: number - Order/position of column on the board
- `color`: string | null - Color code for visual distinction (hex color)
- `createdAt`: Date - Timestamp when column was created
- `updatedAt`: Date - Timestamp when column was last updated

**Relationships:**
- Has many Tasks (one-to-many via `columnId` in Task model)

**Default Columns:**
- "Backlog" (position: 0)
- "In Progress" (position: 1)
- "Review" (position: 2)
- "Done" (position: 3)

### Database Schema
[Source: architecture/common/database-schema.md]

**Columns Table Schema:**
```typescript
columns: 'id, position'
```

**Index Strategy:**
- Primary key: `id`
- Index: `position` - For ordered display of columns

**Migration:**
- Columns table should be added to database schema
- If database already exists, add columns table in migration
- Initialize default columns if table is empty

### Repository Pattern
[Source: architecture/common/coding-standards.md, Story 1.2]

**ColumnRepository Methods:**
- `create(column: Omit<Column, 'id' | 'createdAt' | 'updatedAt'>): Promise<Column>`
- `getById(id: string): Promise<Column | undefined>`
- `getAll(): Promise<Column[]>` (ordered by position)
- `update(id: string, updates: Partial<Column>): Promise<Column>`
- `delete(id: string): Promise<void>`
- `reorder(columnIds: string[]): Promise<void>` (update positions in bulk)

**Critical Rule:**
- Always use repository pattern, never access IndexedDB directly from components
- Components must use ColumnRepository, not `db.columns.get()` directly

### State Management Architecture
[Source: architecture/common/frontend-architecture.md#state-management-architecture]

**ColumnContext Structure:**
```typescript
interface ColumnState {
  columns: Column[];
  loading: boolean;
  error: Error | null;
}
```

**State Management Patterns:**
- **Context Provider:** ColumnContext manages column state
- **Custom Hooks:** Business logic encapsulated in custom hooks
- **Optimistic Updates:** UI updates immediately, then syncs with IndexedDB
- **Error Boundaries:** React Error Boundaries catch component errors gracefully
- **Memoization:** Use `React.memo`, `useMemo`, and `useCallback` to prevent unnecessary re-renders

**ColumnContext Methods:**
- `createColumn(name: string): Promise<Column>`
- `updateColumn(id: string, updates: Partial<Column>): Promise<Column>`
- `deleteColumn(id: string): Promise<void>`
- `reorderColumns(columnIds: string[]): Promise<void>`
- `getColumnById(id: string): Column | undefined`

### Component Architecture
[Source: architecture/common/frontend-architecture.md#component-architecture]

**Component Organization:**
```
src/components/kanban/
├── KanbanBoard.tsx      # Main board container
├── Column.tsx           # Individual column component
└── TaskCard.tsx          # Task card (for future story)
```

**Component Template:**
```typescript
import React from 'react';
import { useColumnContext } from '@/contexts/ColumnContext';

interface ComponentProps {
  // Props definition
}

export const Component: React.FC<ComponentProps> = ({ ...props }) => {
  const { columns, createColumn } = useColumnContext();
  
  // Component logic
  
  return (
    <div className="...">
      {/* JSX */}
    </div>
  );
};
```

### Drag-and-Drop Implementation
[Source: architecture/common/tech-stack.md, PRD]

**@dnd-kit Setup:**
- Use `DndContext` as root provider
- Use `SortableContext` for sortable lists
- Use `useSortable` hook for draggable items
- Configure sensors for mouse and keyboard

**Column Reordering Pattern:**
```typescript
import { DndContext, closestCenter, KeyboardSensor, PointerSensor, useSensor, useSensors } from '@dnd-kit/core';
import { SortableContext, sortableKeyboardCoordinates, useSortable } from '@dnd-kit/sortable';

// In KanbanBoard component
const sensors = useSensors(
  useSensor(PointerSensor),
  useSensor(KeyboardSensor, {
    coordinateGetter: sortableKeyboardCoordinates,
  })
);

const handleDragEnd = (event: DragEndEvent) => {
  const { active, over } = event;
  if (over && active.id !== over.id) {
    // Reorder columns
    reorderColumns(newOrder);
  }
};
```

**Performance Requirements:**
- Drag-and-drop must work smoothly at 60fps
- Use CSS transforms for performance
- Avoid layout thrashing during drag

### Accessibility Requirements
[Source: architecture/common/accessibility-implementation.md, PRD]

**WCAG 2.1 AA Compliance:**
- Keyboard navigation for all interactive elements
- Screen reader compatibility
- Focus indicators for keyboard navigation
- ARIA labels for interactive elements
- Semantic HTML structure

**ARIA Implementation:**
```typescript
// Kanban board
<div role="region" aria-label="Kanban board">
  {columns.map(column => (
    <div role="group" aria-label={`${column.name} column`}>
      {/* Tasks */}
    </div>
  ))}
</div>

// Column header
<div role="button" aria-label={`Edit ${column.name} column`}>
  {column.name}
</div>
```

**Keyboard Navigation:**
- Tab: Move between interactive elements
- Arrow keys: Move between columns
- Enter/Space: Activate actions
- Escape: Cancel actions
- Focus indicators must be visible

### Responsive Design
[Source: Epic 1.4 Acceptance Criteria, PRD]

**Breakpoints:**
- Mobile: < 640px (Tailwind `sm:`)
- Tablet: 640px - 1024px (Tailwind `md:` to `lg:`)
- Desktop: > 1024px (Tailwind `lg:`)

**Layout Strategy:**
- Desktop: All columns in single horizontal row
- Tablet: 2-3 columns per row, wrap as needed
- Mobile: Stack vertically or horizontal scroll

**Tailwind Responsive Classes:**
```typescript
<div className="flex flex-row lg:flex-row md:flex-col sm:flex-col gap-4">
  {/* Columns */}
</div>
```

### Visual Design
[Source: front-end-spec, PRD]

**Column Styling:**
- Rounded corners on columns
- Subtle shadow effects for depth
- Adequate spacing between columns for drag-and-drop
- Scrollable columns if content exceeds viewport height
- Visually distinct headers

**Column Header:**
- Column title and task count
- "+" icon (add task to this column) - for future story
- "..." icon (column options menu)

**Empty State:**
- Helpful message when column has no tasks
- Visually distinct from columns with tasks
- Optionally show "Add Task" button (for future story)

### Project Structure
[Source: architecture/unified-project-structure.md]

**File Locations:**
- Components: `src/components/kanban/`
  - `KanbanBoard.tsx`
  - `Column.tsx`
- Context: `src/contexts/ColumnContext.tsx`
- Repository: `src/services/data/repositories/ColumnRepository.ts`
- Types: `src/types/column.ts`
- Database: `src/services/data/database.ts` (update schema)
- Tests: `tests/unit/components/kanban/`, `tests/unit/services/data/repositories/`

### Coding Standards
[Source: architecture/common/coding-standards.md]

**Critical Rules:**
- **Type Safety:** Always use TypeScript types/interfaces, avoid `any`
- **Component Organization:** One component per file, co-locate related components
- **State Management:** Use Context API, avoid prop drilling beyond 2 levels
- **Data Access:** Always use repository pattern, never access IndexedDB directly from components
- **Error Handling:** All async operations must have try/catch
- **Performance:** Use React.memo, useMemo, useCallback appropriately
- **Accessibility:** All interactive elements must have ARIA labels, keyboard navigation support

**Naming Conventions:**
- Components: PascalCase (e.g., `KanbanBoard.tsx`, `Column.tsx`)
- Hooks: camelCase with 'use' prefix (e.g., `useColumn.ts`)
- Context: PascalCase (e.g., `ColumnContext.tsx`)
- Repositories: PascalCase classes (e.g., `ColumnRepository.ts`)
- Types/Interfaces: PascalCase (e.g., `Column`)

### Testing Requirements
[Source: architecture/common/testing-strategy.md]

**Test Organization:**
- Unit tests: `tests/unit/components/kanban/`, `tests/unit/services/data/repositories/`
- Integration tests: `tests/integration/` (ColumnContext integration)
- E2E tests: `tests/e2e/` (column management workflows)

**Testing Frameworks:**
- Jest ^29.7.0 for unit testing
- React Testing Library ^14.0.0 for component testing
- Playwright ^1.40.0 for E2E testing

**Test Standards:**
- Write tests for all CRUD operations
- Test drag-and-drop functionality
- Test keyboard navigation
- Test responsive layout
- Use descriptive test names
- Follow Arrange-Act-Assert pattern

**Test Examples:**

**Component Test Example:**
```typescript
import { render, screen, fireEvent } from '@testing-library/react';
import { ColumnContextProvider } from '@/contexts/ColumnContext';
import { KanbanBoard } from '@/components/kanban/KanbanBoard';

describe('KanbanBoard', () => {
  it('displays default columns', async () => {
    render(
      <ColumnContextProvider>
        <KanbanBoard />
      </ColumnContextProvider>
    );
    
    expect(await screen.findByText('Backlog')).toBeInTheDocument();
    expect(screen.getByText('In Progress')).toBeInTheDocument();
    expect(screen.getByText('Review')).toBeInTheDocument();
    expect(screen.getByText('Done')).toBeInTheDocument();
  });
});
```

**Repository Test Example:**
```typescript
import 'fake-indexeddb/auto';
import { ColumnRepository } from '@/services/data/repositories/ColumnRepository';
import { db } from '@/services/data/database';

describe('ColumnRepository', () => {
  let repository: ColumnRepository;

  beforeEach(async () => {
    repository = new ColumnRepository();
    await db.columns.clear();
  });

  it('creates a column successfully', async () => {
    const column = await repository.create({
      name: 'New Column',
      position: 0,
      color: null
    });
    
    expect(column.id).toBeDefined();
    expect(column.name).toBe('New Column');
  });
});
```

**E2E Test Example:**
```typescript
import { test, expect } from '@playwright/test';

test('user can reorder columns via drag-and-drop', async ({ page }) => {
  await page.goto('http://localhost:5173');
  
  const backlogColumn = page.locator('[data-testid="column-backlog"]');
  const inProgressColumn = page.locator('[data-testid="column-in-progress"]');
  
  // Drag Backlog column after In Progress
  await backlogColumn.dragTo(inProgressColumn);
  
  // Verify order changed
  const columns = page.locator('[data-testid="column"]');
  await expect(columns.first()).toContainText('In Progress');
});
```

**Specific Testing Requirements for This Story:**
- Test default columns initialization
- Test adding new column
- Test deleting column (empty and with tasks)
- Test reordering columns via drag-and-drop
- Test inline editing of column names
- Test column persistence
- Test responsive layout
- Test keyboard navigation
- Test empty state display
- Verify all acceptance criteria are met

### Performance Considerations
[Source: PRD, architecture]

**Performance Requirements:**
- Drag-and-drop must work smoothly at 60fps
- Board must handle many columns efficiently
- Responsive layout should not cause layout shifts

**Optimization Strategies:**
- Use CSS transforms for drag animations
- Memoize column components with React.memo
- Use useMemo for expensive calculations
- Use useCallback for event handlers
- Avoid unnecessary re-renders

### Technical Constraints
[Source: architecture/common/tech-stack.md, PRD]

- No backend services - frontend-only application
- All data stored in IndexedDB (local-first architecture)
- Columns persist across browser sessions
- Application works offline (Service Worker from Story 1.3)
- Single page application (no routing)

### Testing

#### Testing Standards
[Source: architecture/common/testing-strategy.md]

**Test File Location:**
- Unit tests: `tests/unit/` directory
- Integration tests: `tests/integration/` directory
- E2E tests: `tests/e2e/` directory

**Testing Frameworks:**
- Jest ^29.7.0 for unit and integration testing
- React Testing Library ^14.0.0 for component testing
- Playwright ^1.40.0 for E2E testing

**Test Standards:**
- Write tests for all CRUD operations
- Test user interactions (drag-and-drop, editing)
- Test keyboard navigation
- Test responsive behavior
- Use descriptive test names
- Follow Arrange-Act-Assert pattern
- Aim for high test coverage (80%+)

**Specific Testing Requirements for This Story:**
- Test ColumnRepository CRUD operations
- Test ColumnContext state management
- Test KanbanBoard component rendering
- Test Column component rendering
- Test drag-and-drop column reordering
- Test inline column name editing
- Test add/delete column functionality
- Test default columns initialization
- Test column persistence
- Test responsive layout
- Test keyboard navigation
- Test empty state display
- Verify all acceptance criteria are met

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
