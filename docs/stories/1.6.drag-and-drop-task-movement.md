# Story 1.6: Drag-and-Drop Task Movement

## Status
Draft

## Story
**As a** user,
**I want** to drag tasks between columns,
**so that** I can easily update task status and organize my workflow.

## Acceptance Criteria

1. Tasks can be dragged from one column to another using mouse/trackpad
2. Visual feedback shows task being dragged (ghost image or visual indicator)
3. Drop zones are clearly indicated when dragging over valid columns
4. Task moves to new column on drop and persists to IndexedDB
5. Drag-and-drop works smoothly at 60fps without lag
6. Task position within column can be reordered via drag-and-drop
7. Drag-and-drop is accessible via keyboard (alternative interaction method)
8. Invalid drop zones are clearly indicated (visual feedback)
9. Drag operation can be cancelled (ESC key or click outside)
10. Multiple rapid drag operations don't cause race conditions or data loss

## Tasks / Subtasks

- [ ] Task 1: Verify @dnd-kit installation (AC: 1, 5)
  - [ ] Verify @dnd-kit/core ^6.0.0 is installed (from Story 1.4)
  - [ ] Verify @dnd-kit/sortable is installed
  - [ ] Verify @dnd-kit/utilities is installed
  - [ ] Ensure versions match architecture requirements

- [ ] Task 2: Set up DndContext in KanbanBoard (AC: 1, 5)
  - [ ] Update `src/components/kanban/KanbanBoard.tsx`
  - [ ] Import DndContext from @dnd-kit/core
  - [ ] Configure sensors (PointerSensor, KeyboardSensor)
  - [ ] Set up collision detection (closestCenter)
  - [ ] Implement handleDragStart, handleDragOver, handleDragEnd handlers
  - [ ] Wrap columns and tasks in DndContext

- [ ] Task 3: Make TaskCard draggable (AC: 1, 2)
  - [ ] Update `src/components/kanban/TaskCard.tsx`
  - [ ] Import useDraggable from @dnd-kit/core
  - [ ] Use useDraggable hook with task id
  - [ ] Apply draggable attributes and listeners
  - [ ] Style card during drag (opacity, scale, shadow)
  - [ ] Ensure drag preview shows task information

- [ ] Task 4: Make Column a drop zone (AC: 3, 8)
  - [ ] Update `src/components/kanban/Column.tsx`
  - [ ] Import useDroppable from @dnd-kit/core
  - [ ] Use useDroppable hook with column id
  - [ ] Apply droppable attributes
  - [ ] Style column when task is dragged over (highlight background)
  - [ ] Show invalid drop indicator if needed
  - [ ] Ensure drop zone is clearly indicated

- [ ] Task 5: Implement task movement between columns (AC: 4)
  - [ ] Handle drag end event in KanbanBoard
  - [ ] Detect if task was dropped on different column
  - [ ] Call TaskContext.updateTask with new columnId
  - [ ] Update task position within new column
  - [ ] Persist change to IndexedDB via TaskRepository
  - [ ] Update UI state optimistically
  - [ ] Handle errors gracefully

- [ ] Task 6: Implement task reordering within column (AC: 6)
  - [ ] Set up SortableContext in Column component
  - [ ] Import useSortable from @dnd-kit/sortable
  - [ ] Make tasks sortable within column
  - [ ] Handle drag end for same-column reordering
  - [ ] Update task positions in column
  - [ ] Persist position changes to IndexedDB
  - [ ] Ensure smooth reordering animation

- [ ] Task 7: Implement visual feedback during drag (AC: 2)
  - [ ] Style TaskCard during drag:
    - [ ] Reduce opacity to 0.9
    - [ ] Scale to 1.05x
    - [ ] Increase shadow/elevation
    - [ ] Add cursor: grabbing
  - [ ] Show drag overlay/preview
  - [ ] Ensure visual feedback is clear and smooth
  - [ ] Use CSS transforms for performance (GPU-accelerated)

- [ ] Task 8: Implement drop zone highlighting (AC: 3, 8)
  - [ ] Highlight valid drop zones (columns) when dragging
    - [ ] Subtle background color tint (opacity 0.1)
    - [ ] Border highlight (optional)
  - [ ] Show invalid drop indicator (red border flash)
  - [ ] Clear highlights when drag ends or is cancelled
  - [ ] Ensure visual feedback is accessible

- [ ] Task 9: Implement drag cancellation (AC: 9)
  - [ ] Listen for ESC key during drag
  - [ ] Cancel drag operation on ESC key press
  - [ ] Return task to original position
  - [ ] Clear drag state
  - [ ] Handle click outside during drag (optional)
  - [ ] Ensure cancellation is smooth and clear

- [ ] Task 10: Implement keyboard accessibility (AC: 7)
  - [ ] Configure KeyboardSensor in DndContext
  - [ ] Use sortableKeyboardCoordinates utility
  - [ ] Allow arrow keys to move tasks between columns
  - [ ] Show preview before confirming move
  - [ ] Handle Enter to confirm, ESC to cancel
  - [ ] Ensure keyboard navigation is intuitive
  - [ ] Test with screen reader

- [ ] Task 11: Optimize for 60fps performance (AC: 5)
  - [ ] Use CSS transforms instead of position changes
  - [ ] Avoid layout thrashing during drag
  - [ ] Use will-change CSS property for draggable elements
  - [ ] Debounce/throttle position updates if needed
  - [ ] Minimize re-renders during drag
  - [ ] Use React.memo for TaskCard components
  - [ ] Test performance with many tasks (100+)

- [ ] Task 12: Handle race conditions (AC: 10)
  - [ ] Implement drag state management
  - [ ] Prevent multiple simultaneous drags
  - [ ] Queue rapid drag operations if needed
  - [ ] Ensure task updates are atomic
  - [ ] Handle concurrent updates gracefully
  - [ ] Verify no data loss during rapid operations

- [ ] Task 13: Update TaskContext for drag operations (AC: 4, 6)
  - [ ] Add updateTask method to TaskContext (if not exists)
  - [ ] Support updating columnId and position
  - [ ] Ensure optimistic updates
  - [ ] Handle errors and rollback if needed
  - [ ] Update task count in columns after move

- [ ] Task 14: Implement position calculation (AC: 4, 6)
  - [ ] Calculate new position when task moves to column
    - [ ] If dropped at end: max position + 1
    - [ ] If dropped between tasks: calculate intermediate position
  - [ ] Recalculate positions when task reordered within column
  - [ ] Update all affected task positions
  - [ ] Persist position changes to IndexedDB

- [ ] Task 15: Add drag animation and transitions (AC: 2, 5)
  - [ ] Implement smooth drop animation (200-300ms)
  - [ ] Use cubic-bezier easing for natural feel
  - [ ] Animate task to final position
  - [ ] Return to normal scale/opacity after drop
  - [ ] Respect prefers-reduced-motion media query
  - [ ] Ensure animations maintain 60fps

- [ ] Task 16: Handle edge cases (AC: 4, 9, 10)
  - [ ] Handle column deleted during drag
  - [ ] Handle task deleted during drag
  - [ ] Handle invalid drop targets
  - [ ] Handle drag outside board
  - [ ] Handle browser refresh during drag
  - [ ] Ensure graceful error handling

- [ ] Task 17: Update Column component for task display (AC: 4, 6)
  - [ ] Ensure Column displays tasks in correct order (by position)
  - [ ] Update task count when task moves
  - [ ] Handle empty column state
  - [ ] Ensure column scrolls if needed

- [ ] Task 18: Testing and verification (AC: 1-10)
  - [ ] Test dragging task between columns
  - [ ] Test reordering tasks within column
  - [ ] Test visual feedback during drag
  - [ ] Test drop zone highlighting
  - [ ] Test drag cancellation (ESC key)
  - [ ] Test keyboard accessibility
  - [ ] Test performance with many tasks
  - [ ] Test rapid drag operations
  - [ ] Test edge cases (deleted column, deleted task)
  - [ ] Verify all acceptance criteria are met

- [ ] Task 19: Code quality and accessibility (AC: 7)
  - [ ] Ensure all components use TypeScript (no `any`)
  - [ ] Add ARIA labels for drag-and-drop
  - [ ] Ensure keyboard navigation works
  - [ ] Test with screen reader
  - [ ] Add JSDoc comments to drag handlers
  - [ ] Run linter and fix any issues
  - [ ] Ensure code follows component template pattern

## Dev Notes

### Previous Story Insights
[Source: Story 1.1, Story 1.4, Story 1.5]

**Key Learnings from Story 1.1:**
- Project structure is established: `src/components/`, `src/contexts/`
- Vite ^5.0.0 is configured as build tool
- TypeScript is configured with strict mode and path aliases (@/ for src/)
- Tailwind CSS ^3.4.0 is configured for styling

**Key Learnings from Story 1.4:**
- @dnd-kit/core ^6.0.0 is installed for drag-and-drop
- Column drag-and-drop reordering is implemented
- DndContext setup pattern is established
- ColumnContext is implemented for column state management

**Key Learnings from Story 1.5:**
- TaskContext is implemented for task state management
- TaskCard component is created
- TaskRepository is available for data persistence
- Tasks are displayed in columns

**Important Notes:**
- @dnd-kit/core is already installed (from Story 1.4)
- TaskCard component already exists (from Story 1.5)
- Column component already exists (from Story 1.4)
- Need to add drag-and-drop functionality to existing components
- Performance is critical (60fps requirement)

### Tech Stack Requirements
[Source: architecture/common/tech-stack.md]

**Critical Versions:**
- @dnd-kit/core: ^6.0.0 (already installed in Story 1.4)
- @dnd-kit/sortable: Latest compatible version
- @dnd-kit/utilities: Latest compatible version
- React: ^18.2.0 (already installed)
- TypeScript: ^5.3.0 (already installed)

**Drag-and-Drop Library:**
- @dnd-kit/core ^6.0.0 for kanban drag-and-drop
- Modern, accessible drag-and-drop library
- Better TypeScript support and accessibility than react-beautiful-dnd
- Supports 60fps requirement

### Drag-and-Drop Architecture
[Source: architecture/common/tech-stack.md, architecture/core-workflows.md]

**@dnd-kit Setup:**
- Use `DndContext` as root provider
- Use `SortableContext` for sortable lists (tasks within column)
- Use `useDraggable` hook for draggable items (tasks)
- Use `useDroppable` hook for drop zones (columns)
- Use `useSortable` hook for sortable items (tasks within column)

**Drag-and-Drop Pattern:**
```typescript
import { DndContext, closestCenter, KeyboardSensor, PointerSensor, useSensor, useSensors, DragEndEvent } from '@dnd-kit/core';
import { SortableContext, useSortable, sortableKeyboardCoordinates } from '@dnd-kit/sortable';
import { useDraggable } from '@dnd-kit/core';
import { useDroppable } from '@dnd-kit/core';

// In KanbanBoard component
const sensors = useSensors(
  useSensor(PointerSensor),
  useSensor(KeyboardSensor, {
    coordinateGetter: sortableKeyboardCoordinates,
  })
);

const handleDragEnd = (event: DragEndEvent) => {
  const { active, over } = event;
  if (over && active.id !== over.id) {
    // Handle task movement or reordering
  }
};
```

**Performance Requirements:**
- Drag-and-drop must work smoothly at 60fps
- Use CSS transforms for performance (GPU-accelerated)
- Avoid layout thrashing during drag
- Minimize re-renders during drag operation

### Workflow: Move Task Between Columns
[Source: architecture/core-workflows.md#workflow-2]

**Sequence:**
1. User drags task card
2. TaskCard triggers drag start
3. KanbanBoard handles drag over/end
4. TaskContext.updateTask called with new columnId and position
5. TaskRepository updates task in IndexedDB
6. TaskContext updates UI state
7. Task appears in new column

**Key Points:**
- Optimistic updates for immediate UI feedback
- Persist to IndexedDB after UI update
- Handle errors and rollback if needed

### Visual Feedback and Animations
[Source: front-end-spec/animation-micro-interactions.md]

**Drag Start Animation:**
- Scale to 1.05x
- Increase shadow/elevation
- Reduce opacity to 0.9
- Duration: Instant (no animation on start)

**Dragging State:**
- Follow cursor smoothly
- Maintain elevation
- Cursor: grabbing

**Drop Target Valid:**
- Column background highlight (subtle color tint, opacity 0.1)
- Duration: 150ms
- Easing: ease-out

**Drop Target Invalid:**
- Red border flash
- Shake animation
- Duration: 200ms
- Easing: ease-in-out

**Drop Complete Animation:**
- Smooth transition to final position
- Return to normal scale/opacity
- Duration: 200-300ms
- Easing: cubic-bezier(0.4, 0.0, 0.2, 1) (Material Design standard)

**Accessibility:**
- Respect `prefers-reduced-motion` media query
- Use instant position change or very subtle animation when reduced motion is enabled

### Task Position Management
[Source: architecture/common/data-models.md#task]

**Task Position Attribute:**
- `position`: number - Position/order within the column (for drag-and-drop ordering)

**Position Calculation:**
- When task moves to new column:
  - If dropped at end: `max(position) + 1`
  - If dropped between tasks: calculate intermediate position (e.g., average of adjacent positions)
- When task reordered within column:
  - Update positions of affected tasks
  - Maintain relative order

**Position Updates:**
- Update all affected task positions in batch
- Persist position changes to IndexedDB
- Ensure atomic updates (no partial updates)

### State Management Architecture
[Source: architecture/common/frontend-architecture.md#state-management-architecture]

**TaskContext Methods (Already Implemented):**
- `updateTask(id: string, updates: Partial<Task>): Promise<Task>`
- Updates task columnId and position
- Persists to IndexedDB via TaskRepository
- Updates UI state optimistically

**Integration:**
- TaskContext handles task updates
- ColumnContext provides columns for validation
- Both contexts update their state after drag operation

### Component Architecture
[Source: architecture/common/frontend-architecture.md#component-architecture]

**Component Updates:**
- `KanbanBoard.tsx`: Add DndContext, handle drag events
- `Column.tsx`: Add useDroppable, SortableContext
- `TaskCard.tsx`: Add useDraggable, useSortable

**Component Template:**
```typescript
import { useDraggable } from '@dnd-kit/core';
import { useSortable } from '@dnd-kit/sortable';

export const TaskCard: React.FC<TaskCardProps> = ({ task }) => {
  const { attributes, listeners, setNodeRef, transform, isDragging } = useDraggable({
    id: task.id,
  });
  
  const style = transform ? {
    transform: `translate3d(${transform.x}px, ${transform.y}px, 0)`,
  } : undefined;
  
  return (
    <div
      ref={setNodeRef}
      style={style}
      {...listeners}
      {...attributes}
      className={isDragging ? 'opacity-90 scale-105' : ''}
    >
      {/* Task card content */}
    </div>
  );
};
```

### Accessibility Requirements
[Source: architecture/common/accessibility-implementation.md, PRD]

**WCAG 2.1 AA Compliance:**
- Keyboard navigation for drag-and-drop
- Screen reader compatibility
- ARIA labels for drag-and-drop operations
- Clear visual feedback

**Keyboard Accessibility:**
- Arrow keys to move tasks between columns
- Enter to confirm move
- ESC to cancel drag
- Tab to navigate between tasks

**ARIA Implementation:**
```typescript
// Draggable task
<div
  role="button"
  aria-label={`Drag task ${task.title} to move between columns`}
  aria-describedby={`task-${task.id}-description`}
  tabIndex={0}
>
  {/* Task content */}
</div>

// Drop zone
<div
  role="region"
  aria-label={`${column.name} column drop zone`}
  aria-dropeffect="move"
>
  {/* Column content */}
</div>
```

### Performance Optimization
[Source: PRD, architecture, front-end-spec]

**Performance Requirements:**
- Drag-and-drop must work smoothly at 60fps
- Handle 100+ tasks without lag
- Smooth animations during drag

**Optimization Strategies:**
- Use CSS transforms (GPU-accelerated)
- Use `will-change: transform` for draggable elements
- Avoid layout properties during drag (use transform instead of top/left)
- Minimize re-renders (use React.memo for TaskCard)
- Debounce/throttle position updates if needed
- Use virtual scrolling if needed (for future stories)

**CSS Performance:**
```css
.draggable {
  will-change: transform;
  transform: translate3d(0, 0, 0); /* Force GPU acceleration */
}

.dragging {
  opacity: 0.9;
  transform: scale(1.05) translate3d(var(--x), var(--y), 0);
  transition: none; /* Disable transitions during drag */
}
```

### Edge Cases and Error Handling
[Source: Epic 1.6 Acceptance Criteria, front-end-spec]

**Edge Cases:**
- Column deleted during drag: Cancel drag, show error
- Task deleted during drag: Cancel drag gracefully
- Drag outside board: Return to original position
- Invalid drop target: Show error, return to original position
- Browser refresh during drag: Handle gracefully (drag state lost)

**Race Conditions:**
- Multiple rapid drags: Queue operations, prevent simultaneous drags
- Concurrent updates: Use atomic updates, handle conflicts
- Network issues: Handle offline state (local-first, should work offline)

**Error Handling:**
- Try/catch around drag operations
- Rollback optimistic updates on error
- Show user-friendly error messages
- Log errors for debugging

### Project Structure
[Source: architecture/unified-project-structure.md]

**File Locations:**
- Components: `src/components/kanban/KanbanBoard.tsx`, `src/components/kanban/Column.tsx`, `src/components/kanban/TaskCard.tsx`
- Context: `src/contexts/TaskContext.tsx` (already exists)
- Repository: `src/services/data/repositories/TaskRepository.ts` (already exists)
- Tests: `tests/unit/components/kanban/`, `tests/integration/`, `tests/e2e/`

### Coding Standards
[Source: architecture/common/coding-standards.md]

**Critical Rules:**
- **Type Safety:** Always use TypeScript types/interfaces, avoid `any`
- **Performance:** Use React.memo, useMemo, useCallback appropriately
- **Accessibility:** All interactive elements must have ARIA labels, keyboard navigation support
- **Error Handling:** All async operations must have try/catch

**Naming Conventions:**
- Drag handlers: `handleDragStart`, `handleDragEnd`, `handleDragOver`
- Drag state: `isDragging`, `dragOverId`, `activeId`

### Testing Requirements
[Source: architecture/common/testing-strategy.md]

**Test Organization:**
- Unit tests: `tests/unit/components/kanban/`
- Integration tests: `tests/integration/` (drag-and-drop integration)
- E2E tests: `tests/e2e/` (drag-and-drop workflows)

**Testing Frameworks:**
- Jest ^29.7.0 for unit testing
- React Testing Library ^14.0.0 for component testing
- Playwright ^1.40.0 for E2E testing

**Test Standards:**
- Test drag-and-drop functionality
- Test keyboard accessibility
- Test performance with many tasks
- Test edge cases
- Use descriptive test names
- Follow Arrange-Act-Assert pattern

**Test Examples:**

**Component Test Example:**
```typescript
import { render, screen } from '@testing-library/react';
import { DndContext } from '@dnd-kit/core';
import { TaskCard } from '@/components/kanban/TaskCard';

describe('TaskCard', () => {
  it('is draggable', () => {
    const task = { id: '1', title: 'Test Task', ... };
    render(
      <DndContext>
        <TaskCard task={task} />
      </DndContext>
    );
    
    const card = screen.getByText('Test Task');
    expect(card).toHaveAttribute('draggable');
  });
});
```

**E2E Test Example:**
```typescript
import { test, expect } from '@playwright/test';

test('user can drag task between columns', async ({ page }) => {
  await page.goto('http://localhost:5173');
  
  const taskCard = page.locator('[data-testid="task-card"]').first();
  const targetColumn = page.locator('[data-testid="column"]').nth(1);
  
  // Drag task to target column
  await taskCard.dragTo(targetColumn);
  
  // Verify task moved
  await expect(targetColumn.locator('[data-testid="task-card"]')).toContainText('Test Task');
});
```

**Specific Testing Requirements for This Story:**
- Test dragging task between columns
- Test reordering tasks within column
- Test visual feedback during drag
- Test drop zone highlighting
- Test drag cancellation (ESC key)
- Test keyboard accessibility
- Test performance with many tasks (100+)
- Test rapid drag operations
- Test edge cases (deleted column, deleted task)
- Verify all acceptance criteria are met

### Performance Considerations
[Source: PRD, architecture]

**Performance Requirements:**
- Drag-and-drop must work smoothly at 60fps
- Handle 100+ tasks without lag
- Smooth animations during drag

**Optimization Strategies:**
- Use CSS transforms for drag (GPU-accelerated)
- Minimize re-renders during drag
- Use React.memo for TaskCard components
- Debounce position updates if needed
- Test with many tasks to ensure performance

### Technical Constraints
[Source: architecture/common/tech-stack.md, PRD]

- No backend services - frontend-only application
- All data stored in IndexedDB (local-first architecture)
- Tasks persist across browser sessions
- Application works offline (Service Worker from Story 1.3)
- Single page application (no routing)
- Performance critical (60fps requirement)

### Testing

#### Testing Standards
[Source: architecture/common/testing-strategy.md]

**Test File Location:**
- Unit tests: `tests/unit/` directory
- Integration tests: `tests/integration/` directory
- E2E tests: `tests/e2e/` directory

**Testing Frameworks:**
- Jest ^29.7.0 for unit and integration testing
- React Testing Library ^14.0.0 for component testing
- Playwright ^1.40.0 for E2E testing

**Test Standards:**
- Write tests for drag-and-drop functionality
- Test keyboard accessibility
- Test performance with many tasks
- Test edge cases and error handling
- Use descriptive test names
- Follow Arrange-Act-Assert pattern
- Aim for high test coverage (80%+)

**Specific Testing Requirements for This Story:**
- Test drag-and-drop between columns
- Test reordering within column
- Test visual feedback
- Test keyboard accessibility
- Test performance (60fps)
- Test edge cases
- Test race condition handling
- Verify all acceptance criteria are met

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
