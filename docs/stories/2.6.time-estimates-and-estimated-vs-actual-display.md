# Story 2.6: Time Estimates and Estimated vs Actual Display

## Status
Draft

## Story
**As a** user,
**I want** to set time estimates for tasks and see estimated vs actual time,
**so that** I can plan my work and track accuracy.

## Acceptance Criteria

1. Task creation/edit allows setting time estimate (hours/minutes)
2. Time estimate displays on task card alongside actual time spent
3. Visual indicator shows if task is over/under estimate (color coding or icon)
4. Estimated vs actual comparison is clearly visible on task card
5. Time estimate is editable after task creation
6. Estimate is stored in IndexedDB with task data
7. Estimate format matches actual time format for consistency
8. Tasks without estimates don't show comparison (graceful handling)
9. Estimate comparison helps identify tasks that took longer/shorter than expected
10. Estimate data can be used for future planning (future enhancement consideration)

## Tasks / Subtasks

- [ ] Task 1: Add time estimate input to TaskForm (AC: 1, 5, 6)
  - [ ] Update `src/components/task/TaskForm.tsx`
  - [ ] Add time estimate input fields:
    - [ ] Hours input (number, 0-999, optional)
    - [ ] Minutes input (number, 0-59, optional)
    - [ ] Or single decimal hours input (e.g., 1.5 for 1h 30m)
  - [ ] Add form state for time estimate (hours, minutes)
  - [ ] Convert hours + minutes to total minutes for storage
  - [ ] Pre-populate fields when editing existing task (if timeEstimate exists)
  - [ ] Add validation: hours >= 0, minutes >= 0 and < 60
  - [ ] Allow clearing time estimate (set to null)
  - [ ] Ensure estimate is saved to task.timeEstimate (in minutes)
  - [ ] Style consistently with other form fields

- [ ] Task 2: Create time estimate display component (AC: 2, 4, 7, 8)
  - [ ] Create `src/components/timer/TimeEstimateDisplay.tsx`
  - [ ] Accept task prop (with timeEstimate and totalTime)
  - [ ] Display time estimate: "Est: 1h 30m" (using formatDuration utility)
  - [ ] Display actual time: "Actual: 2h 15m" (using formatDuration utility)
  - [ ] Display comparison: "Est: 1h 30m | Actual: 2h 15m"
  - [ ] Handle case where estimate is null (don't show estimate)
  - [ ] Handle case where actual time is 0 (show "Actual: 0m")
  - [ ] Use consistent formatting with TimerDisplay component
  - [ ] Style with Tailwind CSS

- [ ] Task 3: Calculate estimated vs actual comparison (AC: 3, 4, 9)
  - [ ] Create utility function: `calculateEstimateComparison(estimate: number, actual: number)`
  - [ ] Calculate difference: actual - estimate (in minutes)
  - [ ] Determine status: 'over', 'under', 'on-track' (with threshold, e.g., ±5%)
  - [ ] Return comparison object: { difference, percentage, status }
  - [ ] Handle edge cases: estimate = 0, actual = 0
  - [ ] Add JSDoc comments
  - [ ] Write unit tests

- [ ] Task 4: Add visual indicators for estimate comparison (AC: 3, 4, 9)
  - [ ] Update TimeEstimateDisplay component
  - [ ] Add color coding:
    - [ ] Over estimate: Red/orange color (e.g., text-red-600)
    - [ ] Under estimate: Green color (e.g., text-green-600)
    - [ ] On track: Default/gray color (e.g., text-gray-600)
  - [ ] Add icons/badges (optional):
    - [ ] Over estimate: ⚠️ or ↑ icon
    - [ ] Under estimate: ✓ or ↓ icon
    - [ ] On track: ✓ icon
  - [ ] Ensure visual indicators are accessible (ARIA labels, not color-only)
  - [ ] Style indicators consistently

- [ ] Task 5: Integrate TimeEstimateDisplay into TaskCard (AC: 2, 4, 8)
  - [ ] Update `src/components/kanban/TaskCard.tsx`
  - [ ] Import TimeEstimateDisplay component
  - [ ] Add TimeEstimateDisplay to TaskCard layout
  - [ ] Position estimate display appropriately (e.g., near TimerDisplay)
  - [ ] Pass task prop with timeEstimate and totalTime
  - [ ] Ensure estimate display doesn't clutter card design
  - [ ] Ensure estimate display is visible but not dominant
  - [ ] Style consistently with TaskCard design

- [ ] Task 6: Load total time for estimate comparison (AC: 2, 4)
  - [ ] Ensure TaskCard has access to total time (from Story 2.2)
  - [ ] Use TimeEntryRepository.getTotalTimeForTask() to get actual time
  - [ ] Pass total time to TimeEstimateDisplay
  - [ ] Handle loading state while fetching total time
  - [ ] Update estimate display when total time changes

- [ ] Task 7: Make time estimate editable from TaskCard (AC: 5)
  - [ ] Add "Edit Estimate" button/icon to TaskCard (optional, can be in detail view)
  - [ ] Or allow inline editing (click to edit)
  - [ ] Open TaskForm in edit mode with timeEstimate pre-populated
  - [ ] Or create quick edit modal for time estimate only
  - [ ] Update task.timeEstimate via TaskContext.updateTask()
  - [ ] Ensure estimate updates immediately on TaskCard
  - [ ] Handle errors gracefully

- [ ] Task 8: Add time estimate to task creation flow (AC: 1, 6)
  - [ ] Ensure TaskForm includes time estimate input (from Task 1)
  - [ ] Ensure timeEstimate is included in task creation data
  - [ ] Ensure timeEstimate is saved to IndexedDB via TaskRepository
  - [ ] Test task creation with time estimate
  - [ ] Test task creation without time estimate (should be null)

- [ ] Task 9: Update TaskForm to handle time estimate editing (AC: 5, 6)
  - [ ] Ensure TaskForm accepts optional task prop (for edit mode)
  - [ ] Pre-populate time estimate fields when editing
  - [ ] Convert timeEstimate (minutes) to hours + minutes for display
  - [ ] Handle clearing time estimate (set to null)
  - [ ] Ensure updateTask includes timeEstimate in updates
  - [ ] Test editing time estimate

- [ ] Task 10: Create estimate comparison utility functions (AC: 3, 9)
  - [ ] Create `src/utils/estimateUtils.ts`
  - [ ] Implement `calculateEstimateComparison(estimate: number, actual: number)`
  - [ ] Implement `getEstimateStatus(estimate: number, actual: number, threshold?: number)`
  - [ ] Implement `formatEstimateComparison(estimate: number, actual: number): string`
  - [ ] Add helper functions for percentage calculation
  - [ ] Add JSDoc comments
  - [ ] Write unit tests

- [ ] Task 11: Add estimate comparison threshold configuration (AC: 3, 9)
  - [ ] Define threshold for "on-track" status (e.g., ±5% or ±10 minutes)
  - [ ] Make threshold configurable (can be hardcoded for MVP)
  - [ ] Use threshold in estimate comparison calculation
  - [ ] Document threshold value
  - [ ] Consider making threshold user-configurable (future enhancement)

- [ ] Task 12: Ensure estimate format consistency (AC: 7)
  - [ ] Use formatDuration utility for estimate display (from Story 2.2)
  - [ ] Use formatDuration utility for actual time display
  - [ ] Ensure both use same format: "1h 23m" or "83m"
  - [ ] Test format consistency across all displays
  - [ ] Ensure format matches TimerDisplay format

- [ ] Task 13: Handle edge cases gracefully (AC: 8)
  - [ ] Handle task without estimate (don't show estimate section)
  - [ ] Handle task with estimate but no actual time (show estimate only)
  - [ ] Handle estimate = 0 (treat as no estimate or show "0m")
  - [ ] Handle very large estimates/actual times
  - [ ] Handle negative values (shouldn't happen, but validate)
  - [ ] Ensure graceful degradation

- [ ] Task 14: Add accessibility to estimate display (AC: 3, 4)
  - [ ] Add ARIA labels to estimate display
  - [ ] Ensure visual indicators have text alternatives
  - [ ] Announce estimate comparison to screen readers
  - [ ] Ensure color coding isn't the only indicator
  - [ ] Test with screen reader

- [ ] Task 15: Unit tests for estimate utilities (AC: 3, 9)
  - [ ] Create `tests/unit/utils/estimateUtils.test.ts`
  - [ ] Test calculateEstimateComparison with various inputs
  - [ ] Test getEstimateStatus (over, under, on-track)
  - [ ] Test formatEstimateComparison
  - [ ] Test edge cases (0 values, large values, negative values)
  - [ ] Test threshold logic

- [ ] Task 16: Unit tests for TimeEstimateDisplay component (AC: 2, 3, 4, 7, 8)
  - [ ] Create `tests/unit/components/timer/TimeEstimateDisplay.test.tsx`
  - [ ] Test rendering with estimate and actual time
  - [ ] Test rendering without estimate
  - [ ] Test visual indicators (over, under, on-track)
  - [ ] Test format consistency
  - [ ] Test accessibility (ARIA labels)
  - [ ] Mock formatDuration utility

- [ ] Task 17: Unit tests for TaskForm time estimate (AC: 1, 5, 6)
  - [ ] Update `tests/unit/components/task/TaskForm.test.tsx`
  - [ ] Test time estimate input rendering
  - [ ] Test time estimate input validation
  - [ ] Test time estimate conversion (hours + minutes to minutes)
  - [ ] Test time estimate pre-population in edit mode
  - [ ] Test clearing time estimate

- [ ] Task 18: Integration tests for estimate workflow (AC: 1-10)
  - [ ] Create `tests/integration/TimeEstimateWorkflow.test.tsx`
  - [ ] Test complete workflow: Create task with estimate → Track time → See comparison
  - [ ] Test editing time estimate
  - [ ] Test estimate display updates when actual time changes
  - [ ] Test visual indicators change based on comparison
  - [ ] Use React Testing Library

- [ ] Task 19: Code quality and accessibility review (AC: 1-10)
  - [ ] Ensure all components use TypeScript (no `any`)
  - [ ] Add ARIA labels to estimate inputs and displays
  - [ ] Ensure semantic HTML structure
  - [ ] Test with screen reader
  - [ ] Ensure visual indicators are accessible
  - [ ] Add JSDoc comments to utilities and components
  - [ ] Run linter and fix any issues
  - [ ] Ensure code follows component template pattern
  - [ ] Verify all acceptance criteria are met

## Dev Notes

### Previous Story Insights
[Source: Story 1.5, Story 2.1, Story 2.2]

**Key Learnings from Story 1.5:**
- TaskForm component exists for task creation/editing
- TaskForm follows form validation patterns
- TaskContext.updateTask() can update task fields
- Task model already includes timeEstimate field (number | null, in minutes)

**Key Learnings from Story 2.1:**
- TimerContext manages timer state
- TimerService handles timer operations
- TimeEntryRepository manages time entries

**Key Learnings from Story 2.2:**
- TimerDisplay component displays elapsed and total time
- formatDuration utility formats time as "1h 23m" or "83m"
- TimeEntryRepository.getTotalTimeForTask() calculates total time spent
- Total time is displayed on TaskCard

**Important Notes:**
- Task.timeEstimate field already exists in data model (from Story 1.2)
- TaskForm currently sets timeEstimate to null (needs update)
- Need to add time estimate input to TaskForm
- Need to display estimate on TaskCard alongside actual time
- Need to calculate and display comparison

### Data Models
[Source: architecture/common/data-models.md#task, src/types/task.ts]

**Task Interface (already includes timeEstimate):**
```typescript
interface Task {
  id: string;
  title: string;
  description?: string;
  columnId: string;
  position: number;
  clientId: string | null;
  projectId: string | null;
  isBillable: boolean;
  hourlyRate: number | null;
  timeEstimate: number | null; // in minutes - ALREADY EXISTS
  dueDate: Date | null;
  priority: 'low' | 'medium' | 'high' | null;
  tags: string[];
  createdAt: Date;
  updatedAt: Date;
}
```

**Key Attributes for Story 2.6:**
- `timeEstimate`: number | null - Estimated time in minutes (already in model)
- `timeEstimate` is stored with task data in IndexedDB
- `timeEstimate` can be updated via TaskContext.updateTask()

### Time Estimate Input Format
[Source: Epic 2 AC 1, TaskForm patterns]

**Input Options:**
- Option A: Hours + Minutes inputs (separate fields)
- Option B: Decimal hours input (e.g., 1.5 for 1h 30m)
- Option C: Single minutes input (simple but less user-friendly)

**Recommended: Hours + Minutes**
- More intuitive for users
- Matches actual time display format
- Easier to validate
- Consistent with time entry form (from Story 2.3)

**Conversion:**
- User input: hours (H) + minutes (M)
- Storage: totalMinutes = (H * 60) + M
- Display: Use formatDuration(totalMinutes) → "1h 30m"

### Estimate Comparison Logic
[Source: Epic 2 AC 3, 4, 9]

**Comparison Calculation:**
- Difference: actualTime - estimateTime (in minutes)
- Percentage: ((actualTime - estimateTime) / estimateTime) * 100
- Status determination:
  - Over estimate: actualTime > estimateTime + threshold
  - Under estimate: actualTime < estimateTime - threshold
  - On track: within threshold (e.g., ±5% or ±10 minutes)

**Threshold:**
- Default threshold: ±5% or ±10 minutes (whichever is larger)
- Can be hardcoded for MVP
- Future enhancement: user-configurable threshold

**Example:**
- Estimate: 60 minutes (1h)
- Actual: 75 minutes (1h 15m)
- Difference: +15 minutes
- Percentage: +25%
- Status: Over estimate (if threshold is 5% or 10 minutes)

### Visual Indicators
[Source: Epic 2 AC 3, 4, accessibility requirements]

**Color Coding:**
- Over estimate: Red/orange (e.g., `text-red-600`, `bg-red-50`)
- Under estimate: Green (e.g., `text-green-600`, `bg-green-50`)
- On track: Default/gray (e.g., `text-gray-600`, `bg-gray-50`)

**Icons/Badges (Optional):**
- Over estimate: ⚠️ warning icon or ↑ up arrow
- Under estimate: ✓ check icon or ↓ down arrow
- On track: ✓ check icon or = equals icon

**Accessibility:**
- Don't rely solely on color (use icons/text as well)
- Add ARIA labels: "Over estimate by 15 minutes" or "Under estimate by 10 minutes"
- Ensure sufficient color contrast (WCAG AA)

### Component Architecture
[Source: architecture/common/frontend-architecture.md#component-architecture]

**TimeEstimateDisplay Component:**
- Location: `src/components/timer/TimeEstimateDisplay.tsx`
- Props: `task: Task` (with timeEstimate) and `totalTime: number` (actual time in minutes)
- Uses: formatDuration utility, estimateUtils
- Styling: Tailwind CSS (consistent with TimerDisplay)
- Accessibility: ARIA labels, semantic HTML

**Component Template Pattern:**
```typescript
import React from 'react';
import { Task } from '@/types/task';
import { formatDuration } from '@/utils/timeUtils';
import { calculateEstimateComparison } from '@/utils/estimateUtils';

interface TimeEstimateDisplayProps {
  task: Task;
  totalTime: number; // actual time in minutes
}

export const TimeEstimateDisplay: React.FC<TimeEstimateDisplayProps> = ({ 
  task, 
  totalTime 
}) => {
  if (!task.timeEstimate) {
    return null; // Don't show if no estimate
  }
  
  const comparison = calculateEstimateComparison(task.timeEstimate, totalTime);
  
  // Component logic
  
  return (
    <div className="..." aria-label={`Estimate: ${formatDuration(task.timeEstimate)}, Actual: ${formatDuration(totalTime)}`}>
      {/* JSX */}
    </div>
  );
};
```

### Form Integration
[Source: Story 1.5, TaskForm.tsx]

**TaskForm Updates:**
- Add time estimate input fields (hours, minutes)
- Add form state: `const [estimateHours, setEstimateHours] = useState<number>(0);`
- Add form state: `const [estimateMinutes, setEstimateMinutes] = useState<number>(0);`
- Convert to minutes: `timeEstimate = (estimateHours * 60) + estimateMinutes`
- Pre-populate when editing: Convert `task.timeEstimate` (minutes) to hours + minutes
- Include in task data: `timeEstimate: timeEstimate || null`

**Form Validation:**
- Hours: >= 0, integer
- Minutes: >= 0 and < 60, integer
- At least one of hours or minutes > 0 (or allow 0 to clear estimate)

### Display Format
[Source: Story 2.2, formatDuration utility]

**Format Consistency:**
- Use formatDuration utility for both estimate and actual time
- Format: "1h 23m" for hours+minutes, "83m" for minutes only
- Display comparison: "Est: 1h 30m | Actual: 2h 15m"
- Or: "1h 30m / 2h 15m" (estimate / actual)

**Visual Layout:**
- Option A: Side by side: "Est: 1h 30m | Actual: 2h 15m"
- Option B: Stacked: "Est: 1h 30m" on one line, "Actual: 2h 15m" on next
- Option C: Combined: "1h 30m / 2h 15m" with visual indicator

### File Locations
[Source: architecture/unified-project-structure.md, Story 2.2]

**New Files to Create:**
- `src/components/timer/TimeEstimateDisplay.tsx` - Estimate display component
- `src/utils/estimateUtils.ts` - Estimate comparison utilities
- `tests/unit/utils/estimateUtils.test.ts` - Utility tests
- `tests/unit/components/timer/TimeEstimateDisplay.test.tsx` - Component tests
- `tests/integration/TimeEstimateWorkflow.test.tsx` - Integration tests

**Files to Modify:**
- `src/components/task/TaskForm.tsx` - Add time estimate input
- `src/components/kanban/TaskCard.tsx` - Add TimeEstimateDisplay
- `tests/unit/components/task/TaskForm.test.tsx` - Add time estimate tests

### Testing Requirements
[Source: architecture/common/testing-strategy.md]

**Unit Tests:**
- estimateUtils: Comparison calculation, status determination, formatting
- TimeEstimateDisplay: Rendering, visual indicators, edge cases
- TaskForm: Time estimate input, validation, conversion

**Integration Tests:**
- Complete workflow: Create task with estimate → Track time → See comparison
- Editing time estimate
- Estimate display updates when actual time changes

**Test Organization:**
- Unit tests: `tests/unit/utils/`, `tests/unit/components/timer/`, `tests/unit/components/task/`
- Integration tests: `tests/integration/TimeEstimateWorkflow.test.tsx`
- Use Jest + React Testing Library
- Mock formatDuration utility

**Test Examples:**
```typescript
// estimateUtils test example
describe('calculateEstimateComparison', () => {
  it('calculates over estimate correctly', () => {
    const result = calculateEstimateComparison(60, 75);
    expect(result.status).toBe('over');
    expect(result.difference).toBe(15);
    expect(result.percentage).toBe(25);
  });
});
```

### Accessibility Requirements
[Source: architecture/common/accessibility-implementation.md]

**WCAG 2.1 AA Compliance:**
- Form inputs: All inputs have labels, error messages are announced
- Visual indicators: Don't rely solely on color (use icons/text)
- Screen reader support: Estimate comparison is announced clearly
- ARIA labels: Add proper ARIA labels to estimate display

**Accessibility Checklist:**
- [ ] Time estimate inputs have proper labels
- [ ] Visual indicators have text alternatives
- [ ] Estimate comparison is announced by screen readers
- [ ] Color coding isn't the only indicator
- [ ] Sufficient color contrast

### Coding Standards
[Source: architecture/common/coding-standards.md]

**Critical Rules:**
- Type Safety: Always use TypeScript types/interfaces, avoid `any`
- Component Organization: One component per file, co-locate related components
- Form Validation: Validate on submit, show inline error messages
- Format Consistency: Use formatDuration utility for all time displays
- Accessibility: All interactive elements must have ARIA labels

**Naming Conventions:**
- Components: PascalCase (e.g., `TimeEstimateDisplay.tsx`)
- Utilities: camelCase (e.g., `estimateUtils.ts`, `calculateEstimateComparison`)
- Functions: camelCase (e.g., `getEstimateStatus`)

### Project Structure Notes
[Source: architecture/unified-project-structure.md]

**Component Organization:**
- Timer components go in `src/components/timer/` directory
- Timer utilities go in `src/utils/` directory
- Task form updates go in `src/components/task/` directory

**Integration Points:**
- TimeEstimateDisplay integrates into TaskCard (from Story 1.5)
- TimeEstimateDisplay uses formatDuration utility (from Story 2.2)
- TimeEstimateDisplay uses totalTime from TimeEntryRepository (from Story 2.2)
- TaskForm updates build on existing form (from Story 1.5)

### Testing
[Source: architecture/common/testing-strategy.md]

**Test File Location:**
- Unit tests: `tests/unit/utils/`, `tests/unit/components/timer/`, `tests/unit/components/task/`
- Integration tests: `tests/integration/`

**Test Standards:**
- Use Jest ^29.7.0 for unit testing
- Use React Testing Library ^14.0.0 for component testing
- Follow Arrange-Act-Assert pattern
- Mock formatDuration utility
- Test accessibility (ARIA labels, screen reader)

**Specific Test Requirements:**
- Test estimate comparison calculation
- Test visual indicators (over, under, on-track)
- Test format consistency
- Test edge cases (no estimate, 0 values, large values)
- Test form input and validation
- Test estimate editing

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | Initial story draft created | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
