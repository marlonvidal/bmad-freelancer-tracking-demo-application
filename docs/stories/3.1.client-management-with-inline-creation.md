# Story 3.1: Client Management with Inline Creation

## Status
Draft

## Story
**As a** user,
**I want** to create and manage clients directly from the kanban board,
**so that** I can organize my tasks by client without navigating to separate screens.

## Acceptance Criteria

1. Task creation/edit provides dropdown/selector for client assignment
2. Dropdown includes "Create New Client" option that opens inline form
3. Inline client creation form collects: name (required), default hourly rate (optional), contact info (optional)
4. New client is saved to IndexedDB immediately upon creation
5. Client appears in dropdown immediately after creation (no refresh needed)
6. Client list is accessible from task creation/edit interface
7. User can edit existing clients (name, rate, contact info) via inline edit or settings
8. Clients are displayed in alphabetical order in dropdowns
9. Client data persists across browser sessions
10. Client deletion is prevented if tasks are assigned to that client (with warning message)

## Tasks / Subtasks

- [ ] Task 1: Create ClientSelector component with inline creation (AC: 1, 2, 3, 4, 5, 6, 8)
  - [ ] Create `src/components/client/ClientSelector.tsx`
  - [ ] Implement dropdown/select UI for client selection
  - [ ] Add "Create New Client" option at top of dropdown
  - [ ] Create inline form modal/dialog that opens when "Create New Client" is selected
  - [ ] Form fields: name (required, text input), defaultHourlyRate (optional, number input), contactInfo (optional, textarea)
  - [ ] Form validation: name is required, rate must be positive number if provided
  - [ ] On form submit, call ClientRepository.create() to save to IndexedDB
  - [ ] After creation, immediately update dropdown to include new client (optimistic update)
  - [ ] Sort clients alphabetically by name in dropdown
  - [ ] Handle loading and error states appropriately
  - [ ] Ensure keyboard navigation support (ARIA labels, focus management)

- [ ] Task 2: Integrate ClientSelector into TaskForm (AC: 1, 6)
  - [ ] Update `src/components/task/TaskForm.tsx`
  - [ ] Add clientId state to form
  - [ ] Import and render ClientSelector component
  - [ ] Handle client selection change and update form state
  - [ ] Pre-populate selected client when editing existing task (if task.clientId exists)
  - [ ] Include clientId in form submission data
  - [ ] Ensure form layout accommodates ClientSelector appropriately

- [ ] Task 3: Create ClientContext for state management (AC: 5, 9)
  - [ ] Create `src/contexts/ClientContext.tsx`
  - [ ] Implement ClientContextProvider with React Context API
  - [ ] Manage clients state array
  - [ ] Provide methods: getAllClients(), createClient(), updateClient(), deleteClient()
  - [ ] Load clients from IndexedDB on context initialization
  - [ ] Update context state optimistically when clients are created/updated/deleted
  - [ ] Ensure context updates trigger re-renders in consuming components
  - [ ] Handle error states and provide error handling

- [ ] Task 4: Implement client editing functionality (AC: 7)
  - [ ] Create `src/components/client/ClientForm.tsx` (reusable for create/edit)
  - [ ] Support both create and edit modes via props
  - [ ] Pre-populate form fields when editing existing client
  - [ ] Update ClientSelector to support inline editing (edit button/icon next to each client)
  - [ ] On edit, open same inline form with pre-filled data
  - [ ] On save, call ClientRepository.update() to persist changes
  - [ ] Update ClientContext state after successful edit
  - [ ] Ensure form validation works for both create and edit modes

- [ ] Task 5: Implement client deletion with task assignment check (AC: 10)
  - [ ] Update ClientRepository.delete() or create deleteWithValidation() method
  - [ ] Before deletion, query TaskRepository to check if any tasks have clientId matching client to delete
  - [ ] If tasks found, prevent deletion and show warning message: "Cannot delete client. {count} task(s) are assigned to this client."
  - [ ] Create confirmation dialog component or use existing ConfirmDialog
  - [ ] Show confirmation dialog before deletion (even if no tasks assigned)
  - [ ] Only proceed with deletion if user confirms
  - [ ] Update ClientContext state after successful deletion
  - [ ] Handle error cases appropriately

- [ ] Task 6: Update database schema if needed (AC: 4, 9)
  - [ ] Verify `src/services/data/database.ts` includes clients table in schema
  - [ ] Ensure clients table has proper indexes: 'id, name, createdAt' [Source: architecture/common/database-schema.md#dexiejs-schema-definition]
  - [ ] Verify ClientRepository uses correct table name and structure
  - [ ] Test that client data persists across browser sessions (close and reopen browser)
  - [ ] Ensure createdAt and updatedAt timestamps are properly set

- [ ] Task 7: Add unit tests for ClientSelector component (AC: 1-6, 8)
  - [ ] Create `tests/unit/components/client/ClientSelector.test.tsx`
  - [ ] Test rendering of dropdown with client list
  - [ ] Test "Create New Client" option opens inline form
  - [ ] Test form validation (name required, rate optional)
  - [ ] Test successful client creation updates dropdown immediately
  - [ ] Test clients are sorted alphabetically
  - [ ] Test keyboard navigation and accessibility
  - [ ] Test error handling (failed creation, network errors)
  - [ ] Mock ClientContext and ClientRepository appropriately

- [ ] Task 8: Add unit tests for ClientContext (AC: 5, 9)
  - [ ] Create `tests/unit/contexts/ClientContext.test.tsx`
  - [ ] Test initial load of clients from IndexedDB
  - [ ] Test createClient() updates state and IndexedDB
  - [ ] Test updateClient() updates state and IndexedDB
  - [ ] Test deleteClient() updates state and IndexedDB
  - [ ] Test error handling for failed operations
  - [ ] Mock IndexedDB/Dexie appropriately

- [ ] Task 9: Add unit tests for ClientRepository (AC: 4, 9)
  - [ ] Create `tests/unit/services/data/repositories/ClientRepository.test.ts`
  - [ ] Test create() saves client to IndexedDB with correct structure
  - [ ] Test getAll() retrieves all clients
  - [ ] Test getById() retrieves specific client
  - [ ] Test update() modifies existing client
  - [ ] Test delete() removes client from IndexedDB
  - [ ] Test error handling (QuotaExceededError, not found errors)
  - [ ] Test createdAt and updatedAt timestamps are set correctly

- [ ] Task 10: Add integration tests for client management workflow (AC: 1-10)
  - [ ] Create `tests/integration/client-management.test.tsx`
  - [ ] Test complete workflow: create client from TaskForm → assign to task → verify persistence
  - [ ] Test edit client from dropdown → verify changes persist
  - [ ] Test delete client with no tasks → verify deletion succeeds
  - [ ] Test delete client with tasks → verify deletion prevented with warning
  - [ ] Test client list persists across page refresh
  - [ ] Use React Testing Library for component integration testing

- [ ] Task 11: Update Task type and TaskRepository if needed (AC: 1)
  - [ ] Verify `src/types/task.ts` includes `clientId: string | null` field [Source: architecture/common/data-models.md#task]
  - [ ] Verify TaskRepository supports filtering/querying by clientId
  - [ ] Ensure TaskRepository.update() can update clientId field
  - [ ] Test task-client relationship works correctly

## Dev Notes

### Previous Story Insights

From Story 2.6 (Time Estimates), key learnings:
- Form components should use controlled inputs with proper state management
- Inline forms work well with modal/dialog patterns
- Optimistic updates improve perceived performance
- Proper error handling and user feedback is critical
- Test coverage should target 80%+ for new components

### Data Models

**Client Model:**
```typescript
interface Client {
  id: string;                    // UUID, auto-generated
  name: string;                  // Required, client name
  defaultHourlyRate: number | null;  // Optional, default hourly rate
  contactInfo: string | null;     // Optional, contact information
  createdAt: Date;               // Auto-generated timestamp
  updatedAt: Date;               // Auto-generated timestamp
}
```
[Source: architecture/common/data-models.md#client]

**Task Model (relevant fields):**
```typescript
interface Task {
  // ... other fields
  clientId: string | null;       // Reference to assigned client (optional)
  // ... other fields
}
```
[Source: architecture/common/data-models.md#task]

**Database Schema:**
- Clients table: `'id, name, createdAt'` indexes
- Tasks table includes `clientId` index for efficient filtering
[Source: architecture/common/database-schema.md#dexiejs-schema-definition]

### API Specifications

**ClientRepository Methods:**
- `create(client: Omit<Client, 'id' | 'createdAt' | 'updatedAt'>): Promise<Client>`
- `getAll(): Promise<Client[]>`
- `getById(id: string): Promise<Client | undefined>`
- `update(id: string, updates: Partial<Client>): Promise<Client>`
- `delete(id: string): Promise<void>`

**TaskRepository Methods (for deletion validation):**
- `getByClientId(clientId: string): Promise<Task[]>` - Query tasks assigned to a client

[Source: architecture/components.md#data-access-layer]

### Component Specifications

**ClientSelector Component:**
- Location: `src/components/client/ClientSelector.tsx`
- Props: `value?: string` (selected clientId), `onChange: (clientId: string | null) => void`, `onCreateNew?: () => void`
- Should render as dropdown/select element
- Includes "Create New Client" option at top
- Displays clients alphabetically sorted
- Supports keyboard navigation (ARIA labels, focus management)

**ClientForm Component:**
- Location: `src/components/client/ClientForm.tsx`
- Props: `client?: Client` (for edit mode), `onSubmit: (clientData) => Promise<void>`, `onCancel: () => void`
- Form fields: name (required), defaultHourlyRate (optional), contactInfo (optional)
- Validation: name required, rate must be positive number if provided
- Can be used in modal/dialog for inline creation

**ClientContext:**
- Location: `src/components/contexts/ClientContext.tsx`
- Provides: `clients: Client[]`, `getAllClients()`, `createClient()`, `updateClient()`, `deleteClient()`
- Uses React Context API for state management
- Loads clients from IndexedDB on initialization
- Updates state optimistically on mutations

[Source: architecture/common/frontend-architecture.md#component-architecture]

### File Locations

Based on project structure:
- Components: `src/components/client/` (new directory)
- Context: `src/contexts/ClientContext.tsx` (new file)
- Repository: `src/services/data/repositories/ClientRepository.ts` (already exists)
- Types: `src/types/client.ts` (already exists)
- Tests: `tests/unit/components/client/`, `tests/unit/contexts/`, `tests/integration/`

[Source: architecture/unified-project-structure.md]

### Testing Requirements

**Unit Tests:**
- Component tests: ClientSelector, ClientForm (React Testing Library)
- Context tests: ClientContext (mock IndexedDB)
- Repository tests: ClientRepository (mock Dexie)
- Target: 80%+ code coverage

**Integration Tests:**
- Complete client management workflow
- Client creation → assignment → persistence
- Client deletion validation with tasks

**Test Organization:**
- Unit tests: `tests/unit/components/client/`, `tests/unit/contexts/`, `tests/unit/services/data/repositories/`
- Integration tests: `tests/integration/client-management.test.tsx`

[Source: architecture/common/testing-strategy.md]

### Technical Constraints

**Coding Standards:**
- Use TypeScript with strict types (no `any`)
- One component per file
- Use Context API for state management (avoid prop drilling)
- Always use repository pattern (never access IndexedDB directly from components)
- All async operations must have try/catch error handling
- Use React.memo, useMemo, useCallback appropriately for performance
- All interactive elements must have ARIA labels and keyboard navigation support

**Error Handling:**
- Catch QuotaExceededError and provide user-friendly message
- Handle "not found" errors gracefully
- Show loading states during async operations
- Provide user feedback on success/error

**Performance:**
- Optimistic updates for immediate UI feedback
- Sort clients client-side (small dataset, alphabetical)
- Use React.memo on ClientSelector if needed to prevent unnecessary re-renders

[Source: architecture/common/coding-standards.md]

### Project Structure Notes

The project structure already includes:
- `src/services/data/repositories/ClientRepository.ts` - Repository exists
- `src/types/client.ts` - Client type exists
- Database schema includes clients table

New components need to be created:
- `src/components/client/` directory (new)
- `src/components/client/ClientSelector.tsx` (new)
- `src/components/client/ClientForm.tsx` (new)
- `src/contexts/ClientContext.tsx` (new)

[Source: architecture/unified-project-structure.md]

### Additional Considerations

**Deletion Validation:**
- Before deleting a client, check if any tasks reference that client
- Query: `db.tasks.where('clientId').equals(clientId).count() > 0`
- If tasks exist, show warning and prevent deletion
- Use existing ConfirmDialog component or create new one

**Alphabetical Sorting:**
- Sort clients by `name` field alphabetically (case-insensitive)
- Use JavaScript `Array.sort()` with localeCompare for proper sorting
- Apply sorting in ClientContext.getAllClients() or ClientSelector component

**Inline Form Pattern:**
- Use modal/dialog pattern similar to TaskCreationModal
- Form should be accessible (keyboard navigation, ARIA labels)
- Form should close on successful submission or cancel
- Form should handle validation errors appropriately

## Testing

### Testing Standards

**Test File Location:**
- Unit tests: `tests/unit/components/client/`, `tests/unit/contexts/`, `tests/unit/services/data/repositories/`
- Integration tests: `tests/integration/`

**Testing Frameworks:**
- Jest ^29.7.0 for unit tests
- React Testing Library ^14.0.0 for component tests
- Mock Dexie/IndexedDB for repository tests

**Test Patterns:**
- Use `render`, `screen`, `fireEvent` from React Testing Library
- Mock Context providers when testing components
- Mock IndexedDB operations when testing repositories
- Test user interactions, not implementation details
- Aim for 80%+ code coverage

**Specific Test Requirements:**
- Test all form validations (name required, rate optional)
- Test client creation updates UI immediately (optimistic update)
- Test alphabetical sorting of clients
- Test deletion prevention when tasks are assigned
- Test error handling (QuotaExceededError, network errors)
- Test keyboard navigation and accessibility
- Test data persistence across browser sessions

[Source: architecture/common/testing-strategy.md]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-23 | 1.0 | Initial story draft | Scrum Master |

## Dev Agent Record

### Agent Model Used
_TBD - To be filled by Dev Agent_

### Debug Log References
_TBD - To be filled by Dev Agent_

### Completion Notes List
_TBD - To be filled by Dev Agent_

### File List
_TBD - To be filled by Dev Agent_

## QA Results
_TBD - To be filled by QA Agent_
