# Story 3.2: Project Management with Inline Creation

## Status
Draft

## Story
**As a** user,
**I want** to create and manage projects and assign tasks to projects,
**so that** I can organize tasks within client work.

## Acceptance Criteria

1. Task creation/edit provides dropdown/selector for project assignment
2. Projects are scoped to clients (select client first, then project)
3. Dropdown includes "Create New Project" option that opens inline form
4. Inline project creation form collects: name (required), optional description
5. New project is saved to IndexedDB immediately upon creation
6. Project appears in dropdown immediately after creation
7. User can edit existing projects (name, description) via inline edit
8. Projects are displayed in alphabetical order within client grouping
9. Project data persists across browser sessions
10. Project deletion is prevented if tasks are assigned to that project (with warning message)

## Tasks / Subtasks

- [ ] Task 1: Create ProjectSelector component with client-scoped selection (AC: 1, 2, 3, 6, 8)
  - [ ] Create `src/components/project/ProjectSelector.tsx`
  - [ ] Accept `clientId: string | null` prop (required for project selection)
  - [ ] When clientId is null, show disabled state with message "Select a client first"
  - [ ] When clientId is provided, load and display projects for that client
  - [ ] Implement dropdown/select UI for project selection
  - [ ] Add "Create New Project" option at top of dropdown (only when clientId is set)
  - [ ] Create inline form modal/dialog that opens when "Create New Project" is selected
  - [ ] Form fields: name (required, text input), description (optional, textarea)
  - [ ] Form validation: name is required, clientId must be set (from props)
  - [ ] On form submit, call ProjectRepository.create() with clientId to save to IndexedDB
  - [ ] After creation, immediately update dropdown to include new project (optimistic update)
  - [ ] Sort projects alphabetically by name within client grouping
  - [ ] Handle loading and error states appropriately
  - [ ] Ensure keyboard navigation support (ARIA labels, focus management)
  - [ ] Update project list when clientId prop changes

- [ ] Task 2: Integrate ProjectSelector into TaskForm with client dependency (AC: 1, 2)
  - [ ] Update `src/components/task/TaskForm.tsx`
  - [ ] Add projectId state to form
  - [ ] Import and render ProjectSelector component
  - [ ] Pass clientId from form state to ProjectSelector
  - [ ] Handle project selection change and update form state
  - [ ] Pre-populate selected project when editing existing task (if task.projectId exists)
  - [ ] When client changes, reset projectId to null (projects are client-scoped)
  - [ ] Include projectId in form submission data
  - [ ] Ensure form layout accommodates ProjectSelector appropriately
  - [ ] Show appropriate UI when no client is selected (disable project selector)

- [ ] Task 3: Create ProjectContext for state management (AC: 6, 9)
  - [ ] Create `src/contexts/ProjectContext.tsx`
  - [ ] Implement ProjectContextProvider with React Context API
  - [ ] Manage projects state array
  - [ ] Provide methods: getAllProjects(), getProjectsByClientId(clientId), createProject(), updateProject(), deleteProject()
  - [ ] Load projects from IndexedDB on context initialization
  - [ ] Update context state optimistically when projects are created/updated/deleted
  - [ ] Ensure context updates trigger re-renders in consuming components
  - [ ] Handle error states and provide error handling
  - [ ] Cache projects by clientId for efficient lookups

- [ ] Task 4: Implement project editing functionality (AC: 7)
  - [ ] Create `src/components/project/ProjectForm.tsx` (reusable for create/edit)
  - [ ] Support both create and edit modes via props
  - [ ] Accept clientId prop (required for create, read-only for edit)
  - [ ] Pre-populate form fields when editing existing project
  - [ ] Form fields: name (required), description (optional)
  - [ ] Update ProjectSelector to support inline editing (edit button/icon next to each project)
  - [ ] On edit, open same inline form with pre-filled data
  - [ ] On save, call ProjectRepository.update() to persist changes
  - [ ] Update ProjectContext state after successful edit
  - [ ] Ensure form validation works for both create and edit modes
  - [ ] Prevent changing clientId when editing (projects are client-scoped)

- [ ] Task 5: Implement project deletion with task assignment check (AC: 10)
  - [ ] Update ProjectRepository.delete() or create deleteWithValidation() method
  - [ ] Before deletion, query TaskRepository to check if any tasks have projectId matching project to delete
  - [ ] If tasks found, prevent deletion and show warning message: "Cannot delete project. {count} task(s) are assigned to this project."
  - [ ] Use existing ConfirmDialog component for confirmation
  - [ ] Show confirmation dialog before deletion (even if no tasks assigned)
  - [ ] Only proceed with deletion if user confirms
  - [ ] Update ProjectContext state after successful deletion
  - [ ] Handle error cases appropriately

- [ ] Task 6: Verify database schema and project-client relationship (AC: 5, 9)
  - [ ] Verify `src/services/data/database.ts` includes projects table in schema
  - [ ] Ensure projects table has proper indexes: 'id, clientId, name, [clientId+name]' [Source: architecture/common/database-schema.md#dexiejs-schema-definition]
  - [ ] Verify ProjectRepository uses correct table name and structure
  - [ ] Verify ProjectRepository.create() validates clientId exists (already implemented)
  - [ ] Test that project data persists across browser sessions (close and reopen browser)
  - [ ] Ensure createdAt and updatedAt timestamps are properly set
  - [ ] Verify compound index [clientId+name] ensures unique project names per client

- [ ] Task 7: Add unit tests for ProjectSelector component (AC: 1-3, 6, 8)
  - [ ] Create `tests/unit/components/project/ProjectSelector.test.tsx`
  - [ ] Test rendering when clientId is null (shows disabled state)
  - [ ] Test rendering of dropdown with project list when clientId is set
  - [ ] Test "Create New Project" option opens inline form (only when clientId is set)
  - [ ] Test form validation (name required, clientId must be set)
  - [ ] Test successful project creation updates dropdown immediately
  - [ ] Test projects are sorted alphabetically within client
  - [ ] Test project list updates when clientId prop changes
  - [ ] Test keyboard navigation and accessibility
  - [ ] Test error handling (failed creation, invalid clientId)
  - [ ] Mock ProjectContext and ProjectRepository appropriately

- [ ] Task 8: Add unit tests for ProjectContext (AC: 6, 9)
  - [ ] Create `tests/unit/contexts/ProjectContext.test.tsx`
  - [ ] Test initial load of projects from IndexedDB
  - [ ] Test getProjectsByClientId() filters projects correctly
  - [ ] Test createProject() updates state and IndexedDB
  - [ ] Test updateProject() updates state and IndexedDB
  - [ ] Test deleteProject() updates state and IndexedDB
  - [ ] Test error handling for failed operations
  - [ ] Test clientId validation in createProject()
  - [ ] Mock IndexedDB/Dexie appropriately

- [ ] Task 9: Add unit tests for ProjectRepository (AC: 5, 9)
  - [ ] Create `tests/unit/services/data/repositories/ProjectRepository.test.ts`
  - [ ] Test create() saves project to IndexedDB with correct structure
  - [ ] Test create() validates clientId exists (throws error if client not found)
  - [ ] Test getAll() retrieves all projects
  - [ ] Test getById() retrieves specific project
  - [ ] Test getByClientId() retrieves projects for specific client
  - [ ] Test update() modifies existing project
  - [ ] Test update() validates clientId if being changed
  - [ ] Test delete() removes project from IndexedDB
  - [ ] Test error handling (QuotaExceededError, not found errors, invalid clientId)
  - [ ] Test createdAt and updatedAt timestamps are set correctly

- [ ] Task 10: Add integration tests for project management workflow (AC: 1-10)
  - [ ] Create `tests/integration/project-management.test.tsx`
  - [ ] Test complete workflow: select client → create project → assign to task → verify persistence
  - [ ] Test project selector is disabled when no client selected
  - [ ] Test project list updates when client changes
  - [ ] Test edit project from dropdown → verify changes persist
  - [ ] Test delete project with no tasks → verify deletion succeeds
  - [ ] Test delete project with tasks → verify deletion prevented with warning
  - [ ] Test project list persists across page refresh
  - [ ] Test projects are scoped to clients (cannot select project from different client)
  - [ ] Use React Testing Library for component integration testing

- [ ] Task 11: Update Task type and TaskRepository if needed (AC: 1)
  - [ ] Verify `src/types/task.ts` includes `projectId: string | null` field [Source: architecture/common/data-models.md#task]
  - [ ] Verify Task model enforces projectId requires clientId (project belongs to client)
  - [ ] Verify TaskRepository supports filtering/querying by projectId
  - [ ] Verify TaskRepository supports filtering by clientId and projectId together
  - [ ] Ensure TaskRepository.update() can update projectId field
  - [ ] Test task-project relationship works correctly
  - [ ] Test that task.projectId requires task.clientId to be set (validation)

- [ ] Task 12: Handle client-project relationship in TaskForm (AC: 2)
  - [ ] Ensure TaskForm validates projectId requires clientId
  - [ ] When clientId is cleared/changed, reset projectId to null
  - [ ] When editing task, if projectId is set, ensure clientId matches project's clientId
  - [ ] Show appropriate validation error if project doesn't belong to selected client
  - [ ] Update form submission to include both clientId and projectId

## Dev Notes

### Previous Story Insights

From Story 3.1 (Client Management), key learnings:
- Inline creation pattern works well with modal/dialog components
- Optimistic updates improve perceived performance
- Context-based state management simplifies component integration
- Alphabetical sorting improves UX for dropdowns
- Deletion validation pattern (check for assigned tasks) is reusable

**Dependency on Story 3.1:**
- Story 3.1 must be completed before this story (clients must exist before projects)
- ClientSelector component and ClientContext from 3.1 will be used in TaskForm
- ProjectSelector will depend on client selection being available

### Data Models

**Project Model:**
```typescript
interface Project {
  id: string;                    // UUID, auto-generated
  clientId: string;              // Required, reference to parent client
  name: string;                  // Required, project name
  description?: string;          // Optional, project description
  defaultHourlyRate: number | null;  // Optional, default hourly rate (for future use)
  createdAt: Date;               // Auto-generated timestamp
  updatedAt: Date;               // Auto-generated timestamp
}
```
[Source: architecture/common/data-models.md#project]

**Task Model (relevant fields):**
```typescript
interface Task {
  // ... other fields
  clientId: string | null;       // Reference to assigned client (optional)
  projectId: string | null;      // Reference to assigned project (optional, requires clientId)
  // ... other fields
}
```
[Source: architecture/common/data-models.md#task]

**Relationship Rules:**
- Projects MUST belong to a client (clientId is required)
- Tasks can have projectId ONLY if clientId is also set
- Project deletion requires checking if tasks reference the project
- Projects are scoped to clients (cannot have same project name under different clients, enforced by compound index)

**Database Schema:**
- Projects table: `'id, clientId, name, [clientId+name]'` indexes
- Compound index `[clientId+name]` ensures unique project names per client
- Tasks table includes `projectId` index for efficient filtering
[Source: architecture/common/database-schema.md#dexiejs-schema-definition]

### API Specifications

**ProjectRepository Methods:**
- `create(project: Omit<Project, 'id' | 'createdAt' | 'updatedAt'>): Promise<Project>` - Validates clientId exists
- `getAll(): Promise<Project[]>`
- `getById(id: string): Promise<Project | undefined>`
- `getByClientId(clientId: string): Promise<Project[]>` - Get all projects for a client
- `update(id: string, updates: Partial<Project>): Promise<Project>` - Validates clientId if changed
- `delete(id: string): Promise<void>`

**TaskRepository Methods (for deletion validation):**
- `getByProjectId(projectId: string): Promise<Task[]>` - Query tasks assigned to a project
- `getByClientId(clientId: string): Promise<Task[]>` - Query tasks assigned to a client

[Source: architecture/components.md#data-access-layer]

### Component Specifications

**ProjectSelector Component:**
- Location: `src/components/project/ProjectSelector.tsx`
- Props: 
  - `clientId: string | null` (required - enables/disables selector)
  - `value?: string` (selected projectId)
  - `onChange: (projectId: string | null) => void`
  - `onCreateNew?: () => void`
- Behavior:
  - When clientId is null: Shows disabled state with message "Select a client first"
  - When clientId is set: Loads and displays projects for that client
  - Includes "Create New Project" option at top (only when clientId is set)
  - Displays projects alphabetically sorted within client
  - Updates project list when clientId prop changes
- Supports keyboard navigation (ARIA labels, focus management)

**ProjectForm Component:**
- Location: `src/components/project/ProjectForm.tsx`
- Props: 
  - `clientId: string` (required for create mode)
  - `project?: Project` (for edit mode)
  - `onSubmit: (projectData) => Promise<void>`
  - `onCancel: () => void`
- Form fields: name (required), description (optional)
- Validation: name required, clientId must be set
- Can be used in modal/dialog for inline creation/editing
- In edit mode, clientId is read-only (projects cannot change clients)

**ProjectContext:**
- Location: `src/contexts/ProjectContext.tsx`
- Provides: 
  - `projects: Project[]`
  - `getAllProjects()`
  - `getProjectsByClientId(clientId: string)`
  - `createProject()`
  - `updateProject()`
  - `deleteProject()`
- Uses React Context API for state management
- Loads projects from IndexedDB on initialization
- Updates state optimistically on mutations
- Caches projects by clientId for efficient lookups

[Source: architecture/common/frontend-architecture.md#component-architecture]

### File Locations

Based on project structure:
- Components: `src/components/project/` (new directory)
- Context: `src/contexts/ProjectContext.tsx` (new file)
- Repository: `src/services/data/repositories/ProjectRepository.ts` (already exists)
- Types: `src/types/project.ts` (already exists)
- Tests: `tests/unit/components/project/`, `tests/unit/contexts/`, `tests/integration/`

[Source: architecture/unified-project-structure.md]

### Testing Requirements

**Unit Tests:**
- Component tests: ProjectSelector, ProjectForm (React Testing Library)
- Context tests: ProjectContext (mock IndexedDB)
- Repository tests: ProjectRepository (mock Dexie)
- Target: 80%+ code coverage

**Integration Tests:**
- Complete project management workflow
- Client selection → project creation → assignment → persistence
- Project deletion validation with tasks
- Client-project relationship validation

**Test Organization:**
- Unit tests: `tests/unit/components/project/`, `tests/unit/contexts/`, `tests/unit/services/data/repositories/`
- Integration tests: `tests/integration/project-management.test.tsx`

[Source: architecture/common/testing-strategy.md]

### Technical Constraints

**Coding Standards:**
- Use TypeScript with strict types (no `any`)
- One component per file
- Use Context API for state management (avoid prop drilling)
- Always use repository pattern (never access IndexedDB directly from components)
- All async operations must have try/catch error handling
- Use React.memo, useMemo, useCallback appropriately for performance
- All interactive elements must have ARIA labels and keyboard navigation support

**Error Handling:**
- Catch QuotaExceededError and provide user-friendly message
- Handle "not found" errors gracefully (client not found, project not found)
- Validate clientId exists before creating project
- Show loading states during async operations
- Provide user feedback on success/error

**Performance:**
- Optimistic updates for immediate UI feedback
- Sort projects client-side (small dataset, alphabetical)
- Cache projects by clientId in ProjectContext for efficient lookups
- Use React.memo on ProjectSelector if needed to prevent unnecessary re-renders
- Only load projects for selected client (not all projects)

**Client-Project Relationship:**
- Projects MUST have a valid clientId (enforced by ProjectRepository.create())
- ProjectSelector is disabled when clientId is null
- When client changes in TaskForm, projectId must be reset to null
- Project editing cannot change clientId (projects are client-scoped)

[Source: architecture/common/coding-standards.md]

### Project Structure Notes

The project structure already includes:
- `src/services/data/repositories/ProjectRepository.ts` - Repository exists with clientId validation
- `src/types/project.ts` - Project type exists with clientId requirement
- Database schema includes projects table with compound index

New components need to be created:
- `src/components/project/` directory (new)
- `src/components/project/ProjectSelector.tsx` (new)
- `src/components/project/ProjectForm.tsx` (new)
- `src/contexts/ProjectContext.tsx` (new)

**Dependencies:**
- Story 3.1 must be completed (ClientSelector, ClientContext)
- TaskForm will need both ClientSelector and ProjectSelector integrated

[Source: architecture/unified-project-structure.md]

### Additional Considerations

**Deletion Validation:**
- Before deleting a project, check if any tasks reference that project
- Query: `db.tasks.where('projectId').equals(projectId).count() > 0`
- If tasks exist, show warning and prevent deletion
- Use existing ConfirmDialog component (from story 3.1 or common components)

**Alphabetical Sorting:**
- Sort projects by `name` field alphabetically (case-insensitive)
- Sort within client grouping (projects for Client A, then projects for Client B)
- Use JavaScript `Array.sort()` with localeCompare for proper sorting
- Apply sorting in ProjectContext.getProjectsByClientId() or ProjectSelector component

**Inline Form Pattern:**
- Use modal/dialog pattern similar to TaskCreationModal and ClientForm (from 3.1)
- Form should be accessible (keyboard navigation, ARIA labels)
- Form should close on successful submission or cancel
- Form should handle validation errors appropriately
- Form should pre-fill clientId from props (cannot be changed in create mode)

**Client-Project Dependency:**
- ProjectSelector must be disabled when no client is selected
- Show clear message: "Select a client first" when disabled
- When client changes, reset selected project (projects are client-scoped)
- Validate that selected project belongs to selected client when editing task

**Task-Project Relationship:**
- Task.projectId requires Task.clientId to be set
- When assigning project to task, verify project belongs to selected client
- Show validation error if project doesn't match client
- Reset projectId when clientId is cleared or changed

## Testing

### Testing Standards

**Test File Location:**
- Unit tests: `tests/unit/components/project/`, `tests/unit/contexts/`, `tests/unit/services/data/repositories/`
- Integration tests: `tests/integration/`

**Testing Frameworks:**
- Jest ^29.7.0 for unit tests
- React Testing Library ^14.0.0 for component tests
- Mock Dexie/IndexedDB for repository tests

**Test Patterns:**
- Use `render`, `screen`, `fireEvent` from React Testing Library
- Mock Context providers when testing components
- Mock IndexedDB operations when testing repositories
- Test user interactions, not implementation details
- Aim for 80%+ code coverage

**Specific Test Requirements:**
- Test all form validations (name required, clientId must be set)
- Test project selector disabled state when no client selected
- Test project creation updates UI immediately (optimistic update)
- Test alphabetical sorting of projects within client
- Test project list updates when clientId changes
- Test deletion prevention when tasks are assigned
- Test clientId validation in ProjectRepository.create()
- Test error handling (QuotaExceededError, invalid clientId, not found errors)
- Test keyboard navigation and accessibility
- Test data persistence across browser sessions
- Test client-project relationship validation (project belongs to client)

[Source: architecture/common/testing-strategy.md]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-23 | 1.0 | Initial story draft | Scrum Master |

## Dev Agent Record

### Agent Model Used
_TBD - To be filled by Dev Agent_

### Debug Log References
_TBD - To be filled by Dev Agent_

### Completion Notes List
_TBD - To be filled by Dev Agent_

### File List
_TBD - To be filled by Dev Agent_

## QA Results
_TBD - To be filled by QA Agent_
