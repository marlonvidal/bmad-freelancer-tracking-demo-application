# Story 3.4: Hourly Rate Configuration

## Status
Draft

## Story
**As a** user,
**I want** to set hourly rates at task, client, or project level,
**so that** revenue calculations reflect my actual billing rates.

## Acceptance Criteria

1. Hourly rate can be set at task level (overrides client/project rate)
2. Hourly rate can be set at client level (default for all client tasks)
3. Hourly rate can be set at project level (default for project tasks, overrides client rate)
4. Rate hierarchy: Task rate > Project rate > Client rate
5. Rate configuration is accessible from task edit, client management, and project management
6. Rate input accepts decimal values (e.g., $75.50/hour)
7. Rate is displayed with currency symbol and formatted appropriately
8. Rate configuration persists to IndexedDB
9. Rate changes update revenue calculations immediately
10. Default rate can be set globally (fallback if no client/project/task rate specified)

## Tasks / Subtasks

- [ ] Task 1: Create currency formatting utility (AC: 7)
  - [ ] Create `src/utils/currencyUtils.ts`
  - [ ] Implement `formatCurrency(amount: number): string` - Formats as "$1,250.00"
  - [ ] Implement `formatHourlyRate(rate: number): string` - Formats as "$75.50/hr" or "$75.50/hour"
  - [ ] Handle null/undefined values gracefully (return "—" or "Not set")
  - [ ] Use Intl.NumberFormat for proper locale-aware formatting
  - [ ] Support decimal precision (2 decimal places for currency)
  - [ ] Add unit tests for currency formatting

- [ ] Task 2: Add hourly rate input to TaskForm (AC: 1, 5, 6, 8)
  - [ ] Update `src/components/task/TaskForm.tsx`
  - [ ] Add hourlyRate state to form (default from task if editing, otherwise null)
  - [ ] Add number input field for hourly rate
  - [ ] Label: "Hourly Rate" with helper text (e.g., "Optional - overrides client/project rate")
  - [ ] Input accepts decimal values (step="0.01", min="0")
  - [ ] Add currency symbol prefix ($) or suffix (/hr) for visual clarity
  - [ ] Validate: rate must be >= 0 if provided, allow clearing (set to null)
  - [ ] Pre-populate hourlyRate when editing existing task (from task.hourlyRate)
  - [ ] Include hourlyRate in form submission data
  - [ ] Position input appropriately in form layout
  - [ ] Add ARIA labels for accessibility

- [ ] Task 3: Add hourly rate input to ClientForm (AC: 2, 5, 6, 8)
  - [ ] Update `src/components/client/ClientForm.tsx` (from Story 3.1)
  - [ ] Add defaultHourlyRate state to form (default from client if editing, otherwise null)
  - [ ] Add number input field for default hourly rate
  - [ ] Label: "Default Hourly Rate" with helper text (e.g., "Default rate for all tasks under this client")
  - [ ] Input accepts decimal values (step="0.01", min="0")
  - [ ] Add currency symbol prefix ($) or suffix (/hr) for visual clarity
  - [ ] Validate: rate must be >= 0 if provided, allow clearing (set to null)
  - [ ] Pre-populate defaultHourlyRate when editing existing client
  - [ ] Include defaultHourlyRate in form submission data
  - [ ] Ensure form validation handles rate input

- [ ] Task 4: Add hourly rate input to ProjectForm (AC: 3, 5, 6, 8)
  - [ ] Update `src/components/project/ProjectForm.tsx` (from Story 3.2)
  - [ ] Add defaultHourlyRate state to form (default from project if editing, otherwise null)
  - [ ] Add number input field for default hourly rate
  - [ ] Label: "Default Hourly Rate" with helper text (e.g., "Default rate for project tasks (overrides client rate)")
  - [ ] Input accepts decimal values (step="0.01", min="0")
  - [ ] Add currency symbol prefix ($) or suffix (/hr) for visual clarity
  - [ ] Validate: rate must be >= 0 if provided, allow clearing (set to null)
  - [ ] Pre-populate defaultHourlyRate when editing existing project
  - [ ] Include defaultHourlyRate in form submission data
  - [ ] Ensure form validation handles rate input

- [ ] Task 5: Create RateDisplay component for showing effective rates (AC: 7)
  - [ ] Create `src/components/common/RateDisplay.tsx`
  - [ ] Accept props: `rate: number | null`, `showLabel?: boolean`, `showSource?: boolean`
  - [ ] Display formatted rate using currencyUtils.formatHourlyRate()
  - [ ] Handle null rate gracefully (show "Not set" or "—")
  - [ ] Optional: Show source of rate (task/project/client/global) if showSource is true
  - [ ] Use consistent styling with Tailwind CSS
  - [ ] Add ARIA labels for accessibility
  - [ ] Support both light and dark modes

- [ ] Task 6: Create RevenueService with rate hierarchy logic (AC: 4, 9)
  - [ ] Create `src/services/RevenueService.ts`
  - [ ] Implement `getEffectiveHourlyRate(task: Task, client?: Client, project?: Project, settings?: Settings): number | null`
  - [ ] Rate hierarchy logic: Task rate > Project rate > Client rate > Global default
  - [ ] Return first non-null rate in hierarchy, or null if none set
  - [ ] Accept optional client/project/settings params to avoid multiple lookups
  - [ ] Handle edge cases: null rates, missing client/project
  - [ ] Add JSDoc comments explaining hierarchy
  - [ ] Add unit tests for rate hierarchy logic

- [ ] Task 7: Add global default rate to Settings (AC: 10)
  - [ ] Verify `src/types/settings.ts` includes `defaultHourlyRate: number | null` [Source: architecture/common/data-models.md#settings]
  - [ ] Update SettingsContext (from Story 3.3) to include defaultHourlyRate
  - [ ] Add UI in SettingsPanel for configuring global default rate (future story, document for now)
  - [ ] Ensure SettingsRepository supports updating defaultHourlyRate
  - [ ] Document that Settings UI will be added in future story

- [ ] Task 8: Integrate rate hierarchy into RevenueService (AC: 4, 9)
  - [ ] Update RevenueService.getEffectiveHourlyRate() to use SettingsContext
  - [ ] Fetch client, project, and settings if not provided as params
  - [ ] Implement full hierarchy: Task > Project > Client > Global
  - [ ] Cache results if needed for performance
  - [ ] Ensure rate changes trigger revenue recalculation
  - [ ] Add error handling for missing data

- [ ] Task 9: Update TaskForm to show effective rate preview (AC: 4, 7)
  - [ ] Update `src/components/task/TaskForm.tsx`
  - [ ] Import RevenueService and RateDisplay component
  - [ ] When client/project/task rate is set, show effective rate preview
  - [ ] Display: "Effective rate: $75.50/hr (from task)" or similar
  - [ ] Update preview when rate inputs change
  - [ ] Show hierarchy explanation (e.g., "Task rate overrides project rate")
  - [ ] Use RateDisplay component for consistent formatting
  - [ ] Position preview near rate input field

- [ ] Task 10: Verify data models and database schema (AC: 8)
  - [ ] Verify `src/types/task.ts` includes `hourlyRate: number | null` [Source: architecture/common/data-models.md#task]
  - [ ] Verify `src/types/client.ts` includes `defaultHourlyRate: number | null` [Source: architecture/common/data-models.md#client]
  - [ ] Verify `src/types/project.ts` includes `defaultHourlyRate: number | null` [Source: architecture/common/data-models.md#project]
  - [ ] Verify `src/types/settings.ts` includes `defaultHourlyRate: number | null` [Source: architecture/common/data-models.md#settings]
  - [ ] Verify database schema stores rates as numbers (not strings)
  - [ ] Test that rate data persists across browser sessions
  - [ ] Ensure repositories support updating rate fields

- [ ] Task 11: Add unit tests for currencyUtils (AC: 7)
  - [ ] Create `tests/unit/utils/currencyUtils.test.ts`
  - [ ] Test formatCurrency() with various amounts (0, 1, 100, 1000, 10000, decimals)
  - [ ] Test formatHourlyRate() with various rates
  - [ ] Test null/undefined handling
  - [ ] Test decimal precision (2 decimal places)
  - [ ] Test locale formatting (US locale)

- [ ] Task 12: Add unit tests for RevenueService rate hierarchy (AC: 4)
  - [ ] Create `tests/unit/services/RevenueService.test.ts`
  - [ ] Test getEffectiveHourlyRate() with task rate set (should return task rate)
  - [ ] Test getEffectiveHourlyRate() with project rate set, no task rate (should return project rate)
  - [ ] Test getEffectiveHourlyRate() with client rate set, no project/task rate (should return client rate)
  - [ ] Test getEffectiveHourlyRate() with global default, no client/project/task rate (should return global)
  - [ ] Test getEffectiveHourlyRate() with no rates set (should return null)
  - [ ] Test hierarchy priority: Task > Project > Client > Global
  - [ ] Test edge cases (null values, missing client/project)

- [ ] Task 13: Add unit tests for rate inputs in forms (AC: 1, 2, 3, 6, 8)
  - [ ] Update `tests/unit/components/task/TaskForm.test.tsx`
  - [ ] Test hourly rate input renders in TaskForm
  - [ ] Test rate input accepts decimal values
  - [ ] Test rate validation (>= 0)
  - [ ] Test rate pre-populates when editing task
  - [ ] Test rate is included in form submission
  - [ ] Update `tests/unit/components/client/ClientForm.test.tsx` (similar tests for client rate)
  - [ ] Update `tests/unit/components/project/ProjectForm.test.tsx` (similar tests for project rate)

- [ ] Task 14: Add integration tests for rate configuration workflow (AC: 1-10)
  - [ ] Create `tests/integration/hourly-rate-configuration.test.tsx`
  - [ ] Test complete workflow: Set client rate → Set project rate → Set task rate → Verify hierarchy
  - [ ] Test rate persistence across browser sessions
  - [ ] Test rate updates trigger revenue recalculation (if RevenueService exists)
  - [ ] Test rate display formatting in all forms
  - [ ] Test effective rate preview in TaskForm
  - [ ] Use React Testing Library for component integration testing

- [ ] Task 15: Update ClientRepository and ProjectRepository if needed (AC: 2, 3, 8)
  - [ ] Verify ClientRepository.update() supports updating defaultHourlyRate
  - [ ] Verify ProjectRepository.update() supports updating defaultHourlyRate
  - [ ] Verify TaskRepository.update() supports updating hourlyRate
  - [ ] Test rate updates persist correctly
  - [ ] Ensure repositories handle null rate values correctly

## Dev Notes

### Previous Story Insights

From Story 3.1 (Client Management), 3.2 (Project Management), and 3.3 (Billable Toggle), key learnings:
- Forms should use controlled inputs with proper state management
- Settings infrastructure (SettingsRepository, SettingsContext) exists from Story 3.3
- ClientForm and ProjectForm already exist and need rate input added
- TaskForm exists and needs rate input added
- Context-based state management simplifies component integration

**Dependencies:**
- Story 3.1: ClientForm component exists (needs rate input added)
- Story 3.2: ProjectForm component exists (needs rate input added)
- Story 3.3: SettingsContext exists (needs defaultHourlyRate support)
- All data models already include rate fields

### Data Models

**Task Model (relevant fields):**
```typescript
interface Task {
  // ... other fields
  hourlyRate: number | null;      // Task-specific hourly rate (overrides project/client rate)
  // ... other fields
}
```
[Source: architecture/common/data-models.md#task]

**Client Model (relevant fields):**
```typescript
interface Client {
  // ... other fields
  defaultHourlyRate: number | null;  // Default hourly rate for client tasks
  // ... other fields
}
```
[Source: architecture/common/data-models.md#client]

**Project Model (relevant fields):**
```typescript
interface Project {
  // ... other fields
  defaultHourlyRate: number | null;  // Default hourly rate for project tasks (overrides client rate)
  // ... other fields
}
```
[Source: architecture/common/data-models.md#project]

**Settings Model (relevant fields):**
```typescript
interface Settings {
  id: 'default';
  // ... other fields
  defaultHourlyRate: number | null;  // Global default hourly rate (fallback)
  // ... other fields
}
```
[Source: architecture/common/data-models.md#settings]

**Rate Hierarchy:**
1. Task.hourlyRate (highest priority - overrides all)
2. Project.defaultHourlyRate (overrides client and global)
3. Client.defaultHourlyRate (overrides global)
4. Settings.defaultHourlyRate (lowest priority - fallback)

**Database Schema:**
- All rate fields stored as `number | null` in IndexedDB
- Rates stored as decimal numbers (e.g., 75.50, not strings)
- No special indexes needed for rates (not used for filtering)
[Source: architecture/common/database-schema.md#dexiejs-schema-definition]

### API Specifications

**RevenueService Methods:**
- `getEffectiveHourlyRate(task: Task, client?: Client, project?: Project, settings?: Settings): number | null`
  - Returns effective hourly rate based on hierarchy
  - Checks Task.hourlyRate first, then Project.defaultHourlyRate, then Client.defaultHourlyRate, then Settings.defaultHourlyRate
  - Returns null if no rate is set at any level

**Repository Methods:**
- `TaskRepository.update(id, { hourlyRate })` - Update task hourly rate
- `ClientRepository.update(id, { defaultHourlyRate })` - Update client default rate
- `ProjectRepository.update(id, { defaultHourlyRate })` - Update project default rate
- `SettingsRepository.updateSettings({ defaultHourlyRate })` - Update global default rate

[Source: architecture/components.md#revenue-calculation-service]

### Component Specifications

**RateDisplay Component:**
- Location: `src/components/common/RateDisplay.tsx`
- Props: 
  - `rate: number | null` (rate to display)
  - `showLabel?: boolean` (show "Rate:" label)
  - `showSource?: boolean` (show where rate comes from)
- Behavior:
  - Formats rate using currencyUtils.formatHourlyRate()
  - Shows "Not set" or "—" when rate is null
  - Optional source indicator (e.g., "from task", "from project")
- Styling: Consistent with other display components

**TaskForm Updates:**
- Add hourly rate number input
- Show effective rate preview when client/project/task rate is set
- Use RateDisplay component for preview
- Position input near other task metadata

**ClientForm Updates:**
- Add default hourly rate number input (if not already present from Story 3.1)
- Position input in form layout
- Include in form submission

**ProjectForm Updates:**
- Add default hourly rate number input (if not already present from Story 3.2)
- Position input in form layout
- Include in form submission

[Source: architecture/common/frontend-architecture.md#component-architecture]

### File Locations

Based on project structure:
- Utilities: `src/utils/currencyUtils.ts` (new)
- Services: `src/services/RevenueService.ts` (new - may exist partially)
- Components: `src/components/common/RateDisplay.tsx` (new)
- Forms: Update existing TaskForm, ClientForm, ProjectForm
- Tests: `tests/unit/utils/`, `tests/unit/services/`, `tests/integration/`

[Source: architecture/unified-project-structure.md]

### Testing Requirements

**Unit Tests:**
- Utility tests: currencyUtils (formatCurrency, formatHourlyRate)
- Service tests: RevenueService (rate hierarchy logic)
- Component tests: RateDisplay, form rate inputs
- Target: 80%+ code coverage

**Integration Tests:**
- Complete rate configuration workflow
- Set rates at different levels → verify hierarchy → verify persistence
- Rate display formatting
- Effective rate preview

**Test Organization:**
- Unit tests: `tests/unit/utils/`, `tests/unit/services/`, `tests/unit/components/`
- Integration tests: `tests/integration/hourly-rate-configuration.test.tsx`

[Source: architecture/common/testing-strategy.md]

### Technical Constraints

**Coding Standards:**
- Use TypeScript with strict types (no `any`)
- One component per file
- Use Context API for state management (avoid prop drilling)
- Always use repository pattern (never access IndexedDB directly from components)
- All async operations must have try/catch error handling
- Use React.memo, useMemo, useCallback appropriately for performance
- All interactive elements must have ARIA labels and keyboard navigation support

**Error Handling:**
- Catch QuotaExceededError and provide user-friendly message
- Handle invalid rate input (negative numbers, non-numeric)
- Show validation errors for invalid rates
- Handle null rates gracefully (not an error, just "not set")

**Performance:**
- Rate calculations should be fast (simple hierarchy check)
- Cache effective rates if needed (but hierarchy is simple enough to compute on-demand)
- Rate display formatting should use memoization if called frequently

**Currency Formatting:**
- Use Intl.NumberFormat for locale-aware formatting
- Default to US locale ($ symbol, comma separators)
- Support 2 decimal places for currency
- Handle edge cases: 0, null, undefined, very large numbers

**Rate Input Validation:**
- Accept decimal values (step="0.01")
- Minimum value: 0 (no negative rates)
- No maximum limit (users may have very high rates)
- Allow clearing (set to null)
- Validate on blur and submit

[Source: architecture/common/coding-standards.md]

### Project Structure Notes

The project structure already includes:
- `src/types/task.ts` - Task type with hourlyRate field
- `src/types/client.ts` - Client type with defaultHourlyRate field
- `src/types/project.ts` - Project type with defaultHourlyRate field
- `src/types/settings.ts` - Settings type with defaultHourlyRate field (from Story 3.3)
- `src/components/task/TaskForm.tsx` - TaskForm (needs rate input added)
- `src/components/client/ClientForm.tsx` - ClientForm from Story 3.1 (needs rate input added)
- `src/components/project/ProjectForm.tsx` - ProjectForm from Story 3.2 (needs rate input added)
- `src/contexts/SettingsContext.tsx` - SettingsContext from Story 3.3 (needs defaultHourlyRate support)

New components need to be created:
- `src/utils/currencyUtils.ts` (new)
- `src/services/RevenueService.ts` (new - may exist partially)
- `src/components/common/RateDisplay.tsx` (new)

[Source: architecture/unified-project-structure.md]

### Additional Considerations

**Rate Input UX:**
- Show currency symbol ($) prefix or suffix (/hr) for clarity
- Use number input with step="0.01" for decimal precision
- Allow users to type "75.50" or "75.5" (both should work)
- Clear indication when rate is optional vs required
- Helper text explaining rate hierarchy

**Effective Rate Preview:**
- Show preview in TaskForm when rates are set
- Display source of rate (e.g., "from task", "from project")
- Update preview in real-time as user changes rates
- Use RateDisplay component for consistent formatting

**Rate Hierarchy Display:**
- Consider showing hierarchy explanation in forms
- Example: "Task rate (if set) > Project rate > Client rate > Global default"
- Help users understand which rate will be used

**Future Enhancements:**
- Settings UI for configuring global default rate (deferred to future story)
- Rate history/audit trail (future enhancement)
- Multiple currencies support (future enhancement)
- Rate templates/presets (future enhancement)

**Integration with Revenue Calculation:**
- RevenueService.getEffectiveHourlyRate() will be used by Story 3.5 (Revenue Calculation)
- Ensure rate changes trigger revenue recalculation (Story 3.5)
- Rate hierarchy must be consistent across all revenue calculations

## Testing

### Testing Standards

**Test File Location:**
- Unit tests: `tests/unit/utils/`, `tests/unit/services/`, `tests/unit/components/`
- Integration tests: `tests/integration/`

**Testing Frameworks:**
- Jest ^29.7.0 for unit tests
- React Testing Library ^14.0.0 for component tests
- Mock Dexie/IndexedDB for repository tests

**Test Patterns:**
- Use `render`, `screen`, `fireEvent` from React Testing Library
- Mock Context providers when testing components
- Mock IndexedDB operations when testing repositories
- Test user interactions, not implementation details
- Aim for 80%+ code coverage

**Specific Test Requirements:**
- Test currency formatting (various amounts, decimals, null values)
- Test rate hierarchy logic (all combinations of rates)
- Test rate input validation (negative, decimals, null)
- Test rate persistence in IndexedDB
- Test effective rate preview in TaskForm
- Test rate display formatting
- Test error handling (invalid input, QuotaExceededError)

[Source: architecture/common/testing-strategy.md]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-23 | 1.0 | Initial story draft | Scrum Master |

## Dev Agent Record

### Agent Model Used
_TBD - To be filled by Dev Agent_

### Debug Log References
_TBD - To be filled by Dev Agent_

### Completion Notes List
_TBD - To be filled by Dev Agent_

### File List
_TBD - To be filled by Dev Agent_

## QA Results
_TBD - To be filled by QA Agent_
