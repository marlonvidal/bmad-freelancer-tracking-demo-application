# Story 3.7: Task Filtering by Client and Project

## Status
Draft

## Story
**As a** user,
**I want** to filter the kanban board by client or project,
**so that** I can focus on specific work contexts.

## Acceptance Criteria

1. Filter controls are accessible from kanban board (dropdown or filter bar)
2. User can filter tasks by client (shows only tasks for selected client)
3. User can filter tasks by project (shows only tasks for selected project)
4. Multiple filters can be combined (client AND project)
5. Filter state is visually indicated (active filters shown, clear filters button)
6. Filtering updates board display immediately (no page refresh)
7. Filter state can be cleared to show all tasks
8. Filter works with drag-and-drop (filtered tasks can still be moved)
9. Filter state doesn't persist across sessions (resets on app load)
10. Filter is accessible via keyboard navigation

## Tasks / Subtasks

- [ ] Task 1: Create FilterContext for filter state management (AC: 4, 6, 7, 9)
  - [ ] Create `src/contexts/FilterContext.tsx`
  - [ ] Implement FilterContextProvider with React Context API
  - [ ] Manage filter state: `{ clientId: string | null, projectId: string | null }`
  - [ ] Provide methods: `setClientFilter(clientId: string | null)`, `setProjectFilter(projectId: string | null)`, `clearFilters()`, `getFilters()`
  - [ ] Filter state resets on app load (don't persist to IndexedDB)
  - [ ] Ensure context updates trigger re-renders in consuming components
  - [ ] Handle filter state changes efficiently

- [ ] Task 2: Create TaskFilterBar component (AC: 1, 2, 3, 5, 7, 10)
  - [ ] Create `src/components/kanban/TaskFilterBar.tsx`
  - [ ] Display filter controls: Client dropdown, Project dropdown, Clear filters button
  - [ ] Client dropdown: Shows all clients, "All Clients" option, selected client highlighted
  - [ ] Project dropdown: Shows projects for selected client (or all projects if no client selected), "All Projects" option
  - [ ] Project dropdown disabled when no client selected (projects are client-scoped)
  - [ ] Clear filters button: Resets both filters to null (only visible when filters are active)
  - [ ] Show active filter indicators (badges/chips showing selected client/project)
  - [ ] Position filter bar above kanban board (top of KanbanBoard component)
  - [ ] Ensure keyboard navigation (Tab, Arrow keys, Enter/Space to select)
  - [ ] Add ARIA labels for accessibility

- [ ] Task 3: Integrate FilterContext into TaskContext (AC: 2, 3, 4, 6)
  - [ ] Update `src/contexts/TaskContext.tsx`
  - [ ] Add `getFilteredTasks(filters: { clientId: string | null, projectId: string | null }): Task[]` method
  - [ ] Filter logic:
    - [ ] If clientId is set: Filter tasks where task.clientId === clientId
    - [ ] If projectId is set: Filter tasks where task.projectId === projectId
    - [ ] If both are set: Filter tasks where task.clientId === clientId AND task.projectId === projectId
    - [ ] If neither is set: Return all tasks
  - [ ] Ensure filtering works with existing getTasksByColumnId() method
  - [ ] Update getTasksByColumnId() to respect filters (or create filtered version)
  - [ ] Add `getFilteredTasksByColumnId(columnId: string, filters: FilterState): Task[]` method

- [ ] Task 4: Update Column component to use filtered tasks (AC: 2, 3, 4, 6, 8)
  - [ ] Update `src/components/kanban/Column.tsx`
  - [ ] Import FilterContext
  - [ ] Get current filters from FilterContext
  - [ ] Use filtered tasks instead of all tasks
  - [ ] Update getTasksByColumnId() call to use filtered version
  - [ ] Ensure drag-and-drop still works with filtered tasks
  - [ ] Ensure tasks can be moved between columns even when filtered
  - [ ] Test that filtered tasks maintain their positions correctly

- [ ] Task 5: Integrate TaskFilterBar into KanbanBoard (AC: 1, 5, 6)
  - [ ] Update `src/components/kanban/KanbanBoard.tsx`
  - [ ] Import TaskFilterBar component
  - [ ] Render TaskFilterBar above columns
  - [ ] Wrap KanbanBoard with FilterContextProvider (or ensure it's provided in App.tsx)
  - [ ] Ensure filter bar is visible and accessible
  - [ ] Position filter bar appropriately (above columns, responsive layout)

- [ ] Task 6: Handle project filter dependency on client filter (AC: 3, 4)
  - [ ] Update TaskFilterBar component
  - [ ] When client filter changes, reset project filter to null (projects are client-scoped)
  - [ ] When client filter is cleared, disable and clear project filter
  - [ ] When client filter is set, load and display projects for that client
  - [ ] Ensure project filter only shows projects for selected client
  - [ ] Show helpful message when no client selected: "Select a client to filter by project"

- [ ] Task 7: Add visual indicators for active filters (AC: 5)
  - [ ] Update TaskFilterBar component
  - [ ] Show active filter badges/chips above or next to filter controls
  - [ ] Display: "Client: [Client Name]" and/or "Project: [Project Name]"
  - [ ] Style badges consistently (similar to PriorityBadge)
  - [ ] Add remove button (X) on each badge to clear individual filter
  - [ ] Ensure badges are accessible (keyboard navigation, ARIA labels)

- [ ] Task 8: Ensure drag-and-drop works with filtered tasks (AC: 8)
  - [ ] Test drag-and-drop functionality with filters active
  - [ ] Ensure tasks can be dragged between columns when filtered
  - [ ] Ensure tasks can be reordered within columns when filtered
  - [ ] Ensure filtered tasks maintain correct positions after drag
  - [ ] Ensure tasks not matching filter can still be dropped (if dragged from elsewhere)
  - [ ] Update drag-and-drop logic if needed to handle filtered state

- [ ] Task 9: Add unit tests for FilterContext (AC: 4, 6, 7, 9)
  - [ ] Create `tests/unit/contexts/FilterContext.test.tsx`
  - [ ] Test setClientFilter() updates filter state
  - [ ] Test setProjectFilter() updates filter state
  - [ ] Test clearFilters() resets both filters
  - [ ] Test filter state doesn't persist (resets on remount)
  - [ ] Test context updates trigger re-renders
  - [ ] Mock React Context appropriately

- [ ] Task 10: Add unit tests for TaskFilterBar component (AC: 1, 2, 3, 5, 7, 10)
  - [ ] Create `tests/unit/components/kanban/TaskFilterBar.test.tsx`
  - [ ] Test client dropdown renders with all clients
  - [ ] Test project dropdown renders with projects for selected client
  - [ ] Test project dropdown disabled when no client selected
  - [ ] Test selecting client updates filter
  - [ ] Test selecting project updates filter
  - [ ] Test clear filters button resets filters
  - [ ] Test active filter badges display correctly
  - [ ] Test keyboard navigation (Tab, Arrow keys, Enter/Space)
  - [ ] Test ARIA labels and accessibility
  - [ ] Mock FilterContext, ClientContext, ProjectContext appropriately

- [ ] Task 11: Add unit tests for filtered task logic (AC: 2, 3, 4)
  - [ ] Update `tests/unit/contexts/TaskContext.test.tsx`
  - [ ] Test getFilteredTasks() with client filter only
  - [ ] Test getFilteredTasks() with project filter only
  - [ ] Test getFilteredTasks() with both filters (client AND project)
  - [ ] Test getFilteredTasks() with no filters (returns all tasks)
  - [ ] Test getFilteredTasksByColumnId() respects filters
  - [ ] Test filtering works with tasks that have no client/project (null values)

- [ ] Task 12: Add integration tests for filtering workflow (AC: 1-10)
  - [ ] Create `tests/integration/task-filtering.test.tsx`
  - [ ] Test complete workflow: Select client filter → Verify tasks filtered → Select project filter → Verify tasks filtered further
  - [ ] Test clear filters → Verify all tasks shown
  - [ ] Test drag-and-drop works with filters active
  - [ ] Test filter state resets on app reload
  - [ ] Test keyboard navigation through filters
  - [ ] Test project filter resets when client filter changes
  - [ ] Use React Testing Library for component integration testing

- [ ] Task 13: Handle edge cases and empty states (AC: 2, 3, 4)
  - [ ] Handle tasks with no client assigned (clientId === null): Show when no client filter or show in "Unassigned" group
  - [ ] Handle tasks with no project assigned (projectId === null): Show when no project filter
  - [ ] Handle client with no projects: Project dropdown shows empty or "No projects"
  - [ ] Handle no tasks matching filter: Show empty state message in columns
  - [ ] Handle client/project deleted: Filter should clear or show "Client/Project not found"
  - [ ] Ensure filtering doesn't break when clients/projects are deleted

- [ ] Task 14: Optimize filter performance (AC: 6)
  - [ ] Use useMemo to cache filtered task lists
  - [ ] Only recalculate filtered tasks when filters or tasks change
  - [ ] Ensure filtering doesn't slow down board rendering
  - [ ] Profile performance with many tasks (1000+ tasks)
  - [ ] Optimize if needed (e.g., use indexes, efficient filtering)

- [ ] Task 15: Ensure FilterContext is provided in App.tsx (AC: 1, 6)
  - [ ] Update `src/App.tsx`
  - [ ] Import FilterContextProvider
  - [ ] Wrap KanbanBoard with FilterContextProvider
  - [ ] Ensure FilterContext is available to all kanban components
  - [ ] Test that filter state is isolated (doesn't affect other views)

## Dev Notes

### Previous Story Insights

From Story 3.1 (Client Management) and 3.2 (Project Management), key learnings:
- ClientContext and ProjectContext exist and provide client/project data
- Projects are scoped to clients (project filter depends on client filter)
- ClientSelector and ProjectSelector components exist (can be reused or adapted)
- Tasks have clientId and projectId fields

**Dependencies:**
- Story 3.1: ClientContext exists, ClientSelector component exists
- Story 3.2: ProjectContext exists, ProjectSelector component exists, projects are client-scoped
- Task model already includes clientId and projectId fields

### Data Models

**Task Model (relevant fields):**
```typescript
interface Task {
  // ... other fields
  clientId: string | null;       // Reference to assigned client (optional)
  projectId: string | null;      // Reference to assigned project (optional, requires clientId)
  columnId: string;              // Column filtering (existing)
  // ... other fields
}
```
[Source: architecture/common/data-models.md#task]

**Filter State Interface:**
```typescript
interface FilterState {
  clientId: string | null;       // Selected client filter (null = no filter)
  projectId: string | null;      // Selected project filter (null = no filter)
}
```

**Filtering Logic:**
- Client filter: Show tasks where task.clientId === filter.clientId
- Project filter: Show tasks where task.projectId === filter.projectId
- Combined: Show tasks where task.clientId === filter.clientId AND task.projectId === filter.projectId
- Tasks with null clientId/projectId: Show when no filter is set for that field

**Database Schema:**
- Tasks table has indexes: `clientId`, `projectId` for efficient filtering
- Compound index `[clientId+projectId]` enables efficient combined queries
[Source: architecture/common/database-schema.md#dexiejs-schema-definition]

### API Specifications

**FilterContext Methods:**
- `setClientFilter(clientId: string | null): void` - Set client filter
- `setProjectFilter(projectId: string | null): void` - Set project filter
- `clearFilters(): void` - Clear all filters
- `getFilters(): FilterState` - Get current filter state

**TaskContext Methods (updated):**
- `getFilteredTasks(filters: FilterState): Task[]` - Get tasks matching filters
- `getFilteredTasksByColumnId(columnId: string, filters: FilterState): Task[]` - Get filtered tasks for column

**Repository Methods:**
- TaskRepository already supports querying by clientId and projectId (via indexes)
- Can use: `db.tasks.where('clientId').equals(clientId).toArray()`
- Can use: `db.tasks.where('projectId').equals(projectId).toArray()`
- Can use compound query: `db.tasks.where('[clientId+projectId]').equals([clientId, projectId]).toArray()`

[Source: architecture/components.md#data-access-layer]

### Component Specifications

**TaskFilterBar Component:**
- Location: `src/components/kanban/TaskFilterBar.tsx`
- Layout:
  - Client dropdown/select
  - Project dropdown/select (disabled when no client selected)
  - Clear filters button (visible when filters active)
  - Active filter badges/chips
- Behavior:
  - Client selection updates filter and resets project filter
  - Project selection updates filter (only enabled when client selected)
  - Clear filters resets both filters
  - Shows active filter indicators
- Styling: Horizontal bar above kanban board, responsive

**FilterContext:**
- Location: `src/contexts/FilterContext.tsx`
- Provides: `filters: FilterState`, `setClientFilter()`, `setProjectFilter()`, `clearFilters()`
- Uses React Context API for state management
- Filter state doesn't persist (resets on app load)
- Updates trigger re-renders in consuming components

**Column Component Updates:**
- Uses FilterContext to get current filters
- Uses TaskContext.getFilteredTasksByColumnId() instead of getTasksByColumnId()
- Displays filtered tasks in column
- Drag-and-drop works with filtered tasks

[Source: architecture/common/frontend-architecture.md#component-architecture]

### File Locations

Based on project structure:
- Components: `src/components/kanban/TaskFilterBar.tsx` (new)
- Context: `src/contexts/FilterContext.tsx` (new)
- Tests: `tests/unit/components/kanban/`, `tests/unit/contexts/`, `tests/integration/`

[Source: architecture/unified-project-structure.md]

### Testing Requirements

**Unit Tests:**
- Context tests: FilterContext (filter state management)
- Component tests: TaskFilterBar (dropdowns, clear button, badges)
- Context tests: TaskContext filtered methods
- Target: 80%+ code coverage

**Integration Tests:**
- Complete filtering workflow
- Client filter → Project filter → Clear filters
- Drag-and-drop with filters active
- Filter state reset on reload

**Test Organization:**
- Unit tests: `tests/unit/contexts/`, `tests/unit/components/kanban/`
- Integration tests: `tests/integration/task-filtering.test.tsx`

[Source: architecture/common/testing-strategy.md]

### Technical Constraints

**Coding Standards:**
- Use TypeScript with strict types (no `any`)
- One component per file
- Use Context API for state management (avoid prop drilling)
- Always use repository pattern (never access IndexedDB directly from components)
- All async operations must have try/catch error handling
- Use React.memo, useMemo, useCallback appropriately for performance
- All interactive elements must have ARIA labels and keyboard navigation support

**Error Handling:**
- Handle missing client/project data gracefully
- Handle deleted clients/projects (clear filter or show error)
- Handle filter state inconsistencies

**Performance:**
- Cache filtered task lists (use useMemo)
- Only recalculate when filters or tasks change
- Use IndexedDB indexes for efficient filtering
- Ensure filtering doesn't slow down board rendering
- Profile performance with many tasks (1000+)

**Filter State Management:**
- Filter state doesn't persist (resets on app load per AC 9)
- Filter state is local to session only
- Don't store filters in IndexedDB or localStorage

**Client-Project Dependency:**
- Project filter depends on client filter (projects are client-scoped)
- When client filter changes, reset project filter
- When client filter is cleared, disable and clear project filter
- Project dropdown only shows projects for selected client

**Drag-and-Drop Compatibility:**
- Filtering should not interfere with drag-and-drop
- Filtered tasks can still be moved between columns
- Filtered tasks can still be reordered within columns
- Tasks not matching filter can still be dropped (if dragged)

[Source: architecture/common/coding-standards.md]

### Project Structure Notes

The project structure already includes:
- `src/contexts/TaskContext.tsx` - TaskContext (needs filtered methods added)
- `src/contexts/ClientContext.tsx` - ClientContext from Story 3.1
- `src/contexts/ProjectContext.tsx` - ProjectContext from Story 3.2
- `src/components/kanban/KanbanBoard.tsx` - KanbanBoard (needs TaskFilterBar added)
- `src/components/kanban/Column.tsx` - Column (needs filtering integration)
- `src/components/client/ClientSelector.tsx` - ClientSelector from Story 3.1 (can be reused/adapted)
- `src/components/project/ProjectSelector.tsx` - ProjectSelector from Story 3.2 (can be reused/adapted)

New components need to be created:
- `src/components/kanban/TaskFilterBar.tsx` (new)
- `src/contexts/FilterContext.tsx` (new)

[Source: architecture/unified-project-structure.md]

### Additional Considerations

**Filter UI Design:**
- Filter bar positioned above kanban board
- Horizontal layout: Client dropdown | Project dropdown | Clear button | Active filters
- Responsive: Stack vertically on mobile if needed
- Clear visual indication of active filters (badges/chips)
- Disabled state for project dropdown when no client selected

**Filter Behavior:**
- Client filter: Shows all tasks for selected client (including tasks with no project)
- Project filter: Shows all tasks for selected project (requires client to be selected)
- Combined filters: Shows tasks matching both client AND project
- Tasks with null clientId: Show when no client filter (or in "Unassigned" group)
- Tasks with null projectId: Show when no project filter (or in "Unassigned" group)

**Empty States:**
- No tasks matching filter: Show empty state in columns
- No clients: Show disabled client dropdown with message
- No projects for client: Show disabled project dropdown with "No projects" message

**Keyboard Navigation:**
- Tab through filter controls
- Arrow keys to navigate dropdown options
- Enter/Space to select option
- Escape to close dropdown
- Clear filters button accessible via keyboard

**Future Enhancements:**
- Filter by billable status (future enhancement)
- Filter by priority (future enhancement)
- Filter by tags (future enhancement)
- Save filter presets (future enhancement)
- Filter persistence option (future enhancement - currently resets per AC 9)

## Testing

### Testing Standards

**Test File Location:**
- Unit tests: `tests/unit/contexts/`, `tests/unit/components/kanban/`
- Integration tests: `tests/integration/`

**Testing Frameworks:**
- Jest ^29.7.0 for unit tests
- React Testing Library ^14.0.0 for component tests
- Mock Dexie/IndexedDB for repository tests

**Test Patterns:**
- Use `render`, `screen`, `fireEvent` from React Testing Library
- Mock Context providers when testing components
- Mock IndexedDB operations when testing repositories
- Test user interactions, not implementation details
- Aim for 80%+ code coverage

**Specific Test Requirements:**
- Test filter state management (set, clear, reset)
- Test filtering logic (client only, project only, both, none)
- Test client-project dependency (project resets when client changes)
- Test drag-and-drop with filters active
- Test filter state doesn't persist (resets on reload)
- Test keyboard navigation
- Test empty states
- Test edge cases (null values, deleted clients/projects)

[Source: architecture/common/testing-strategy.md]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-23 | 1.0 | Initial story draft | Scrum Master |

## Dev Agent Record

### Agent Model Used
_TBD - To be filled by Dev Agent_

### Debug Log References
_TBD - To be filled by Dev Agent_

### Completion Notes List
_TBD - To be filled by Dev Agent_

### File List
_TBD - To be filled by Dev Agent_

## QA Results
_TBD - To be filled by QA Agent_
