# Story 4.1: Task Detail Side Panel

## Status
Draft

## Story
**As a** user,
**I want** to view and edit detailed task information in a side panel,
**so that** I can manage task details without cluttering the kanban board view.

## Acceptance Criteria

1. Clicking task card opens side panel (slides in from right side)
2. Side panel displays all task information: title, description, due date, priority, tags, client, project, billable status, time spent, time estimate
3. Side panel allows editing all task fields inline
4. Changes save automatically or via save button (auto-save preferred)
5. Side panel can be closed via close button, click outside, or ESC key
6. Side panel doesn't obstruct kanban board (board remains visible and functional)
7. Side panel is responsive and adapts to different window sizes
8. Side panel shows time entries list with ability to add/edit/delete entries
9. Side panel is accessible via keyboard navigation
10. Side panel animations are smooth (60fps) and don't cause layout shifts

## Tasks / Subtasks

- [ ] Task 1: Create TaskDetailPanel component structure (AC: 1, 2, 6, 7, 9)
  - [ ] Create `src/components/task/TaskDetailPanel.tsx`
  - [ ] Implement side panel container with slide-in animation from right
  - [ ] Use Tailwind CSS for styling (responsive width: full on mobile, fixed width on desktop)
  - [ ] Ensure panel doesn't obstruct kanban board (use overlay/backdrop pattern)
  - [ ] Implement smooth animations using CSS transitions (60fps requirement)
  - [ ] Add ARIA attributes: `role="dialog"`, `aria-modal="true"`, `aria-labelledby` for panel title
  - [ ] Ensure panel is keyboard accessible (focus trap, ESC key handling)

- [ ] Task 2: Create panel state management in TaskContext (AC: 1, 5)
  - [ ] Update `src/contexts/TaskContext.tsx`
  - [ ] Add state: `selectedTaskId: string | null`, `isPanelOpen: boolean`
  - [ ] Add methods: `openTaskPanel(taskId: string)`, `closeTaskPanel()`, `getSelectedTask(): Task | null`
  - [ ] Handle panel state updates reactively
  - [ ] Ensure panel closes when task is deleted

- [ ] Task 3: Implement task display section (AC: 2)
  - [ ] Display task title (editable)
  - [ ] Display task description (editable textarea)
  - [ ] Display due date (editable date picker)
  - [ ] Display priority (editable dropdown: low/medium/high/null)
  - [ ] Display tags (editable tag input component)
  - [ ] Display client (editable ClientSelector component)
  - [ ] Display project (editable ProjectSelector component, disabled if no client)
  - [ ] Display billable status (editable toggle)
  - [ ] Display time spent (calculated from TimeEntry records)
  - [ ] Display time estimate (editable number input in minutes)
  - [ ] Use existing components where available (ClientSelector, ProjectSelector from previous stories)

- [ ] Task 4: Implement inline editing functionality (AC: 3, 4)
  - [ ] Create editable field components with auto-save
  - [ ] Use debounced auto-save (500ms delay) to prevent excessive IndexedDB writes
  - [ ] Show save indicator (saving/saved state) for user feedback
  - [ ] Handle validation errors gracefully (show inline error messages)
  - [ ] Update TaskContext methods to support partial task updates
  - [ ] Ensure updates persist to IndexedDB via TaskRepository
  - [ ] Update UI optimistically (immediate UI update, then sync to IndexedDB)

- [ ] Task 5: Implement time entries list section (AC: 8)
  - [ ] Create `src/components/task/TimeEntriesList.tsx` component
  - [ ] Display list of TimeEntry records for selected task
  - [ ] Show: start time, end time, duration, description, manual/auto indicator
  - [ ] Add "Add Time Entry" button (opens form/modal)
  - [ ] Add edit/delete actions for each time entry
  - [ ] Use TimeEntryRepository for CRUD operations
  - [ ] Calculate and display total time spent from all entries
  - [ ] Format time display using timeUtils (from existing utils)

- [ ] Task 6: Implement panel close functionality (AC: 5)
  - [ ] Add close button (X icon) in panel header
  - [ ] Implement click-outside-to-close (backdrop click)
  - [ ] Implement ESC key handler (use useEffect with keyboard event listener)
  - [ ] Restore focus to task card that opened panel after close
  - [ ] Use focus trap library or custom implementation for accessibility

- [ ] Task 7: Integrate TaskDetailPanel into KanbanBoard (AC: 1, 6)
  - [ ] Update `src/components/kanban/KanbanBoard.tsx`
  - [ ] Add TaskDetailPanel component to render tree
  - [ ] Update TaskCard to call `openTaskPanel(taskId)` on click
  - [ ] Ensure panel renders conditionally based on `isPanelOpen` state
  - [ ] Test that kanban board remains functional with panel open (drag-and-drop still works)

- [ ] Task 8: Implement responsive design (AC: 7)
  - [ ] Panel width: full width on mobile (< 768px), fixed width (400-500px) on desktop
  - [ ] Panel positioning: overlay on mobile, side-by-side on desktop (if space allows)
  - [ ] Ensure panel content is scrollable if it exceeds viewport height
  - [ ] Test on various screen sizes (mobile, tablet, desktop)
  - [ ] Use Tailwind responsive classes: `md:w-96`, `w-full md:w-[500px]`

- [ ] Task 9: Implement smooth animations (AC: 10)
  - [ ] Use CSS transitions for slide-in animation (transform: translateX)
  - [ ] Use `will-change: transform` for performance optimization
  - [ ] Ensure animations run at 60fps (use `requestAnimationFrame` if needed)
  - [ ] Prevent layout shifts during animation (use fixed positioning)
  - [ ] Add backdrop fade-in animation
  - [ ] Test animation performance with browser DevTools

- [ ] Task 10: Implement keyboard navigation and accessibility (AC: 9)
  - [ ] Focus trap: trap focus within panel when open
  - [ ] Focus management: focus first focusable element when panel opens
  - [ ] Keyboard shortcuts: ESC to close, Tab to navigate fields
  - [ ] ARIA labels: add descriptive labels for all interactive elements
  - [ ] Screen reader support: announce panel open/close, task details
  - [ ] Use semantic HTML: `<section>`, `<header>`, `<main>` for panel structure
  - [ ] Add `aria-describedby` for form fields
  - [ ] Test with keyboard-only navigation
  - [ ] Test with screen reader (NVDA/JAWS/VoiceOver)

- [ ] Task 11: Add unit tests for TaskDetailPanel component (AC: All)
  - [ ] Create `tests/unit/components/task/TaskDetailPanel.test.tsx`
  - [ ] Test panel opens/closes correctly
  - [ ] Test task data displays correctly
  - [ ] Test inline editing saves changes
  - [ ] Test close button functionality
  - [ ] Test ESC key closes panel
  - [ ] Test click outside closes panel
  - [ ] Test keyboard navigation
  - [ ] Use React Testing Library with proper queries
  - [ ] Mock TaskContext and related contexts

- [ ] Task 12: Add unit tests for TaskContext panel methods (AC: 1, 5)
  - [ ] Update `tests/unit/contexts/TaskContext.test.tsx`
  - [ ] Test `openTaskPanel()` method
  - [ ] Test `closeTaskPanel()` method
  - [ ] Test `getSelectedTask()` method
  - [ ] Test panel state updates trigger re-renders
  - [ ] Test panel closes when task deleted

- [ ] Task 13: Add unit tests for TimeEntriesList component (AC: 8)
  - [ ] Create `tests/unit/components/task/TimeEntriesList.test.tsx`
  - [ ] Test time entries display correctly
  - [ ] Test add time entry functionality
  - [ ] Test edit time entry functionality
  - [ ] Test delete time entry functionality
  - [ ] Test total time calculation
  - [ ] Mock TimeEntryRepository

- [ ] Task 14: Add integration tests for panel workflow (AC: All)
  - [ ] Create `tests/integration/TaskDetailPanel.test.tsx`
  - [ ] Test complete workflow: open panel → edit task → save → close
  - [ ] Test time entry management workflow
  - [ ] Test panel interactions with kanban board (drag-and-drop still works)
  - [ ] Test responsive behavior (if possible with testing library)
  - [ ] Use React Testing Library with full context providers

- [ ] Task 15: Add E2E tests for task detail panel (AC: All)
  - [ ] Create `tests/e2e/task-detail-panel.spec.ts`
  - [ ] Test opening panel from task card click
  - [ ] Test editing task fields and auto-save
  - [ ] Test adding/editing/deleting time entries
  - [ ] Test closing panel via button, ESC, click outside
  - [ ] Test keyboard navigation within panel
  - [ ] Test responsive behavior on different screen sizes
  - [ ] Use Playwright for E2E testing

## Dev Notes

### Previous Story Insights

From Story 3.7 (Task Filtering):
- FilterContext pattern established for managing UI state
- TaskContext already has methods for task operations (updateTask, etc.)
- Component organization: `src/components/kanban/` for kanban-related components
- Testing patterns: React Testing Library with context providers, async handling with proper waitFor usage
- Performance considerations: useMemo for filtered data, avoid unnecessary re-renders
- Accessibility: ARIA labels, keyboard navigation patterns established

### Data Models

**Task Model** [Source: architecture/common/data-models.md#task]:
```typescript
interface Task {
  id: string;
  title: string;
  description?: string;
  columnId: string;
  position: number;
  clientId: string | null;
  projectId: string | null;
  isBillable: boolean;
  hourlyRate: number | null;
  timeEstimate: number | null; // in minutes
  dueDate: Date | null;
  priority: 'low' | 'medium' | 'high' | null;
  tags: string[];
  createdAt: Date;
  updatedAt: Date;
}
```

**TimeEntry Model** [Source: architecture/common/data-models.md#timeentry]:
```typescript
interface TimeEntry {
  id: string;
  taskId: string;
  startTime: Date;
  endTime: Date | null;
  duration: number; // in minutes
  isManual: boolean;
  description?: string;
  createdAt: Date;
  updatedAt: Date;
}
```

**Key Relationships:**
- Task has many TimeEntry records (one-to-many)
- Task belongs to Client (via clientId, optional)
- Task belongs to Project (via projectId, optional, requires clientId)

### Component Specifications

**TaskDetailPanel Component** [Source: architecture/common/frontend-architecture.md#component-architecture]:
- Location: `src/components/task/TaskDetailPanel.tsx`
- Should follow component template pattern from frontend architecture
- Use React Context API for state management (TaskContext, ClientContext, ProjectContext)
- Use existing components: ClientSelector, ProjectSelector (from previous stories)

**Component Structure:**
```
TaskDetailPanel
├── PanelHeader (close button, task title)
├── PanelContent (scrollable)
│   ├── TaskBasicInfo (title, description)
│   ├── TaskMetadata (due date, priority, tags)
│   ├── TaskAssignment (client, project)
│   ├── TaskBilling (billable toggle, hourly rate)
│   ├── TaskTimeTracking (time estimate, time spent)
│   └── TimeEntriesList (list of time entries with add/edit/delete)
└── PanelFooter (optional: save button if not auto-save)
```

**TimeEntriesList Component:**
- Location: `src/components/task/TimeEntriesList.tsx`
- Displays list of TimeEntry records
- Allows add/edit/delete operations
- Uses TimeEntryRepository for data access

### File Locations

Based on project structure [Source: architecture/unified-project-structure.md]:
- Component: `src/components/task/TaskDetailPanel.tsx`
- Component: `src/components/task/TimeEntriesList.tsx`
- Context updates: `src/contexts/TaskContext.tsx`
- Repository: `src/services/data/repositories/TimeEntryRepository.ts` (should already exist)
- Types: `src/types/task.ts`, `src/types/timeEntry.ts`
- Utils: `src/utils/timeUtils.ts` (for time formatting)
- Unit tests: `tests/unit/components/task/TaskDetailPanel.test.tsx`
- Unit tests: `tests/unit/components/task/TimeEntriesList.test.tsx`
- Integration tests: `tests/integration/TaskDetailPanel.test.tsx`
- E2E tests: `tests/e2e/task-detail-panel.spec.ts`

### API Specifications

**N/A - No Backend API** [Source: architecture/common/frontend-architecture.md#api-client-setup]

All data operations use repositories:
- `TaskRepository.updateTask(id: string, updates: Partial<Task>)` - Update task fields
- `TimeEntryRepository.getByTaskId(taskId: string)` - Get time entries for task
- `TimeEntryRepository.create(timeEntry: TimeEntry)` - Create new time entry
- `TimeEntryRepository.update(id: string, updates: Partial<TimeEntry>)` - Update time entry
- `TimeEntryRepository.delete(id: string)` - Delete time entry

### Technical Constraints

**Performance Requirements** [Source: architecture/common/coding-standards.md#critical-frontend-rules]:
- Use React.memo, useMemo, useCallback appropriately to prevent unnecessary re-renders
- Debounce auto-save operations (500ms delay) to prevent excessive IndexedDB writes
- Ensure animations run at 60fps (use CSS transforms, avoid layout-triggering properties)
- Use `will-change: transform` for animation performance

**State Management** [Source: architecture/common/frontend-architecture.md#state-management-architecture]:
- Use TaskContext for task state and panel state
- Use optimistic updates: update UI immediately, then sync to IndexedDB
- Handle errors gracefully with Error Boundaries

**Accessibility Requirements** [Source: architecture/common/accessibility-implementation.md]:
- WCAG 2.1 AA compliance required
- All interactive elements must have ARIA labels
- Keyboard navigation support (Tab, ESC, Enter/Space)
- Focus trap within panel when open
- Screen reader compatibility (semantic HTML, ARIA attributes)
- Focus management: restore focus to task card after panel closes

**Animation Requirements** [Source: AC 10]:
- Smooth 60fps animations
- No layout shifts during animation
- Use CSS transitions with transform property
- Backdrop fade-in animation

### Testing Requirements

**Unit Testing** [Source: architecture/common/testing-strategy.md#test-organization]:
- Test file location: `tests/unit/components/task/TaskDetailPanel.test.tsx`
- Use Jest + React Testing Library
- Mock contexts and repositories
- Test component rendering, user interactions, state updates
- Aim for 80%+ code coverage

**Integration Testing** [Source: architecture/common/testing-strategy.md#test-organization]:
- Test file location: `tests/integration/TaskDetailPanel.test.tsx`
- Test complete workflows with real context providers
- Test interactions between components
- Use React Testing Library with proper async handling

**E2E Testing** [Source: architecture/common/testing-strategy.md#test-organization]:
- Test file location: `tests/e2e/task-detail-panel.spec.ts`
- Use Playwright for browser testing
- Test complete user workflows
- Test responsive behavior on different screen sizes

**Accessibility Testing** [Source: architecture/common/accessibility-implementation.md#accessibility-testing]:
- Use jest-axe for automated accessibility testing
- Test keyboard navigation manually
- Test with screen readers (NVDA/JAWS/VoiceOver)
- Verify ARIA attributes are correct

### Project Structure Notes

**Component Organization** [Source: architecture/common/frontend-architecture.md#component-organization]:
- Task-related components go in `src/components/task/` directory
- Follow existing component patterns from kanban components
- Use TypeScript interfaces for props
- One component per file

**Styling** [Source: architecture/common/tech-stack.md]:
- Use Tailwind CSS ^3.4.0 for styling
- Use utility classes for responsive design
- Follow existing design patterns from kanban board

**No Specific Guidance Found:**
- Focus trap implementation details (use library like focus-trap-react or implement custom)
- Auto-save debounce timing (500ms is standard, but not specified in architecture)
- Panel width specifications (400-500px suggested, but not specified)

## Testing

### Testing Standards

**Test File Location** [Source: architecture/common/testing-strategy.md#test-organization]:
- Unit tests: `tests/unit/components/task/`
- Integration tests: `tests/integration/`
- E2E tests: `tests/e2e/`

**Testing Frameworks** [Source: architecture/common/tech-stack.md]:
- Jest ^29.7.0 for unit and integration testing
- React Testing Library ^14.0.0 for component testing
- Playwright ^1.40.0 for E2E testing

**Testing Patterns** [Source: architecture/common/testing-strategy.md#test-examples]:
- Use React Testing Library queries (getByRole, getByLabelText, etc.)
- Mock contexts and repositories
- Test user interactions, not implementation details
- Use proper async handling with waitFor

**Accessibility Testing** [Source: architecture/common/accessibility-implementation.md#accessibility-testing]:
- Install and use jest-axe: `npm install --save-dev jest-axe`
- Add accessibility tests to component test suites
- Test keyboard navigation manually
- Test with screen readers

**Specific Testing Requirements for This Story:**
- Test panel open/close functionality
- Test inline editing and auto-save
- Test time entry CRUD operations
- Test keyboard navigation (Tab, ESC)
- Test focus management (focus trap, focus restoration)
- Test responsive behavior
- Test animation performance (60fps requirement)
- Test accessibility (ARIA attributes, screen reader compatibility)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-26 | 1.0 | Initial story draft | Scrum Master |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results

_Results from QA Agent review will be populated here after implementation_
