# Story 4.2: Search and Filter Functionality

## Status
Draft

## Story
**As a** user,
**I want** to search for tasks by keywords and filter by various criteria,
**so that** I can quickly find specific tasks in my board.

## Acceptance Criteria

1. Search bar is accessible from kanban board (top of board or header)
2. Search searches task titles, descriptions, and tags
3. Search results highlight matching text
4. Search updates results in real-time as user types
5. Search can be cleared to show all tasks
6. Filter options include: client, project, billable status, priority, due date range, tags
7. Multiple filters can be combined (AND logic)
8. Active filters are displayed with clear/remove options
9. Filter state is visually indicated on board
10. Search and filter work together (search within filtered results)
11. Search/filter performance is fast even with 1000+ tasks
12. Search is accessible via keyboard shortcut (Ctrl/Cmd + F)

## Tasks / Subtasks

- [ ] Task 1: Extend FilterContext to support search and additional filters (AC: 6, 7, 10)
  - [ ] Update `src/contexts/FilterContext.tsx`
  - [ ] Extend FilterState interface to include:
    - [ ] `searchQuery: string` - Search text query
    - [ ] `billableStatus: boolean | null` - Filter by billable status (null = no filter)
    - [ ] `priority: 'low' | 'medium' | 'high' | null` - Filter by priority (null = no filter)
    - [ ] `dueDateRange: { start: Date | null, end: Date | null }` - Filter by due date range
    - [ ] `tags: string[]` - Filter by tags (array of tag strings, empty = no filter)
  - [ ] Keep existing `clientId` and `projectId` filters
  - [ ] Add methods: `setSearchQuery(query: string)`, `setBillableFilter(status: boolean | null)`, `setPriorityFilter(priority: 'low' | 'medium' | 'high' | null)`, `setDueDateRange(start: Date | null, end: Date | null)`, `setTagFilters(tags: string[])`, `addTagFilter(tag: string)`, `removeTagFilter(tag: string)`
  - [ ] Update `clearFilters()` to reset all filters including search
  - [ ] Ensure filter state doesn't persist across sessions (session-only, per AC from 3.7)

- [ ] Task 2: Create SearchBar component (AC: 1, 2, 4, 5, 12)
  - [ ] Create `src/components/kanban/SearchBar.tsx`
  - [ ] Implement search input with search icon
  - [ ] Add clear button (X icon) that appears when search query exists
  - [ ] Debounce search input (300ms delay) to prevent excessive filtering on every keystroke
  - [ ] Use FilterContext to manage search query state
  - [ ] Position search bar at top of kanban board (above TaskFilterBar or integrated)
  - [ ] Add keyboard shortcut handler: Ctrl/Cmd + F to focus search input
  - [ ] Ensure search input is accessible (ARIA labels, keyboard navigation)
  - [ ] Show placeholder text: "Search tasks by title, description, or tags..."
  - [ ] Style consistently with existing filter bar

- [ ] Task 3: Implement search logic in TaskContext (AC: 2, 10, 11)
  - [ ] Update `src/contexts/TaskContext.tsx`
  - [ ] Create `searchTasks(tasks: Task[], query: string): Task[]` method
  - [ ] Search logic:
    - [ ] Search in task.title (case-insensitive, partial match)
    - [ ] Search in task.description (case-insensitive, partial match)
    - [ ] Search in task.tags array (case-insensitive, exact or partial match)
    - [ ] Return tasks that match any of the above fields (OR logic within search)
  - [ ] Use useMemo to memoize search results for performance
  - [ ] Optimize search for 1000+ tasks (consider using Set for tag lookups, early returns)
  - [ ] Update `getFilteredTasks()` to accept full FilterState (including search)
  - [ ] Combine search with existing filters (apply search first, then apply other filters)
  - [ ] Update `getFilteredTasksByColumnId()` to use combined search + filters

- [ ] Task 4: Implement text highlighting for search results (AC: 3)
  - [ ] Create `src/utils/searchUtils.ts` utility file
  - [ ] Create `highlightText(text: string, query: string): React.ReactNode` function
  - [ ] Function should wrap matching text in `<mark>` tags or styled span
  - [ ] Handle case-insensitive matching
  - [ ] Handle partial word matches
  - [ ] Escape HTML in text to prevent XSS
  - [ ] Create `highlightTaskTitle(task: Task, query: string): React.ReactNode` helper
  - [ ] Create `highlightTaskDescription(task: Task, query: string): React.ReactNode` helper
  - [ ] Update TaskCard component to use highlighting when search query exists
  - [ ] Style highlighted text with background color (e.g., yellow highlight)

- [ ] Task 5: Extend TaskFilterBar with additional filter controls (AC: 6, 7, 8)
  - [ ] Update `src/components/kanban/TaskFilterBar.tsx`
  - [ ] Add billable status filter dropdown: "All", "Billable", "Non-billable"
  - [ ] Add priority filter dropdown: "All", "Low", "Medium", "High"
  - [ ] Add due date range filter (date picker inputs for start and end dates)
  - [ ] Add tags filter (multi-select or tag input component)
  - [ ] Update filter badges to show all active filters (not just client/project)
  - [ ] Add remove buttons for each filter badge
  - [ ] Ensure filters work together (AND logic - all filters must match)
  - [ ] Update clear filters button to clear all filters including search
  - [ ] Maintain existing client/project filter functionality
  - [ ] Ensure responsive layout (filters wrap on smaller screens)

- [ ] Task 6: Integrate SearchBar into KanbanBoard (AC: 1, 9)
  - [ ] Update `src/components/kanban/KanbanBoard.tsx`
  - [ ] Import SearchBar component
  - [ ] Render SearchBar above TaskFilterBar (or integrate into filter bar)
  - [ ] Ensure search bar is visible and accessible
  - [ ] Update Column component to use combined search + filters
  - [ ] Ensure filtered/searched tasks display correctly
  - [ ] Ensure drag-and-drop still works with search/filters active

- [ ] Task 7: Implement keyboard shortcut for search (AC: 12)
  - [ ] Create `src/hooks/useKeyboardShortcut.ts` hook (or add to existing hooks)
  - [ ] Implement keyboard shortcut handler for Ctrl/Cmd + F
  - [ ] Handler should focus search input when shortcut is pressed
  - [ ] Prevent browser default search behavior (e.g., browser find dialog)
  - [ ] Handle both Windows/Linux (Ctrl) and Mac (Cmd) modifiers
  - [ ] Add keyboard shortcut to SearchBar component
  - [ ] Ensure shortcut doesn't conflict with other shortcuts
  - [ ] Add visual indicator or tooltip showing keyboard shortcut

- [ ] Task 8: Update Column component to use combined search + filters (AC: 9, 10)
  - [ ] Update `src/components/kanban/Column.tsx`
  - [ ] Import FilterContext to get full filter state (including search)
  - [ ] Use `getFilteredTasksByColumnId()` with full FilterState
  - [ ] Ensure search highlighting is applied to task cards
  - [ ] Ensure filtered/searched tasks display correctly in columns
  - [ ] Ensure empty state message shows when no tasks match search/filters
  - [ ] Test that drag-and-drop works with search/filters active

- [ ] Task 9: Optimize search/filter performance (AC: 11)
  - [ ] Review and optimize `searchTasks()` method in TaskContext
    - [ ] Use useMemo to cache search results when query/filters haven't changed
    - [ ] Consider using Set for tag lookups (O(1) vs O(n))
    - [ ] Use early returns for empty queries
    - [ ] Avoid unnecessary string operations
  - [ ] Debounce search input (already in Task 2, verify 300ms is optimal)
  - [ ] Memoize filter calculations in FilterContext
  - [ ] Use React.memo on TaskCard to prevent unnecessary re-renders
  - [ ] Profile performance with 1000+ tasks using React DevTools Profiler
  - [ ] Consider virtual scrolling if performance issues persist (already available via @tanstack/react-virtual)

- [ ] Task 10: Update TaskCard to show search highlighting (AC: 3)
  - [ ] Update `src/components/kanban/TaskCard.tsx`
  - [ ] Import search highlighting utilities from searchUtils
  - [ ] Get search query from FilterContext
  - [ ] Apply highlighting to task title when search query exists
  - [ ] Apply highlighting to task description when search query exists (if visible)
  - [ ] Highlight matching tags in tag display
  - [ ] Ensure highlighting doesn't break task card layout
  - [ ] Style highlighted text appropriately (background color, contrast)

- [ ] Task 11: Add visual indicators for active search/filters (AC: 8, 9)
  - [ ] Update TaskFilterBar component
  - [ ] Show search query as a badge/chip when active
  - [ ] Show all active filter badges (client, project, billable, priority, date range, tags)
  - [ ] Each badge should have remove button (X icon)
  - [ ] Update "Clear Filters" button to also clear search
  - [ ] Show count of filtered tasks (e.g., "Showing 15 of 100 tasks")
  - [ ] Ensure badges are accessible (keyboard navigation, ARIA labels)
  - [ ] Style badges consistently with existing filter badges

- [ ] Task 12: Handle edge cases and validation (AC: All)
  - [ ] Handle empty search query (show all tasks)
  - [ ] Handle special characters in search query (escape regex if using regex)
  - [ ] Handle empty filter states (null/empty values)
  - [ ] Handle date range edge cases (start date after end date)
  - [ ] Handle tag filter with non-existent tags
  - [ ] Validate filter state consistency
  - [ ] Handle performance edge cases (very long search queries, many tags)
  - [ ] Ensure filters reset correctly when cleared

- [ ] Task 13: Add unit tests for search functionality (AC: 2, 3, 11)
  - [ ] Create `tests/unit/utils/searchUtils.test.ts`
  - [ ] Test `highlightText()` function with various inputs
  - [ ] Test case-insensitive matching
  - [ ] Test partial word matching
  - [ ] Test HTML escaping
  - [ ] Update `tests/unit/contexts/TaskContext.test.tsx`
  - [ ] Test `searchTasks()` method with various queries
  - [ ] Test search in titles, descriptions, tags
  - [ ] Test search performance with large task arrays (1000+ tasks)
  - [ ] Test combined search + filters

- [ ] Task 14: Add unit tests for FilterContext extensions (AC: 6, 7)
  - [ ] Update `tests/unit/contexts/FilterContext.test.tsx`
  - [ ] Test new filter state properties (searchQuery, billableStatus, priority, etc.)
  - [ ] Test new filter methods (setSearchQuery, setBillableFilter, etc.)
  - [ ] Test filter combinations (multiple filters together)
  - [ ] Test clearFilters() resets all filters including search
  - [ ] Test filter state doesn't persist (session-only)

- [ ] Task 15: Add unit tests for SearchBar component (AC: 1, 4, 5, 12)
  - [ ] Create `tests/unit/components/kanban/SearchBar.test.tsx`
  - [ ] Test search input renders correctly
  - [ ] Test search updates FilterContext on input change
  - [ ] Test debouncing works correctly
  - [ ] Test clear button appears/disappears based on query
  - [ ] Test clear button clears search
  - [ ] Test keyboard shortcut (Ctrl/Cmd + F) focuses input
  - [ ] Test accessibility (ARIA labels, keyboard navigation)

- [ ] Task 16: Add integration tests for search and filter workflow (AC: All)
  - [ ] Create `tests/integration/SearchAndFilter.test.tsx`
  - [ ] Test complete workflow: search → filter → clear
  - [ ] Test search + multiple filters work together
  - [ ] Test search highlighting displays correctly
  - [ ] Test filter badges display correctly
  - [ ] Test clear filters clears everything including search
  - [ ] Test keyboard shortcut integration
  - [ ] Test performance with large datasets
  - [ ] Use React Testing Library with full context providers

- [ ] Task 17: Add E2E tests for search and filter (AC: All)
  - [ ] Create `tests/e2e/search-and-filter.spec.ts`
  - [ ] Test search functionality end-to-end
  - [ ] Test filter functionality end-to-end
  - [ ] Test search + filter combination
  - [ ] Test keyboard shortcut (Ctrl/Cmd + F)
  - [ ] Test search highlighting in browser
  - [ ] Test filter badges and remove buttons
  - [ ] Test performance with 1000+ tasks
  - [ ] Use Playwright for E2E testing

## Dev Notes

### Previous Story Insights

From Story 3.7 (Task Filtering by Client and Project):
- FilterContext already exists with clientId and projectId filters
- TaskFilterBar component exists for client/project filtering
- TaskContext has `getFilteredTasks()` and `getFilteredTasksByColumnId()` methods
- Filter state is session-only (doesn't persist across app reloads)
- Filter badges pattern established for showing active filters
- Performance considerations: useMemo for filtered data, avoid unnecessary re-renders
- Testing patterns: React Testing Library with context providers, async handling

From Story 4.1 (Task Detail Side Panel):
- Component organization: `src/components/task/` for task-related components
- Accessibility patterns: ARIA labels, keyboard navigation, focus management
- Performance: debouncing for auto-save (500ms), useMemo/useCallback for optimization

**Key Integration Points:**
- Story 4.2 extends existing FilterContext (doesn't replace it)
- Story 4.2 extends existing TaskFilterBar (adds more filter controls)
- Story 4.2 extends TaskContext filtering logic (adds search capability)
- Story 4.2 integrates with existing Column and TaskCard components

### Data Models

**Task Model** [Source: architecture/common/data-models.md#task]:
```typescript
interface Task {
  id: string;
  title: string;
  description?: string;
  columnId: string;
  position: number;
  clientId: string | null;
  projectId: string | null;
  isBillable: boolean;
  hourlyRate: number | null;
  timeEstimate: number | null; // in minutes
  dueDate: Date | null;
  priority: 'low' | 'medium' | 'high' | null;
  tags: string[];
  createdAt: Date;
  updatedAt: Date;
}
```

**Extended FilterState Interface** (to be added):
```typescript
interface FilterState {
  // Existing filters from Story 3.7
  clientId: string | null;
  projectId: string | null;
  
  // New filters for Story 4.2
  searchQuery: string;                    // Search text (empty string = no search)
  billableStatus: boolean | null;         // null = no filter, true = billable only, false = non-billable only
  priority: 'low' | 'medium' | 'high' | null;  // null = no filter
  dueDateRange: {                         // null dates = no filter for that bound
    start: Date | null;
    end: Date | null;
  };
  tags: string[];                         // Empty array = no filter, non-empty = tasks must have at least one matching tag
}
```

**Key Relationships:**
- Task has tags (string array) - search matches against these
- Task has description (optional string) - search matches against this
- Task has title (required string) - search matches against this
- Task belongs to Client (via clientId, optional) - filter by this
- Task belongs to Project (via projectId, optional) - filter by this

### Component Specifications

**SearchBar Component** [Source: architecture/common/frontend-architecture.md#component-architecture]:
- Location: `src/components/kanban/SearchBar.tsx`
- Should follow component template pattern from frontend architecture
- Use FilterContext for search query state management
- Debounce search input (300ms) to prevent excessive filtering
- Include clear button (X icon) when search query exists
- Support keyboard shortcut: Ctrl/Cmd + F to focus input

**Extended TaskFilterBar Component:**
- Location: `src/components/kanban/TaskFilterBar.tsx` (update existing)
- Add new filter controls: billable status, priority, due date range, tags
- Maintain existing client/project filter functionality
- Show all active filters as badges with remove buttons
- Update clear filters to include search

**Search Utilities:**
- Location: `src/utils/searchUtils.ts` (new file)
- Functions: `highlightText()`, `highlightTaskTitle()`, `highlightTaskDescription()`
- Handle case-insensitive matching, HTML escaping, partial matches

### File Locations

Based on project structure [Source: architecture/unified-project-structure.md]:
- Component: `src/components/kanban/SearchBar.tsx` (new)
- Component: `src/components/kanban/TaskFilterBar.tsx` (update existing)
- Component: `src/components/kanban/TaskCard.tsx` (update existing for highlighting)
- Component: `src/components/kanban/Column.tsx` (update existing for combined filters)
- Component: `src/components/kanban/KanbanBoard.tsx` (update existing to include SearchBar)
- Context: `src/contexts/FilterContext.tsx` (extend existing)
- Context: `src/contexts/TaskContext.tsx` (extend existing filtering methods)
- Hook: `src/hooks/useKeyboardShortcut.ts` (new, or add to existing hooks file)
- Utils: `src/utils/searchUtils.ts` (new)
- Types: `src/types/task.ts` (already exists, no changes needed)
- Unit tests: `tests/unit/components/kanban/SearchBar.test.tsx` (new)
- Unit tests: `tests/unit/utils/searchUtils.test.ts` (new)
- Unit tests: `tests/unit/contexts/FilterContext.test.tsx` (update existing)
- Unit tests: `tests/unit/contexts/TaskContext.test.tsx` (update existing)
- Integration tests: `tests/integration/SearchAndFilter.test.tsx` (new)
- E2E tests: `tests/e2e/search-and-filter.spec.ts` (new)

### API Specifications

**N/A - No Backend API** [Source: architecture/common/frontend-architecture.md#api-client-setup]

All filtering and search operations happen client-side:
- FilterContext manages filter state (React Context API)
- TaskContext provides filtering methods that operate on in-memory task array
- Search operations are performed on task data in memory
- No IndexedDB queries needed for filtering (tasks already loaded)

### Technical Constraints

**Performance Requirements** [Source: architecture/common/coding-standards.md#critical-frontend-rules]:
- Use React.memo, useMemo, useCallback appropriately to prevent unnecessary re-renders
- Debounce search input (300ms delay) to prevent excessive filtering on every keystroke
- Memoize search results when query/filters haven't changed
- Optimize search algorithm for 1000+ tasks (use Set for tag lookups, early returns)
- Consider virtual scrolling if performance issues persist (@tanstack/react-virtual already available)

**State Management** [Source: architecture/common/frontend-architecture.md#state-management-architecture]:
- Extend existing FilterContext (don't replace it)
- Filter state is session-only (doesn't persist to IndexedDB, per Story 3.7 AC 9)
- Use optimistic updates for filter state changes (immediate UI update)
- Handle filter state changes efficiently

**Search Algorithm Considerations:**
- Case-insensitive matching
- Partial word matching (e.g., "dev" matches "development")
- Search in multiple fields (title, description, tags) with OR logic
- Escape special characters if using regex (or use simple string matching)
- Consider performance: avoid regex if possible, use simple string.includes()

**Accessibility Requirements** [Source: architecture/common/accessibility-implementation.md]:
- WCAG 2.1 AA compliance required
- All interactive elements must have ARIA labels
- Keyboard navigation support (Tab, Enter/Space)
- Keyboard shortcut: Ctrl/Cmd + F to focus search input
- Screen reader compatibility (announce search results, filter changes)
- Focus management: focus search input when keyboard shortcut is pressed

**Text Highlighting Requirements:**
- Highlight matching text in task titles and descriptions
- Use semantic HTML (`<mark>` tag) or styled spans
- Escape HTML in text to prevent XSS
- Ensure highlighted text has sufficient contrast
- Style highlighted text with background color (e.g., yellow highlight)

### Testing Requirements

**Unit Testing** [Source: architecture/common/testing-strategy.md#test-organization]:
- Test file locations: `tests/unit/components/kanban/`, `tests/unit/utils/`, `tests/unit/contexts/`
- Use Jest + React Testing Library
- Mock contexts and repositories
- Test search algorithm with various inputs
- Test filter combinations
- Test performance with large datasets (1000+ tasks)
- Aim for 80%+ code coverage

**Integration Testing** [Source: architecture/common/testing-strategy.md#test-organization]:
- Test file location: `tests/integration/SearchAndFilter.test.tsx`
- Test complete workflows with real context providers
- Test search + filter combinations
- Test keyboard shortcut integration
- Use React Testing Library with proper async handling

**E2E Testing** [Source: architecture/common/testing-strategy.md#test-organization]:
- Test file location: `tests/e2e/search-and-filter.spec.ts`
- Use Playwright for browser testing
- Test complete user workflows
- Test keyboard shortcut in browser
- Test performance with 1000+ tasks
- Test search highlighting in browser

**Accessibility Testing** [Source: architecture/common/accessibility-implementation.md#accessibility-testing]:
- Use jest-axe for automated accessibility testing
- Test keyboard navigation manually
- Test keyboard shortcut functionality
- Test with screen readers (NVDA/JAWS/VoiceOver)
- Verify ARIA attributes are correct

### Project Structure Notes

**Component Organization** [Source: architecture/common/frontend-architecture.md#component-organization]:
- Kanban-related components go in `src/components/kanban/` directory
- Follow existing component patterns from TaskFilterBar
- Use TypeScript interfaces for props
- One component per file

**Context Extensions:**
- Extend existing FilterContext (don't create new context)
- Extend existing TaskContext filtering methods (don't replace them)
- Maintain backward compatibility with Story 3.7 filtering

**Styling** [Source: architecture/common/tech-stack.md]:
- Use Tailwind CSS ^3.4.0 for styling
- Use utility classes for responsive design
- Follow existing design patterns from TaskFilterBar
- Style search bar consistently with filter bar

**No Specific Guidance Found:**
- Search debounce timing (300ms is standard, but not specified in architecture)
- Text highlighting implementation details (use `<mark>` tag or styled spans)
- Keyboard shortcut library preference (implement custom or use library)
- Date range picker component preference (use native HTML5 date inputs or library)

## Testing

### Testing Standards

**Test File Location** [Source: architecture/common/testing-strategy.md#test-organization]:
- Unit tests: `tests/unit/components/kanban/`, `tests/unit/utils/`, `tests/unit/contexts/`
- Integration tests: `tests/integration/`
- E2E tests: `tests/e2e/`

**Testing Frameworks** [Source: architecture/common/tech-stack.md]:
- Jest ^29.7.0 for unit and integration testing
- React Testing Library ^14.0.0 for component testing
- Playwright ^1.40.0 for E2E testing

**Testing Patterns** [Source: architecture/common/testing-strategy.md#test-examples]:
- Use React Testing Library queries (getByRole, getByLabelText, etc.)
- Mock contexts and repositories
- Test user interactions, not implementation details
- Use proper async handling with waitFor
- Test performance with large datasets

**Accessibility Testing** [Source: architecture/common/accessibility-implementation.md#accessibility-testing]:
- Install and use jest-axe: `npm install --save-dev jest-axe`
- Add accessibility tests to component test suites
- Test keyboard navigation manually
- Test keyboard shortcut functionality
- Test with screen readers

**Specific Testing Requirements for This Story:**
- Test search functionality (titles, descriptions, tags)
- Test text highlighting
- Test all filter types (billable, priority, date range, tags)
- Test filter combinations (AND logic)
- Test search + filter combination
- Test keyboard shortcut (Ctrl/Cmd + F)
- Test performance with 1000+ tasks
- Test debouncing behavior
- Test filter badges and remove buttons
- Test clear filters functionality

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-26 | 1.0 | Initial story draft | Scrum Master |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results

_Results from QA Agent review will be populated here after implementation_
