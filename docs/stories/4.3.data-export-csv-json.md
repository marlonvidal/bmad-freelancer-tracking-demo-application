# Story 4.3: Data Export (CSV and JSON)

## Status
Draft

## Story
**As a** user,
**I want** to export my time tracking data and tasks,
**so that** I can backup my data or use it in other tools.

## Acceptance Criteria

1. Export functionality is accessible from settings or main menu
2. User can export time tracking data to CSV format
3. User can export time tracking data to JSON format
4. User can export all tasks with their data to CSV/JSON
5. Export includes: tasks, time entries, clients, projects, rates, billable status
6. CSV export is properly formatted with headers and comma-separated values
7. JSON export is well-structured and valid JSON
8. Export handles large datasets efficiently (streaming or chunking if needed)
9. Export file downloads with descriptive filename (includes date)
10. Export can be filtered by date range (future enhancement consideration)
11. Export preserves data relationships (tasks linked to clients/projects)
12. Exported data can be imported back (round-trip capability for backup/restore)

## Tasks / Subtasks

- [ ] Task 1: Create ExportService class (AC: 2, 3, 4, 5, 6, 7, 8, 11)
  - [ ] Create `src/services/ExportService.ts`
  - [ ] Implement `exportTimeEntries(format: 'csv' | 'json', filters?: ExportFilters): Promise<void>` method
  - [ ] Implement `exportTasks(format: 'csv' | 'json', filters?: ExportFilters): Promise<void>` method
  - [ ] Implement `exportAllData(format: 'csv' | 'json'): Promise<void>` method (exports tasks, time entries, clients, projects)
  - [ ] Use PapaParse for CSV generation (already in tech stack)
  - [ ] Use native JSON.stringify for JSON export
  - [ ] Handle large datasets efficiently (use PapaParse streaming for CSV, chunking for JSON if needed)
  - [ ] Preserve data relationships (include clientId/projectId in exports, resolve names for CSV readability)
  - [ ] Include all required fields: tasks, time entries, clients, projects, rates, billable status
  - [ ] Handle date serialization properly (ISO 8601 format for JSON, formatted dates for CSV)

- [ ] Task 2: Create export data types and interfaces (AC: 5, 11)
  - [ ] Create `src/types/export.ts` file
  - [ ] Define `ExportFilters` interface: `{ dateRange?: { start: Date, end: Date } }`
  - [ ] Define `ExportData` interface for structured export data
  - [ ] Define `ExportedTask`, `ExportedTimeEntry`, `ExportedClient`, `ExportedProject` interfaces
  - [ ] Include relationship fields (clientId, projectId, taskId) in export interfaces
  - [ ] Include resolved names for CSV readability (clientName, projectName, taskTitle)
  - [ ] Ensure types are compatible with import (round-trip capability)

- [ ] Task 3: Implement CSV export for time entries (AC: 2, 6, 8)
  - [ ] Update ExportService
  - [ ] Fetch time entries from TimeEntryRepository (with optional date range filter)
  - [ ] Resolve task information for each time entry (task title, client name, project name)
  - [ ] Format CSV with headers: Task Title, Client, Project, Start Time, End Time, Duration (minutes), Description, Billable, Manual Entry
  - [ ] Use PapaParse to generate CSV with proper escaping (handles commas, quotes, newlines)
  - [ ] Handle large datasets using PapaParse streaming or chunking
  - [ ] Generate filename: `time-entries-YYYY-MM-DD.csv`
  - [ ] Trigger browser download using Blob and URL.createObjectURL

- [ ] Task 4: Implement CSV export for tasks (AC: 4, 6, 8)
  - [ ] Update ExportService
  - [ ] Fetch tasks from TaskRepository
  - [ ] Resolve client and project names for each task
  - [ ] Format CSV with headers: Title, Description, Client, Project, Column, Priority, Due Date, Billable, Hourly Rate, Time Estimate, Tags, Created At, Updated At
  - [ ] Handle array fields (tags) - join with semicolon or pipe separator
  - [ ] Handle date fields - format as readable dates (YYYY-MM-DD HH:MM:SS)
  - [ ] Use PapaParse for CSV generation
  - [ ] Generate filename: `tasks-YYYY-MM-DD.csv`
  - [ ] Trigger browser download

- [ ] Task 5: Implement CSV export for all data (AC: 4, 5, 6, 8)
  - [ ] Update ExportService
  - [ ] Fetch all data: tasks, time entries, clients, projects from repositories
  - [ ] Create separate CSV files or combined file with multiple sheets (browser limitation: use separate files)
  - [ ] Export clients: `clients-YYYY-MM-DD.csv` with headers: ID, Name, Default Hourly Rate, Contact Info, Created At, Updated At
  - [ ] Export projects: `projects-YYYY-MM-DD.csv` with headers: ID, Client ID, Client Name, Name, Description, Default Hourly Rate, Created At, Updated At
  - [ ] Export tasks (as in Task 4)
  - [ ] Export time entries (as in Task 3)
  - [ ] Create zip file or download multiple files (browser limitation: download separately or use JSZip library)
  - [ ] Or create single comprehensive CSV with all data (flattened structure)

- [ ] Task 6: Implement JSON export for time entries (AC: 3, 7, 8)
  - [ ] Update ExportService
  - [ ] Fetch time entries from TimeEntryRepository (with optional date range filter)
  - [ ] Include related task data (task title, client name, project name) in export
  - [ ] Structure JSON: `{ timeEntries: TimeEntry[], metadata: { exportDate, count } }`
  - [ ] Serialize dates as ISO 8601 strings
  - [ ] Use JSON.stringify with proper formatting (2-space indent for readability)
  - [ ] Handle large datasets (consider chunking if > 10MB)
  - [ ] Generate filename: `time-entries-YYYY-MM-DD.json`
  - [ ] Trigger browser download

- [ ] Task 7: Implement JSON export for tasks (AC: 4, 7, 8)
  - [ ] Update ExportService
  - [ ] Fetch tasks from TaskRepository
  - [ ] Include related data (client name, project name) for readability
  - [ ] Structure JSON: `{ tasks: Task[], clients: Client[], projects: Project[], metadata: { exportDate, taskCount, clientCount, projectCount } }`
  - [ ] Preserve relationships (include clientId, projectId, columnId)
  - [ ] Serialize dates as ISO 8601 strings
  - [ ] Generate filename: `tasks-YYYY-MM-DD.json`
  - [ ] Trigger browser download

- [ ] Task 8: Implement JSON export for all data (AC: 4, 5, 7, 8, 11)
  - [ ] Update ExportService
  - [ ] Fetch all data: tasks, time entries, clients, projects, columns, settings from repositories
  - [ ] Structure JSON: `{ tasks: Task[], timeEntries: TimeEntry[], clients: Client[], projects: Project[], columns: Column[], settings: Settings, metadata: { exportDate, version, counts } }`
  - [ ] Preserve all relationships (clientId, projectId, taskId, columnId)
  - [ ] Include metadata for import validation (export date, data version, record counts)
  - [ ] Serialize dates as ISO 8601 strings
  - [ ] Handle large datasets efficiently
  - [ ] Generate filename: `freelanceflow-backup-YYYY-MM-DD-HHMMSS.json`
  - [ ] Trigger browser download
  - [ ] Ensure JSON is valid and parseable (for round-trip import)

- [ ] Task 9: Create ExportOptions component/UI (AC: 1)
  - [ ] Create `src/components/settings/ExportOptions.tsx` component
  - [ ] Add export section to settings view
  - [ ] Provide buttons/options for:
    - [ ] Export Time Entries (CSV/JSON)
    - [ ] Export Tasks (CSV/JSON)
    - [ ] Export All Data (CSV/JSON)
  - [ ] Show loading state during export
  - [ ] Show success/error messages after export
  - [ ] Style consistently with settings UI
  - [ ] Ensure accessibility (ARIA labels, keyboard navigation)

- [ ] Task 10: Integrate ExportOptions into Settings view (AC: 1)
  - [ ] Update `src/App.tsx` settings view or create dedicated Settings component
  - [ ] Import ExportOptions component
  - [ ] Add ExportOptions to settings view layout
  - [ ] Ensure settings view is accessible from Navigation (already exists via ViewContext)
  - [ ] Test navigation to settings and export functionality

- [ ] Task 11: Add date range filtering for exports (AC: 10)
  - [ ] Update ExportOptions component
  - [ ] Add date range picker inputs (start date, end date)
  - [ ] Pass date range to ExportService methods
  - [ ] Filter time entries by date range (filter by startTime or endTime)
  - [ ] Filter tasks by date range (filter by createdAt, updatedAt, or dueDate)
  - [ ] Show date range in export filename: `time-entries-2026-01-01-to-2026-01-31.csv`
  - [ ] Handle empty date range (export all data)
  - [ ] Validate date range (start <= end)

- [ ] Task 12: Implement file download utility (AC: 9)
  - [ ] Create `src/utils/fileUtils.ts` utility file
  - [ ] Create `downloadFile(content: string | Blob, filename: string, mimeType: string): void` function
  - [ ] Handle Blob creation for CSV and JSON
  - [ ] Use URL.createObjectURL and URL.revokeObjectURL for downloads
  - [ ] Generate descriptive filenames with current date: `YYYY-MM-DD` format
  - [ ] Include timestamp for all-data exports: `YYYY-MM-DD-HHMMSS` format
  - [ ] Handle browser compatibility (Chrome, Firefox, Safari, Edge)
  - [ ] Clean up object URLs after download

- [ ] Task 13: Handle large dataset performance (AC: 8)
  - [ ] Review ExportService implementation
  - [ ] Use PapaParse streaming for CSV (if dataset > 1000 records)
  - [ ] Implement chunking for JSON (if JSON string > 10MB, split into chunks)
  - [ ] Show progress indicator for large exports
  - [ ] Use Web Workers for processing if needed (for very large datasets)
  - [ ] Test with 1000+ tasks, 5000+ time entries
  - [ ] Monitor memory usage during export
  - [ ] Handle browser memory limits gracefully

- [ ] Task 14: Ensure round-trip capability (AC: 12)
  - [ ] Review export data structure
  - [ ] Ensure all required fields are exported (IDs, relationships, timestamps)
  - [ ] Ensure date formats are parseable (ISO 8601 for JSON)
  - [ ] Ensure CSV can be parsed back (proper escaping, consistent format)
  - [ ] Document export format for future import implementation (Story 4.4)
  - [ ] Create export format specification document (optional, for reference)
  - [ ] Test that exported JSON can be parsed and validated

- [ ] Task 15: Add error handling and validation (AC: All)
  - [ ] Add try/catch blocks in ExportService methods
  - [ ] Handle repository errors gracefully
  - [ ] Validate export filters (date range validation)
  - [ ] Handle empty datasets (show message, don't create empty file)
  - [ ] Handle browser download failures
  - [ ] Show user-friendly error messages
  - [ ] Log errors for debugging

- [ ] Task 16: Add unit tests for ExportService (AC: All)
  - [ ] Create `tests/unit/services/ExportService.test.ts`
  - [ ] Mock repositories (TaskRepository, TimeEntryRepository, etc.)
  - [ ] Test CSV export for time entries
  - [ ] Test CSV export for tasks
  - [ ] Test JSON export for time entries
  - [ ] Test JSON export for tasks
  - [ ] Test JSON export for all data
  - [ ] Test date range filtering
  - [ ] Test file download utility
  - [ ] Test error handling
  - [ ] Test with large datasets (mock data)

- [ ] Task 17: Add unit tests for ExportOptions component (AC: 1)
  - [ ] Create `tests/unit/components/settings/ExportOptions.test.tsx`
  - [ ] Test component renders correctly
  - [ ] Test export buttons trigger ExportService methods
  - [ ] Test loading states
  - [ ] Test success/error messages
  - [ ] Test date range picker
  - [ ] Mock ExportService
  - [ ] Use React Testing Library

- [ ] Task 18: Add integration tests for export workflow (AC: All)
  - [ ] Create `tests/integration/ExportWorkflow.test.tsx`
  - [ ] Test complete export workflow with real repositories
  - [ ] Test CSV export downloads file
  - [ ] Test JSON export downloads file
  - [ ] Test date range filtering
  - [ ] Test export with relationships (tasks with clients/projects)
  - [ ] Use React Testing Library with full context providers
  - [ ] Mock browser download API

- [ ] Task 19: Add E2E tests for export functionality (AC: All)
  - [ ] Create `tests/e2e/export.spec.ts`
  - [ ] Test navigating to settings
  - [ ] Test exporting time entries (CSV and JSON)
  - [ ] Test exporting tasks (CSV and JSON)
  - [ ] Test exporting all data
  - [ ] Test date range filtering
  - [ ] Test file downloads (verify filename, verify file can be opened)
  - [ ] Use Playwright for E2E testing
  - [ ] Test with sample data

## Dev Notes

### Previous Story Insights

From Story 4.1 (Task Detail Side Panel):
- Component organization: `src/components/settings/` for settings-related components
- Settings view exists in App.tsx (placeholder, needs implementation)
- ViewContext manages view state including 'settings' view
- Navigation component exists and can navigate to settings

From Story 4.2 (Search and Filter Functionality):
- Performance considerations: useMemo, debouncing, optimization for large datasets
- Testing patterns: React Testing Library with context providers

**Key Integration Points:**
- Story 4.3 creates new ExportService (doesn't extend existing service - it doesn't exist yet)
- Story 4.3 integrates with existing repositories (TaskRepository, TimeEntryRepository, ClientRepository, ProjectRepository)
- Story 4.3 adds UI to existing settings view (needs to be created/expanded)
- Story 4.3 prepares data format for Story 4.4 (Backup and Restore) import functionality

### Data Models

**Task Model** [Source: architecture/common/data-models.md#task]:
```typescript
interface Task {
  id: string;
  title: string;
  description?: string;
  columnId: string;
  position: number;
  clientId: string | null;
  projectId: string | null;
  isBillable: boolean;
  hourlyRate: number | null;
  timeEstimate: number | null; // in minutes
  dueDate: Date | null;
  priority: 'low' | 'medium' | 'high' | null;
  tags: string[];
  createdAt: Date;
  updatedAt: Date;
}
```

**TimeEntry Model** [Source: architecture/common/data-models.md#timeentry]:
```typescript
interface TimeEntry {
  id: string;
  taskId: string;
  startTime: Date;
  endTime: Date | null;
  duration: number; // in minutes
  isManual: boolean;
  description?: string;
  createdAt: Date;
  updatedAt: Date;
}
```

**Client Model** [Source: architecture/common/data-models.md#client]:
```typescript
interface Client {
  id: string;
  name: string;
  defaultHourlyRate: number | null;
  contactInfo: string | null;
  createdAt: Date;
  updatedAt: Date;
}
```

**Project Model** [Source: architecture/common/data-models.md#project]:
```typescript
interface Project {
  id: string;
  clientId: string;
  name: string;
  description?: string;
  defaultHourlyRate: number | null;
  createdAt: Date;
  updatedAt: Date;
}
```

**Column Model** [Source: architecture/common/data-models.md#column]:
```typescript
interface Column {
  id: string;
  name: string;
  position: number;
  color: string | null;
  createdAt: Date;
  updatedAt: Date;
}
```

**Settings Model** [Source: architecture/common/data-models.md#settings]:
```typescript
interface Settings {
  id: 'default';
  darkMode: boolean;
  defaultBillableStatus: boolean;
  defaultHourlyRate: number | null;
  keyboardShortcuts: Record<string, string>;
  onboardingCompleted: boolean;
  updatedAt: Date;
}
```

**Export Data Structure** (to be defined):
```typescript
interface ExportFilters {
  dateRange?: {
    start: Date;
    end: Date;
  };
}

interface ExportMetadata {
  exportDate: string; // ISO 8601
  version: string; // App version
  counts: {
    tasks?: number;
    timeEntries?: number;
    clients?: number;
    projects?: number;
  };
}

interface ExportedData {
  tasks?: Task[];
  timeEntries?: TimeEntry[];
  clients?: Client[];
  projects?: Project[];
  columns?: Column[];
  settings?: Settings;
  metadata: ExportMetadata;
}
```

**Key Relationships for Export:**
- TimeEntry belongs to Task (via taskId) - include task title in export
- Task belongs to Client (via clientId, optional) - include client name in export
- Task belongs to Project (via projectId, optional) - include project name in export
- Project belongs to Client (via clientId) - include client name in project export
- All relationships must be preserved for round-trip import (Story 4.4)

### Component Specifications

**ExportService** [Source: architecture/components.md#export-service]:
- Location: `src/services/ExportService.ts`
- Responsibility: Handles data export functionality (CSV and JSON formats)
- Dependencies: Data Access Layer (repositories), PapaParse (for CSV)
- Technology Stack: TypeScript, PapaParse ^5.4.1

**ExportOptions Component:**
- Location: `src/components/settings/ExportOptions.tsx`
- Should follow component template pattern from frontend architecture
- Use ExportService for export operations
- Show loading states, success/error messages
- Include date range picker for filtering

**File Download Utility:**
- Location: `src/utils/fileUtils.ts`
- Function: `downloadFile(content: string | Blob, filename: string, mimeType: string): void`
- Handle browser compatibility
- Generate descriptive filenames with dates

### File Locations

Based on project structure [Source: architecture/unified-project-structure.md]:
- Service: `src/services/ExportService.ts` (new)
- Component: `src/components/settings/ExportOptions.tsx` (new)
- Types: `src/types/export.ts` (new)
- Utils: `src/utils/fileUtils.ts` (new)
- Settings view: `src/App.tsx` (update existing) or `src/components/settings/SettingsPanel.tsx` (new)
- Unit tests: `tests/unit/services/ExportService.test.ts` (new)
- Unit tests: `tests/unit/components/settings/ExportOptions.test.tsx` (new)
- Integration tests: `tests/integration/ExportWorkflow.test.tsx` (new)
- E2E tests: `tests/e2e/export.spec.ts` (new)

### API Specifications

**N/A - No Backend API** [Source: architecture/common/frontend-architecture.md#api-client-setup]

All export operations happen client-side:
- ExportService uses repositories to fetch data from IndexedDB
- ExportService generates CSV/JSON files in memory
- Browser Download API triggers file downloads
- No server-side processing needed

**Repository Methods Used:**
- `TaskRepository.getAll()` - Get all tasks
- `TimeEntryRepository.getAll()` - Get all time entries
- `ClientRepository.getAll()` - Get all clients
- `ProjectRepository.getAll()` - Get all projects
- `ColumnRepository.getAll()` - Get all columns (for all-data export)
- `SettingsRepository.getSettings()` - Get settings (for all-data export)

### Technical Constraints

**Performance Requirements** [Source: architecture/common/coding-standards.md#critical-frontend-rules]:
- Handle large datasets efficiently (1000+ tasks, 5000+ time entries)
- Use PapaParse streaming for CSV if dataset is large
- Consider chunking for JSON if file size > 10MB
- Show progress indicator for large exports
- Monitor memory usage during export

**CSV Export Requirements** [Source: architecture/common/tech-stack.md]:
- Use PapaParse ^5.4.1 for CSV generation
- Properly escape commas, quotes, newlines in CSV
- Include headers in CSV files
- Format dates as readable strings (YYYY-MM-DD HH:MM:SS)
- Handle array fields (tags) - join with separator

**JSON Export Requirements:**
- Use native JSON.stringify with 2-space indent for readability
- Serialize dates as ISO 8601 strings (JSON.stringify handles Date objects, but ensure consistency)
- Include metadata for import validation
- Ensure valid JSON (parseable)
- Preserve data relationships (IDs, references)

**File Download Requirements:**
- Use Blob API for file creation
- Use URL.createObjectURL and URL.revokeObjectURL
- Generate descriptive filenames with dates
- Handle browser compatibility (Chrome, Firefox, Safari, Edge)
- MIME types: `text/csv` for CSV, `application/json` for JSON

**Date Range Filtering:**
- Filter time entries by startTime or endTime within range
- Filter tasks by createdAt, updatedAt, or dueDate within range
- Validate date range (start <= end)
- Handle empty range (export all data)

**Round-Trip Capability:**
- Export format must be importable (Story 4.4)
- Preserve all IDs and relationships
- Use consistent date formats (ISO 8601 for JSON)
- Include metadata for validation
- Document export format structure

### Testing Requirements

**Unit Testing** [Source: architecture/common/testing-strategy.md#test-organization]:
- Test file locations: `tests/unit/services/`, `tests/unit/components/settings/`
- Use Jest + React Testing Library
- Mock repositories and browser APIs (download, Blob, URL)
- Test CSV generation with PapaParse
- Test JSON generation
- Test date range filtering
- Test file download utility
- Test error handling
- Test with large datasets (mock data)
- Aim for 80%+ code coverage

**Integration Testing** [Source: architecture/common/testing-strategy.md#test-organization]:
- Test file location: `tests/integration/ExportWorkflow.test.tsx`
- Test complete workflows with real repositories
- Test file downloads (mock browser APIs)
- Test date range filtering with real data
- Use React Testing Library with full context providers

**E2E Testing** [Source: architecture/common/testing-strategy.md#test-organization]:
- Test file location: `tests/e2e/export.spec.ts`
- Use Playwright for browser testing
- Test complete user workflows
- Test file downloads (verify files are created)
- Test with sample data
- Test navigation to settings

**Accessibility Testing** [Source: architecture/common/accessibility-implementation.md#accessibility-testing]:
- Use jest-axe for automated accessibility testing
- Test keyboard navigation
- Test with screen readers
- Verify ARIA labels are correct
- Ensure export buttons are accessible

### Project Structure Notes

**Service Organization** [Source: architecture/common/frontend-architecture.md#frontend-services-layer]:
- Services go in `src/services/` directory
- ExportService follows service pattern (class-based)
- Use repositories for data access (don't access IndexedDB directly)

**Component Organization** [Source: architecture/common/frontend-architecture.md#component-organization]:
- Settings-related components go in `src/components/settings/` directory
- Follow existing component patterns
- Use TypeScript interfaces for props
- One component per file

**Styling** [Source: architecture/common/tech-stack.md]:
- Use Tailwind CSS ^3.4.0 for styling
- Use utility classes for responsive design
- Follow existing design patterns from settings view

**No Specific Guidance Found:**
- CSV multi-file download approach (separate files vs zip vs single file)
- Date range picker component preference (native HTML5 or library)
- Progress indicator implementation for large exports
- JSZip library for multi-file downloads (if needed, not in tech stack)

## Testing

### Testing Standards

**Test File Location** [Source: architecture/common/testing-strategy.md#test-organization]:
- Unit tests: `tests/unit/services/`, `tests/unit/components/settings/`
- Integration tests: `tests/integration/`
- E2E tests: `tests/e2e/`

**Testing Frameworks** [Source: architecture/common/tech-stack.md]:
- Jest ^29.7.0 for unit and integration testing
- React Testing Library ^14.0.0 for component testing
- Playwright ^1.40.0 for E2E testing

**Testing Patterns** [Source: architecture/common/testing-strategy.md#test-examples]:
- Use React Testing Library queries (getByRole, getByLabelText, etc.)
- Mock repositories and browser APIs
- Test user interactions, not implementation details
- Use proper async handling with waitFor
- Test with large datasets (mock data)

**Accessibility Testing** [Source: architecture/common/accessibility-implementation.md#accessibility-testing]:
- Install and use jest-axe: `npm install --save-dev jest-axe`
- Add accessibility tests to component test suites
- Test keyboard navigation manually
- Test with screen readers

**Specific Testing Requirements for This Story:**
- Test CSV export generation (format, escaping, headers)
- Test JSON export generation (format, date serialization, structure)
- Test file download functionality
- Test date range filtering
- Test error handling
- Test with large datasets (1000+ tasks, 5000+ time entries)
- Test round-trip capability (exported data can be parsed)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-26 | 1.0 | Initial story draft | Scrum Master |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results

_Results from QA Agent review will be populated here after implementation_
