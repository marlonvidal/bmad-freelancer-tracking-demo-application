# Story 4.5: Dark Mode

## Status
Draft

## Story
**As a** user,
**I want** a dark mode option,
**so that** I can reduce eye strain during long work sessions.

## Acceptance Criteria

1. Dark mode toggle is accessible from settings or header/menu
2. Dark mode applies to entire application (kanban board, side panels, modals, settings)
3. Dark mode uses appropriate color contrast (WCAG AA compliance maintained)
4. Dark mode preference persists across browser sessions
5. Dark mode toggle is easily accessible (one-click action)
6. Color scheme is consistent and professional in dark mode
7. All UI elements are visible and readable in dark mode (text, borders, icons)
8. Dark mode doesn't affect functionality (all features work in both modes)
9. Dark mode transition is smooth (no flashing or abrupt changes)
10. System preference detection (respects OS dark mode setting) is considered (future enhancement)

## Tasks / Subtasks

- [ ] Task 1: Configure Tailwind CSS for dark mode (AC: 2, 9)
  - [ ] Update `tailwind.config.js`
  - [ ] Enable dark mode: `darkMode: 'class'` (class-based dark mode)
  - [ ] Add dark mode color palette to theme.extend.colors
  - [ ] Define dark mode colors: dark background (gray-900), dark surface (gray-800), dark text (gray-100), dark borders (gray-700)
  - [ ] Ensure color contrast ratios meet WCAG AA (4.5:1 for normal text, 3:1 for large text)
  - [ ] Test Tailwind dark mode configuration

- [ ] Task 2: Create DarkModeToggle component (AC: 1, 5)
  - [ ] Create `src/components/common/DarkModeToggle.tsx`
  - [ ] Implement toggle switch/button component
  - [ ] Use SettingsContext to get/set darkMode preference
  - [ ] Show sun icon for light mode, moon icon for dark mode
  - [ ] Add ARIA labels: "Toggle dark mode", "Dark mode on", "Dark mode off"
  - [ ] Ensure keyboard accessible (Tab, Enter/Space to toggle)
  - [ ] Style toggle consistently with application design
  - [ ] Add smooth transition animation for icon/state change

- [ ] Task 3: Add dark mode state management to SettingsContext (AC: 4)
  - [ ] Update `src/contexts/SettingsContext.tsx`
  - [ ] Add `toggleDarkMode(): Promise<void>` method
  - [ ] Add `isDarkMode(): boolean` helper method
  - [ ] Ensure darkMode preference is loaded from Settings on mount
  - [ ] Ensure darkMode preference persists via SettingsRepository
  - [ ] Use existing updateSettings method for persistence

- [ ] Task 4: Apply dark mode class to root element (AC: 2, 9)
  - [ ] Update `src/App.tsx` or `src/main.tsx`
  - [ ] Use useEffect to apply/remove 'dark' class on `<html>` or root element
  - [ ] Watch SettingsContext darkMode state
  - [ ] Apply 'dark' class when darkMode is true, remove when false
  - [ ] Ensure class is applied before initial render (prevent flash)
  - [ ] Use smooth CSS transition for class changes

- [ ] Task 5: Update Navigation component with dark mode styles (AC: 2, 6, 7)
  - [ ] Update `src/components/common/Navigation.tsx`
  - [ ] Add dark mode classes: `dark:bg-gray-900 dark:border-gray-700 dark:text-gray-100`
  - [ ] Update hover states for dark mode: `dark:hover:text-blue-400`
  - [ ] Update active states for dark mode
  - [ ] Ensure text contrast meets WCAG AA
  - [ ] Test navigation in both light and dark modes
  - [ ] Add DarkModeToggle to Navigation component (header/menu)

- [ ] Task 6: Update KanbanBoard component with dark mode styles (AC: 2, 6, 7)
  - [ ] Update `src/components/kanban/KanbanBoard.tsx`
  - [ ] Add dark mode background: `dark:bg-gray-900`
  - [ ] Update text colors: `dark:text-gray-100`
  - [ ] Update border colors: `dark:border-gray-700`
  - [ ] Ensure all UI elements are visible in dark mode
  - [ ] Test kanban board in both modes

- [ ] Task 7: Update Column component with dark mode styles (AC: 2, 6, 7)
  - [ ] Update `src/components/kanban/Column.tsx`
  - [ ] Add dark mode background: `dark:bg-gray-800`
  - [ ] Update text colors: `dark:text-gray-100`
  - [ ] Update border colors: `dark:border-gray-700`
  - [ ] Update header styles for dark mode
  - [ ] Ensure column is readable in dark mode

- [ ] Task 8: Update TaskCard component with dark mode styles (AC: 2, 6, 7)
  - [ ] Update `src/components/kanban/TaskCard.tsx`
  - [ ] Add dark mode background: `dark:bg-gray-800` or `dark:bg-gray-700`
  - [ ] Update text colors: `dark:text-gray-100`
  - [ ] Update border colors: `dark:border-gray-600`
  - [ ] Update hover states: `dark:hover:bg-gray-700`
  - [ ] Update priority badges for dark mode
  - [ ] Update tag styles for dark mode
  - [ ] Ensure all task card elements are visible

- [ ] Task 9: Update TaskDetailPanel component with dark mode styles (AC: 2, 6, 7)
  - [ ] Update `src/components/task/TaskDetailPanel.tsx` (from Story 4.1)
  - [ ] Add dark mode background: `dark:bg-gray-800`
  - [ ] Update text colors: `dark:text-gray-100`
  - [ ] Update border colors: `dark:border-gray-700`
  - [ ] Update input/textarea styles for dark mode
  - [ ] Update button styles for dark mode
  - [ ] Update backdrop/overlay for dark mode
  - [ ] Ensure panel is readable in dark mode

- [ ] Task 10: Update modal/dialog components with dark mode styles (AC: 2, 6, 7)
  - [ ] Update `src/components/common/ConfirmDialog.tsx` (if exists)
  - [ ] Add dark mode background: `dark:bg-gray-800`
  - [ ] Update text colors: `dark:text-gray-100`
  - [ ] Update border colors: `dark:border-gray-700`
  - [ ] Update backdrop/overlay: `dark:bg-black/50`
  - [ ] Update button styles for dark mode
  - [ ] Ensure modals are readable in dark mode

- [ ] Task 11: Update form components with dark mode styles (AC: 2, 6, 7)
  - [ ] Update form inputs (TaskForm, ClientForm, ProjectForm, etc.)
  - [ ] Add dark mode styles: `dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100`
  - [ ] Update placeholder text: `dark:placeholder-gray-400`
  - [ ] Update focus states: `dark:focus:ring-blue-500 dark:focus:border-blue-500`
  - [ ] Update select/dropdown styles for dark mode
  - [ ] Ensure forms are usable in dark mode

- [ ] Task 12: Update filter/search components with dark mode styles (AC: 2, 6, 7)
  - [ ] Update `src/components/kanban/TaskFilterBar.tsx` (from Story 3.7)
  - [ ] Update `src/components/kanban/SearchBar.tsx` (from Story 4.2)
  - [ ] Add dark mode background: `dark:bg-gray-800`
  - [ ] Update text colors: `dark:text-gray-100`
  - [ ] Update border colors: `dark:border-gray-700`
  - [ ] Update input styles for dark mode
  - [ ] Update badge/chip styles for dark mode
  - [ ] Ensure filters/search are readable

- [ ] Task 13: Update settings view with dark mode styles (AC: 2, 6, 7)
  - [ ] Update settings view components (SettingsPanel, ExportOptions, BackupRestoreOptions)
  - [ ] Add dark mode background: `dark:bg-gray-900`
  - [ ] Update text colors: `dark:text-gray-100`
  - [ ] Update section backgrounds: `dark:bg-gray-800`
  - [ ] Update border colors: `dark:border-gray-700`
  - [ ] Ensure settings view is readable in dark mode
  - [ ] Add DarkModeToggle to settings view (if not in header)

- [ ] Task 14: Update RevenueDashboard component with dark mode styles (AC: 2, 6, 7)
  - [ ] Update `src/components/revenue/RevenueDashboard.tsx`
  - [ ] Add dark mode background: `dark:bg-gray-900`
  - [ ] Update text colors: `dark:text-gray-100`
  - [ ] Update chart/graph colors for dark mode (if applicable)
  - [ ] Update card/panel styles for dark mode
  - [ ] Ensure dashboard is readable in dark mode

- [ ] Task 15: Update global styles for dark mode (AC: 2, 9)
  - [ ] Update `src/styles/globals.css`
  - [ ] Add dark mode base styles if needed
  - [ ] Add smooth transition for dark mode: `transition-colors duration-200`
  - [ ] Ensure no flash of unstyled content (FOUC) on initial load
  - [ ] Add dark mode scrollbar styles (optional)
  - [ ] Test global styles in both modes

- [ ] Task 16: Prevent flash of light content on initial load (AC: 9)
  - [ ] Update `src/main.tsx` or `src/App.tsx`
  - [ ] Load darkMode preference from Settings before initial render
  - [ ] Apply 'dark' class synchronously before React renders
  - [ ] Use inline script in index.html to set dark class immediately (optional)
  - [ ] Ensure no flash of light content when dark mode is enabled
  - [ ] Test page load in both light and dark modes

- [ ] Task 17: Verify WCAG AA color contrast compliance (AC: 3)
  - [ ] Review all dark mode color combinations
  - [ ] Test text contrast ratios:
    - [ ] Normal text: 4.5:1 minimum (gray-100 on gray-900 = ~12:1, passes)
    - [ ] Large text: 3:1 minimum
    - [ ] UI components: 3:1 minimum
  - [ ] Use contrast checking tools (WebAIM Contrast Checker, browser DevTools)
  - [ ] Fix any contrast issues found
  - [ ] Document color combinations used

- [ ] Task 18: Test dark mode functionality (AC: 8)
  - [ ] Test all features work in dark mode:
    - [ ] Task creation/editing
    - [ ] Timer functionality
    - [ ] Drag-and-drop
    - [ ] Filtering/searching
    - [ ] Export/backup
    - [ ] Settings
  - [ ] Test dark mode toggle works from header and settings
  - [ ] Test dark mode persists across page reloads
  - [ ] Test dark mode applies to all components
  - [ ] Test no functionality is broken in dark mode

- [ ] Task 19: Add unit tests for DarkModeToggle component (AC: 1, 5)
  - [ ] Create `tests/unit/components/common/DarkModeToggle.test.tsx`
  - [ ] Test component renders correctly
  - [ ] Test toggle functionality
  - [ ] Test SettingsContext integration
  - [ ] Test keyboard accessibility
  - [ ] Test ARIA labels
  - [ ] Mock SettingsContext

- [ ] Task 20: Add unit tests for SettingsContext dark mode methods (AC: 4)
  - [ ] Update `tests/unit/contexts/SettingsContext.test.tsx`
  - [ ] Test `toggleDarkMode()` method
  - [ ] Test `isDarkMode()` method
  - [ ] Test darkMode preference persistence
  - [ ] Test darkMode loads from Settings on mount
  - [ ] Mock SettingsRepository

- [ ] Task 21: Add integration tests for dark mode (AC: All)
  - [ ] Create `tests/integration/DarkMode.test.tsx`
  - [ ] Test dark mode toggle workflow
  - [ ] Test dark mode applies to all components
  - [ ] Test dark mode persists across reloads
  - [ ] Test dark mode doesn't break functionality
  - [ ] Use React Testing Library with full context providers

- [ ] Task 22: Add E2E tests for dark mode (AC: All)
  - [ ] Create `tests/e2e/dark-mode.spec.ts`
  - [ ] Test dark mode toggle from header
  - [ ] Test dark mode toggle from settings
  - [ ] Test dark mode applies to all pages
  - [ ] Test dark mode persists across page reloads
  - [ ] Test all features work in dark mode
  - [ ] Use Playwright for E2E testing

## Dev Notes

### Previous Story Insights

From Story 4.1 (Task Detail Side Panel):
- Component organization: `src/components/common/` for common components
- Settings view exists in App.tsx (needs expansion)
- ViewContext manages view state including 'settings' view

From Story 4.2 (Search and Filter Functionality):
- Performance considerations: useMemo, debouncing, optimization
- Testing patterns: React Testing Library with context providers

From Story 4.3 (Data Export):
- Settings view components: ExportOptions.tsx
- Settings view integration patterns

From Story 4.4 (Backup and Restore):
- Settings view components: BackupRestoreOptions.tsx
- Settings view integration patterns

**Key Integration Points:**
- Story 4.5 uses existing SettingsContext (darkMode field already exists)
- Story 4.5 extends SettingsContext with toggleDarkMode method
- Story 4.5 adds DarkModeToggle to Navigation (header) and Settings view
- Story 4.5 applies dark mode classes throughout all components
- Story 4.5 uses Tailwind CSS dark mode (class-based)

### Data Models

**Settings Model** [Source: architecture/common/data-models.md#settings]:
```typescript
interface Settings {
  id: 'default';
  darkMode: boolean; // Already exists in Settings interface
  defaultBillableStatus: boolean;
  defaultHourlyRate: number | null;
  keyboardShortcuts: Record<string, string>;
  onboardingCompleted: boolean;
  updatedAt: Date;
}
```

**Note:** The `darkMode` field already exists in the Settings interface, so no data model changes are needed.

### Component Specifications

**DarkModeToggle Component:**
- Location: `src/components/common/DarkModeToggle.tsx`
- Should follow component template pattern from frontend architecture
- Use SettingsContext for dark mode state
- Toggle between light and dark modes
- Show appropriate icon (sun/moon)
- Accessible with keyboard navigation

**Tailwind Dark Mode Configuration:**
- Update `tailwind.config.js`
- Enable class-based dark mode: `darkMode: 'class'`
- Add dark mode color palette
- Ensure WCAG AA contrast compliance

**Dark Mode Color Palette** (suggested):
- Background (page): `gray-900` (#111827)
- Surface (cards/panels): `gray-800` (#1F2937)
- Surface (elevated): `gray-700` (#374151)
- Text (primary): `gray-100` (#F3F4F6)
- Text (secondary): `gray-300` (#D1D5DB)
- Border: `gray-700` (#374151)
- Accent (blue): `blue-400` (#60A5FA) for dark mode
- Ensure contrast ratios meet WCAG AA

### File Locations

Based on project structure [Source: architecture/unified-project-structure.md]:
- Component: `src/components/common/DarkModeToggle.tsx` (new)
- Context: `src/contexts/SettingsContext.tsx` (update existing)
- Config: `tailwind.config.js` (update existing)
- Styles: `src/styles/globals.css` (update existing)
- App: `src/App.tsx` (update existing)
- Main: `src/main.tsx` (update existing, if needed)
- Components to update: All component files (add dark mode classes)
- Unit tests: `tests/unit/components/common/DarkModeToggle.test.tsx` (new)
- Unit tests: `tests/unit/contexts/SettingsContext.test.tsx` (update existing)
- Integration tests: `tests/integration/DarkMode.test.tsx` (new)
- E2E tests: `tests/e2e/dark-mode.spec.ts` (new)

### API Specifications

**N/A - No Backend API** [Source: architecture/common/frontend-architecture.md#api-client-setup]

All dark mode operations happen client-side:
- SettingsContext manages dark mode state
- SettingsRepository persists dark mode preference to IndexedDB
- Tailwind CSS applies dark mode classes based on 'dark' class on root element
- No server-side processing needed

**SettingsContext Methods:**
- `updateSettings({ darkMode: boolean })` - Update dark mode preference (already exists)
- `toggleDarkMode()` - Toggle dark mode (to be added)
- `isDarkMode()` - Get current dark mode state (to be added)
- `settings.darkMode` - Current dark mode value (already exists)

**DOM Manipulation:**
- Apply/remove 'dark' class on `<html>` or root element
- Use `document.documentElement.classList.add('dark')` or `classList.remove('dark')`
- Watch SettingsContext for changes

### Technical Constraints

**Tailwind CSS Dark Mode** [Source: architecture/common/tech-stack.md]:
- Use Tailwind CSS ^3.4.0 built-in dark mode support
- Use class-based dark mode (`darkMode: 'class'`)
- Apply 'dark' class to root element when dark mode is enabled
- Use `dark:` prefix for dark mode styles

**Color Contrast Requirements** [Source: architecture/common/accessibility-implementation.md]:
- WCAG 2.1 AA compliance required
- Normal text: 4.5:1 contrast ratio minimum
- Large text: 3:1 contrast ratio minimum
- UI components: 3:1 contrast ratio minimum
- Test all color combinations

**Performance Requirements:**
- Smooth transitions (use CSS transitions, not JavaScript)
- Prevent flash of unstyled content (FOUC)
- Apply dark class before initial render
- Use CSS transitions for color changes (200ms duration)

**State Management:**
- Use existing SettingsContext (don't create new context)
- Persist dark mode preference via SettingsRepository
- Load dark mode preference on app mount
- Apply dark class synchronously before React renders

**Component Updates:**
- Add dark mode classes to all components
- Use Tailwind `dark:` prefix for dark mode styles
- Ensure all UI elements are visible in dark mode
- Test all components in both light and dark modes

### Testing Requirements

**Unit Testing** [Source: architecture/common/testing-strategy.md#test-organization]:
- Test file locations: `tests/unit/components/common/`, `tests/unit/contexts/`
- Use Jest + React Testing Library
- Mock SettingsContext
- Test DarkModeToggle component
- Test SettingsContext dark mode methods
- Test dark mode class application
- Aim for 80%+ code coverage

**Integration Testing** [Source: architecture/common/testing-strategy.md#test-organization]:
- Test file location: `tests/integration/DarkMode.test.tsx`
- Test complete dark mode workflow
- Test dark mode applies to all components
- Test dark mode persists across reloads
- Use React Testing Library with full context providers

**E2E Testing** [Source: architecture/common/testing-strategy.md#test-organization]:
- Test file location: `tests/e2e/dark-mode.spec.ts`
- Use Playwright for browser testing
- Test dark mode toggle from header
- Test dark mode toggle from settings
- Test dark mode applies to all pages
- Test dark mode persists across page reloads
- Test all features work in dark mode

**Accessibility Testing** [Source: architecture/common/accessibility-implementation.md#accessibility-testing]:
- Use jest-axe for automated accessibility testing
- Test keyboard navigation
- Test color contrast (WCAG AA compliance)
- Test with screen readers
- Verify ARIA labels are correct
- Test dark mode doesn't break accessibility

**Visual Testing:**
- Test all components in both light and dark modes
- Verify all UI elements are visible
- Verify text is readable
- Verify borders/icons are visible
- Test color contrast ratios

### Project Structure Notes

**Component Organization** [Source: architecture/common/frontend-architecture.md#component-organization]:
- Common components go in `src/components/common/` directory
- Follow existing component patterns
- Use TypeScript interfaces for props
- One component per file

**Styling** [Source: architecture/common/tech-stack.md]:
- Use Tailwind CSS ^3.4.0 for styling
- Use `dark:` prefix for dark mode styles
- Use utility classes for responsive design
- Follow existing design patterns

**No Specific Guidance Found:**
- Dark mode color palette (suggested colors provided, but not specified in architecture)
- Dark mode transition duration (200ms suggested, but not specified)
- System preference detection implementation (future enhancement, not in MVP)

## Testing

### Testing Standards

**Test File Location** [Source: architecture/common/testing-strategy.md#test-organization]:
- Unit tests: `tests/unit/components/common/`, `tests/unit/contexts/`
- Integration tests: `tests/integration/`
- E2E tests: `tests/e2e/`

**Testing Frameworks** [Source: architecture/common/tech-stack.md]:
- Jest ^29.7.0 for unit and integration testing
- React Testing Library ^14.0.0 for component testing
- Playwright ^1.40.0 for E2E testing

**Testing Patterns** [Source: architecture/common/testing-strategy.md#test-examples]:
- Use React Testing Library queries (getByRole, getByLabelText, etc.)
- Mock SettingsContext
- Test user interactions, not implementation details
- Use proper async handling with waitFor
- Test color contrast ratios

**Accessibility Testing** [Source: architecture/common/accessibility-implementation.md#accessibility-testing]:
- Install and use jest-axe: `npm install --save-dev jest-axe`
- Add accessibility tests to component test suites
- Test keyboard navigation manually
- Test color contrast (WCAG AA compliance)
- Test with screen readers

**Specific Testing Requirements for This Story:**
- Test dark mode toggle functionality
- Test dark mode applies to all components
- Test dark mode persists across reloads
- Test color contrast compliance (WCAG AA)
- Test all features work in dark mode
- Test smooth transitions
- Test no flash of unstyled content

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-26 | 1.0 | Initial story draft | Scrum Master |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results

_Results from QA Agent review will be populated here after implementation_
