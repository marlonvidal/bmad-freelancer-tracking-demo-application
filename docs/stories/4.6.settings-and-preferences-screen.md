# Story 4.6: Settings and Preferences Screen

## Status
Draft

## Story
**As a** user,
**I want** a settings screen to configure application preferences,
**so that** I can customize my experience.

## Acceptance Criteria

1. Settings screen is accessible from main navigation/menu
2. Settings screen includes: dark mode toggle, default billable status, default hourly rate, keyboard shortcuts reference, export options, backup/restore
3. Settings are organized into logical sections/categories
4. Settings changes save immediately (auto-save)
5. Settings persist across browser sessions
6. Settings screen is accessible and keyboard navigable
7. Settings include reset to defaults option
8. Settings screen provides clear descriptions for each option
9. Settings validation prevents invalid configurations
10. Settings screen is responsive and works on different window sizes

## Tasks / Subtasks

- [ ] Task 1: Create SettingsPanel component structure (AC: 2, 3, 6, 10)
  - [ ] Create `src/components/settings/SettingsPanel.tsx`
  - [ ] Implement main settings panel container
  - [ ] Organize settings into logical sections:
    - [ ] Appearance section (dark mode)
    - [ ] Task defaults section (billable status, hourly rate)
    - [ ] Keyboard shortcuts section (reference)
    - [ ] Data management section (export, backup/restore)
  - [ ] Use Tailwind CSS for responsive layout
  - [ ] Ensure keyboard navigation (Tab, Arrow keys)
  - [ ] Add ARIA labels and semantic HTML
  - [ ] Ensure responsive design (mobile, tablet, desktop)

- [ ] Task 2: Create SettingsSection component (AC: 3, 8)
  - [ ] Create `src/components/settings/SettingsSection.tsx`
  - [ ] Implement reusable section component with title and description
  - [ ] Accept children for section content
  - [ ] Style consistently with settings design
  - [ ] Add collapsible/expandable option (optional enhancement)
  - [ ] Ensure accessibility (ARIA labels, keyboard navigation)

- [ ] Task 3: Create AppearanceSettings section (AC: 2)
  - [ ] Create `src/components/settings/AppearanceSettings.tsx`
  - [ ] Import DarkModeToggle component (from Story 4.5)
  - [ ] Display dark mode toggle with description
  - [ ] Show current dark mode state
  - [ ] Add description: "Reduce eye strain with dark mode"
  - [ ] Use SettingsSection wrapper
  - [ ] Ensure accessibility

- [ ] Task 4: Create TaskDefaultsSettings section (AC: 2, 4, 9)
  - [ ] Create `src/components/settings/TaskDefaultsSettings.tsx`
  - [ ] Add default billable status toggle
    - [ ] Label: "Default Billable Status"
    - [ ] Description: "Set default billable status for new tasks"
    - [ ] Toggle switch: Billable / Non-billable
    - [ ] Use SettingsContext to get/set defaultBillableStatus
    - [ ] Auto-save on change (debounced 500ms)
  - [ ] Add default hourly rate input
    - [ ] Label: "Default Hourly Rate"
    - [ ] Description: "Global default hourly rate for new tasks (can be overridden at client/project/task level)"
    - [ ] Number input with currency formatting
    - [ ] Validation: positive number, max 999999.99
    - [ ] Allow clearing (set to null)
    - [ ] Use SettingsContext to get/set defaultHourlyRate
    - [ ] Auto-save on change (debounced 500ms)
  - [ ] Show current values
  - [ ] Use SettingsSection wrapper
  - [ ] Ensure accessibility and validation

- [ ] Task 5: Create KeyboardShortcutsSection component (AC: 2, 8)
  - [ ] Create `src/components/settings/KeyboardShortcutsSection.tsx`
  - [ ] Display keyboard shortcuts reference table
  - [ ] Include shortcuts:
    - [ ] Ctrl/Cmd + F: Focus search
    - [ ] ESC: Close modals/panels
    - [ ] Tab: Navigate between elements
    - [ ] Enter/Space: Activate buttons
    - [ ] (Add other shortcuts as they're implemented)
  - [ ] Format as table: Shortcut | Action | Description
  - [ ] Show platform-specific shortcuts (Ctrl for Windows/Linux, Cmd for Mac)
  - [ ] Add description: "Keyboard shortcuts for faster navigation"
  - [ ] Use SettingsSection wrapper
  - [ ] Ensure accessibility (keyboard navigable table)

- [ ] Task 6: Create DataManagementSettings section (AC: 2)
  - [ ] Create `src/components/settings/DataManagementSettings.tsx`
  - [ ] Import ExportOptions component (from Story 4.3)
  - [ ] Import BackupRestoreOptions component (from Story 4.4)
  - [ ] Display export options section
  - [ ] Display backup/restore options section
  - [ ] Add description: "Export your data or backup/restore your application"
  - [ ] Use SettingsSection wrapper
  - [ ] Ensure accessibility

- [ ] Task 7: Integrate all settings sections into SettingsPanel (AC: 2, 3)
  - [ ] Update SettingsPanel component
  - [ ] Import all settings section components
  - [ ] Arrange sections in logical order:
    - [ ] Appearance (dark mode)
    - [ ] Task Defaults (billable status, hourly rate)
    - [ ] Keyboard Shortcuts (reference)
    - [ ] Data Management (export, backup/restore)
  - [ ] Add section dividers/spacing
  - [ ] Ensure consistent styling
  - [ ] Test all sections render correctly

- [ ] Task 8: Add Settings link to Navigation (AC: 1)
  - [ ] Update `src/components/common/Navigation.tsx`
  - [ ] Add "Settings" button/link to navigation
  - [ ] Use ViewContext to navigate to settings view
  - [ ] Show active state when on settings page
  - [ ] Ensure keyboard accessibility
  - [ ] Add ARIA labels
  - [ ] Style consistently with other navigation items

- [ ] Task 9: Integrate SettingsPanel into App.tsx (AC: 1, 10)
  - [ ] Update `src/App.tsx`
  - [ ] Replace placeholder settings view with SettingsPanel component
  - [ ] Import SettingsPanel
  - [ ] Render SettingsPanel when currentView === 'settings'
  - [ ] Ensure settings view has proper layout and spacing
  - [ ] Ensure responsive design

- [ ] Task 10: Implement auto-save functionality (AC: 4)
  - [ ] Update SettingsContext (if needed) or use existing updateSettings
  - [ ] Ensure all settings changes call updateSettings immediately
  - [ ] Use debouncing for input fields (500ms delay)
  - [ ] Show save indicator (saving/saved state) for user feedback
  - [ ] Handle save errors gracefully
  - [ ] Ensure settings persist to IndexedDB via SettingsRepository

- [ ] Task 11: Implement reset to defaults functionality (AC: 7)
  - [ ] Create `src/utils/settingsDefaults.ts` utility file
  - [ ] Define default settings values:
    - [ ] darkMode: false
    - [ ] defaultBillableStatus: false
    - [ ] defaultHourlyRate: null
    - [ ] keyboardShortcuts: {} (empty object, shortcuts are read-only reference)
    - [ ] onboardingCompleted: false (don't reset this)
  - [ ] Add "Reset to Defaults" button to SettingsPanel
  - [ ] Show confirmation dialog before reset
  - [ ] Reset all settings to defaults (except onboardingCompleted)
  - [ ] Use SettingsContext.updateSettings to apply defaults
  - [ ] Show success message after reset

- [ ] Task 12: Add settings validation (AC: 9)
  - [ ] Update TaskDefaultsSettings component
  - [ ] Validate default hourly rate:
    - [ ] Must be positive number
    - [ ] Must be <= 999999.99
    - [ ] Must have max 2 decimal places
    - [ ] Show inline error messages
    - [ ] Prevent saving invalid values
  - [ ] Validate default billable status (boolean, always valid)
  - [ ] Show validation errors clearly
  - [ ] Disable save button if validation fails

- [ ] Task 13: Add descriptions and help text (AC: 8)
  - [ ] Update all settings sections
  - [ ] Add clear descriptions for each setting:
    - [ ] Dark mode: "Reduce eye strain with dark mode. Toggle to switch between light and dark themes."
    - [ ] Default billable status: "Set the default billable status for new tasks. You can override this for individual tasks."
    - [ ] Default hourly rate: "Set a global default hourly rate. This can be overridden at the client, project, or task level."
    - [ ] Keyboard shortcuts: "Keyboard shortcuts help you navigate faster. Use these shortcuts throughout the application."
    - [ ] Export: "Export your time tracking data in CSV or JSON format for use in other tools."
    - [ ] Backup/Restore: "Create a backup of all your data or restore from a previous backup."
  - [ ] Add help icons/tooltips (optional enhancement)
  - [ ] Ensure descriptions are accessible (screen reader friendly)

- [ ] Task 14: Ensure keyboard navigation (AC: 6)
  - [ ] Review SettingsPanel component
  - [ ] Ensure all interactive elements are keyboard accessible
  - [ ] Test Tab navigation (logical order)
  - [ ] Test Enter/Space to activate buttons/toggles
  - [ ] Test Arrow keys for dropdowns/selects (if any)
  - [ ] Test ESC to close modals/dialogs
  - [ ] Ensure focus indicators are visible
  - [ ] Test with keyboard-only navigation

- [ ] Task 15: Ensure responsive design (AC: 10)
  - [ ] Review SettingsPanel layout
  - [ ] Test on mobile (< 768px): single column, stacked sections
  - [ ] Test on tablet (768px - 1024px): single column, comfortable spacing
  - [ ] Test on desktop (> 1024px): two-column layout or single column with max-width
  - [ ] Ensure all settings are accessible on small screens
  - [ ] Ensure tables (keyboard shortcuts) are scrollable on mobile
  - [ ] Use Tailwind responsive classes: `md:`, `lg:`

- [ ] Task 16: Add loading and error states (AC: All)
  - [ ] Update SettingsPanel component
  - [ ] Show loading state while settings load from IndexedDB
  - [ ] Show error state if settings fail to load
  - [ ] Show save indicator during auto-save
  - [ ] Show error message if save fails
  - [ ] Handle SettingsContext loading and error states
  - [ ] Provide retry option for errors

- [ ] Task 17: Add unit tests for SettingsPanel component (AC: All)
  - [ ] Create `tests/unit/components/settings/SettingsPanel.test.tsx`
  - [ ] Test component renders correctly
  - [ ] Test all sections render
  - [ ] Test settings changes trigger auto-save
  - [ ] Test reset to defaults functionality
  - [ ] Test validation
  - [ ] Test keyboard navigation
  - [ ] Mock SettingsContext

- [ ] Task 18: Add unit tests for settings section components (AC: 2, 4, 9)
  - [ ] Create `tests/unit/components/settings/AppearanceSettings.test.tsx`
  - [ ] Create `tests/unit/components/settings/TaskDefaultsSettings.test.tsx`
  - [ ] Create `tests/unit/components/settings/KeyboardShortcutsSection.test.tsx`
  - [ ] Create `tests/unit/components/settings/DataManagementSettings.test.tsx`
  - [ ] Test each section renders correctly
  - [ ] Test settings updates
  - [ ] Test validation (for TaskDefaultsSettings)
  - [ ] Mock SettingsContext and related components

- [ ] Task 19: Add integration tests for settings workflow (AC: All)
  - [ ] Create `tests/integration/SettingsWorkflow.test.tsx`
  - [ ] Test complete settings workflow:
    - [ ] Navigate to settings
    - [ ] Change dark mode
    - [ ] Change default billable status
    - [ ] Change default hourly rate
    - [ ] Reset to defaults
    - [ ] Verify settings persist
  - [ ] Test validation workflow
  - [ ] Test auto-save workflow
  - [ ] Use React Testing Library with full context providers

- [ ] Task 20: Add E2E tests for settings screen (AC: All)
  - [ ] Create `tests/e2e/settings.spec.ts`
  - [ ] Test navigating to settings from navigation
  - [ ] Test changing all settings
  - [ ] Test settings persist across page reloads
  - [ ] Test reset to defaults
  - [ ] Test validation (invalid hourly rate)
  - [ ] Test keyboard navigation
  - [ ] Test responsive design
  - [ ] Use Playwright for E2E testing

## Dev Notes

### Previous Story Insights

From Story 4.3 (Data Export):
- ExportOptions component will be created (export functionality)
- Settings view integration patterns

From Story 4.4 (Backup and Restore):
- BackupRestoreOptions component will be created (backup/restore functionality)
- Settings view integration patterns

From Story 4.5 (Dark Mode):
- DarkModeToggle component will be created
- SettingsContext already has darkMode field and updateSettings method
- Dark mode integration patterns

**Key Integration Points:**
- Story 4.6 consolidates settings from Stories 4.3, 4.4, 4.5 into unified SettingsPanel
- Story 4.6 uses existing SettingsContext (no changes needed)
- Story 4.6 integrates with Navigation component (adds settings link)
- Story 4.6 replaces placeholder settings view in App.tsx
- Story 4.6 organizes all settings into logical sections

### Data Models

**Settings Model** [Source: architecture/common/data-models.md#settings]:
```typescript
interface Settings {
  id: 'default';
  darkMode: boolean;
  defaultBillableStatus: boolean; // Default billable status for new tasks
  defaultHourlyRate: number | null;
  keyboardShortcuts: Record<string, string>; // Read-only reference (not editable in MVP)
  onboardingCompleted: boolean;
  updatedAt: Date;
}
```

**Note:** All Settings fields already exist. No data model changes needed. Keyboard shortcuts are read-only reference in MVP (future enhancement: allow customization).

### Component Specifications

**SettingsPanel Component:**
- Location: `src/components/settings/SettingsPanel.tsx`
- Should follow component template pattern from frontend architecture
- Use SettingsContext for settings state
- Organize settings into logical sections
- Responsive layout (mobile, tablet, desktop)

**SettingsSection Component:**
- Location: `src/components/settings/SettingsSection.tsx`
- Reusable wrapper component for settings sections
- Accepts title, description, and children
- Consistent styling across all sections

**AppearanceSettings Component:**
- Location: `src/components/settings/AppearanceSettings.tsx`
- Uses DarkModeToggle component (from Story 4.5)
- Displays dark mode setting with description

**TaskDefaultsSettings Component:**
- Location: `src/components/settings/TaskDefaultsSettings.tsx`
- Default billable status toggle
- Default hourly rate input with validation
- Auto-save on change

**KeyboardShortcutsSection Component:**
- Location: `src/components/settings/KeyboardShortcutsSection.tsx`
- Displays keyboard shortcuts reference table
- Read-only (no editing in MVP)

**DataManagementSettings Component:**
- Location: `src/components/settings/DataManagementSettings.tsx`
- Uses ExportOptions component (from Story 4.3)
- Uses BackupRestoreOptions component (from Story 4.4)

### File Locations

Based on project structure [Source: architecture/unified-project-structure.md]:
- Component: `src/components/settings/SettingsPanel.tsx` (new)
- Component: `src/components/settings/SettingsSection.tsx` (new)
- Component: `src/components/settings/AppearanceSettings.tsx` (new)
- Component: `src/components/settings/TaskDefaultsSettings.tsx` (new)
- Component: `src/components/settings/KeyboardShortcutsSection.tsx` (new)
- Component: `src/components/settings/DataManagementSettings.tsx` (new)
- Component: `src/components/common/Navigation.tsx` (update existing)
- App: `src/App.tsx` (update existing)
- Utils: `src/utils/settingsDefaults.ts` (new)
- Unit tests: `tests/unit/components/settings/SettingsPanel.test.tsx` (new)
- Unit tests: `tests/unit/components/settings/AppearanceSettings.test.tsx` (new)
- Unit tests: `tests/unit/components/settings/TaskDefaultsSettings.test.tsx` (new)
- Unit tests: `tests/unit/components/settings/KeyboardShortcutsSection.test.tsx` (new)
- Unit tests: `tests/unit/components/settings/DataManagementSettings.test.tsx` (new)
- Integration tests: `tests/integration/SettingsWorkflow.test.tsx` (new)
- E2E tests: `tests/e2e/settings.spec.ts` (new)

### API Specifications

**N/A - No Backend API** [Source: architecture/common/frontend-architecture.md#api-client-setup]

All settings operations happen client-side:
- SettingsContext manages settings state
- SettingsRepository persists settings to IndexedDB
- Auto-save on change (debounced for inputs)
- No server-side processing needed

**SettingsContext Methods Used:**
- `settings` - Current settings state
- `updateSettings(updates)` - Update settings (already exists)
- `getDefaultBillableStatus()` - Get default billable status (already exists)
- `getDefaultHourlyRate()` - Get default hourly rate (already exists)
- `loading` - Loading state
- `error` - Error state

**SettingsRepository Methods Used:**
- `getSettings()` - Get settings from IndexedDB
- `updateSettings(updates)` - Update settings in IndexedDB

### Technical Constraints

**Auto-Save Requirements:**
- Settings changes save immediately (no save button needed)
- Use debouncing for input fields (500ms delay) to prevent excessive IndexedDB writes
- Show save indicator (saving/saved state) for user feedback
- Handle save errors gracefully

**Validation Requirements:**
- Default hourly rate: positive number, max 999999.99, max 2 decimal places
- Default billable status: boolean (always valid)
- Show inline error messages
- Prevent saving invalid values

**Responsive Design Requirements:**
- Mobile (< 768px): single column, stacked sections
- Tablet (768px - 1024px): single column, comfortable spacing
- Desktop (> 1024px): two-column layout or single column with max-width
- Ensure all settings accessible on all screen sizes

**Accessibility Requirements** [Source: architecture/common/accessibility-implementation.md]:
- WCAG 2.1 AA compliance required
- All interactive elements must have ARIA labels
- Keyboard navigation support (Tab, Enter/Space, Arrow keys, ESC)
- Screen reader compatibility
- Focus indicators visible
- Logical tab order

**State Management:**
- Use existing SettingsContext (don't create new context)
- Settings persist via SettingsRepository to IndexedDB
- Auto-save on change (optimistic updates)
- Handle loading and error states

### Testing Requirements

**Unit Testing** [Source: architecture/common/testing-strategy.md#test-organization]:
- Test file locations: `tests/unit/components/settings/`
- Use Jest + React Testing Library
- Mock SettingsContext
- Test component rendering
- Test settings updates
- Test validation
- Test keyboard navigation
- Aim for 80%+ code coverage

**Integration Testing** [Source: architecture/common/testing-strategy.md#test-organization]:
- Test file location: `tests/integration/SettingsWorkflow.test.tsx`
- Test complete workflows with real context providers
- Test settings persistence
- Test auto-save workflow
- Use React Testing Library with full context providers

**E2E Testing** [Source: architecture/common/testing-strategy.md#test-organization]:
- Test file location: `tests/e2e/settings.spec.ts`
- Use Playwright for browser testing
- Test complete user workflows
- Test settings persistence across reloads
- Test responsive design
- Test keyboard navigation

**Accessibility Testing** [Source: architecture/common/accessibility-implementation.md#accessibility-testing]:
- Use jest-axe for automated accessibility testing
- Test keyboard navigation manually
- Test with screen readers
- Verify ARIA labels are correct
- Test focus management

### Project Structure Notes

**Component Organization** [Source: architecture/common/frontend-architecture.md#component-organization]:
- Settings-related components go in `src/components/settings/` directory
- Follow existing component patterns
- Use TypeScript interfaces for props
- One component per file

**Styling** [Source: architecture/common/tech-stack.md]:
- Use Tailwind CSS ^3.4.0 for styling
- Use utility classes for responsive design
- Follow existing design patterns
- Use dark mode classes (from Story 4.5)

**No Specific Guidance Found:**
- Settings layout preference (single column vs two-column on desktop)
- Keyboard shortcuts table format (table vs list vs cards)
- Reset confirmation dialog format (simple confirm vs type-to-confirm)

## Testing

### Testing Standards

**Test File Location** [Source: architecture/common/testing-strategy.md#test-organization]:
- Unit tests: `tests/unit/components/settings/`
- Integration tests: `tests/integration/`
- E2E tests: `tests/e2e/`

**Testing Frameworks** [Source: architecture/common/tech-stack.md]:
- Jest ^29.7.0 for unit and integration testing
- React Testing Library ^14.0.0 for component testing
- Playwright ^1.40.0 for E2E testing

**Testing Patterns** [Source: architecture/common/testing-strategy.md#test-examples]:
- Use React Testing Library queries (getByRole, getByLabelText, etc.)
- Mock SettingsContext
- Test user interactions, not implementation details
- Use proper async handling with waitFor
- Test keyboard navigation

**Accessibility Testing** [Source: architecture/common/accessibility-implementation.md#accessibility-testing]:
- Install and use jest-axe: `npm install --save-dev jest-axe`
- Add accessibility tests to component test suites
- Test keyboard navigation manually
- Test with screen readers

**Specific Testing Requirements for This Story:**
- Test settings screen renders correctly
- Test all settings sections render
- Test settings changes trigger auto-save
- Test settings persist across reloads
- Test reset to defaults functionality
- Test validation (invalid hourly rate)
- Test keyboard navigation
- Test responsive design
- Test integration with ExportOptions and BackupRestoreOptions components

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-26 | 1.0 | Initial story draft | Scrum Master |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results

_Results from QA Agent review will be populated here after implementation_
